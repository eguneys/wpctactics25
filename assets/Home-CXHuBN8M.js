var ci=Object.defineProperty;var hi=(t,e,n)=>e in t?ci(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var _=(t,e,n)=>(hi(t,typeof e!="symbol"?e+"":e,n),n);import{u as qe,c as B,o as bn,a as Y,b as Ot,t as F,d as _n,i as G,e as O,S as Te,m as lt,f as di,M as Zt,F as Yt,g as He,h as ve,j as he,k as de,l as ui,n as fi,p as pi,q as Re,r as mi}from"./index-BDFDuUof.js";const gi=["white","black"],Nt=["a","b","c","d","e","f","g","h"],zt=["1","2","3","4","5","6","7","8"],wi=[...zt].reverse(),Tt=Array.prototype.concat(...Nt.map(t=>zt.map(e=>t+e))),L=t=>Tt[8*t[0]+t[1]],P=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],kn=Tt.map(P);function bi(t){let e;const n=()=>(e===void 0&&(e=t()),e);return n.clear=()=>{e=void 0},n}const _i=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Dt=t=>t==="white"?"black":"white",De=(t,e)=>{const n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i},mt=(t,e)=>t.role===e.role&&t.color===e.color,Le=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],Q=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},vn=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},jt=(t,e)=>{t.style.visibility=e?"visible":"hidden"},be=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},yn=t=>{var e;return(((e=t.buttons)!==null&&e!==void 0?e:0)&2)===2},X=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function Cn(t,e,n){const i=P(t);return e||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const me=(t,e)=>Math.abs(t-e),ki=t=>(e,n,i,r)=>me(e,i)<2&&(t==="white"?r===n+1||n<=1&&r===n+2&&e===i:r===n-1||n>=6&&r===n-2&&e===i),Pn=(t,e,n,i)=>{const r=me(t,n),s=me(e,i);return r===1&&s===2||r===2&&s===1},En=(t,e,n,i)=>me(t,n)===me(e,i),xn=(t,e,n,i)=>t===n||e===i,Sn=(t,e,n,i)=>En(t,e,n,i)||xn(t,e,n,i),vi=(t,e,n)=>(i,r,s,o)=>me(i,s)<2&&me(r,o)<2||n&&r===o&&r===(t==="white"?0:7)&&(i===4&&(s===2&&e.includes(0)||s===6&&e.includes(7))||e.includes(s));function yi(t,e){const n=e==="white"?"1":"8",i=[];for(const[r,s]of t)r[1]===n&&s.color===e&&s.role==="rook"&&i.push(P(r)[0]);return i}function Mn(t,e,n){const i=t.get(e);if(!i)return[];const r=P(e),s=i.role,o=s==="pawn"?ki(i.color):s==="knight"?Pn:s==="bishop"?En:s==="rook"?xn:s==="queen"?Sn:vi(i.color,yi(t,i.color),n);return kn.filter(a=>(r[0]!==a[0]||r[1]!==a[1])&&o(r[0],r[1],a[0],a[1])).map(L)}function K(t,...e){t&&setTimeout(()=>t(...e),1)}function Ci(t){t.orientation=Dt(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function Pi(t,e){for(const[n,i]of e)i?t.pieces.set(n,i):t.pieces.delete(n)}function Ei(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[n,i]of t.pieces)i.role==="king"&&i.color===e&&(t.check=n)}function xi(t,e,n,i){se(t),t.premovable.current=[e,n],K(t.premovable.events.set,e,n,i)}function re(t){t.premovable.current&&(t.premovable.current=void 0,K(t.premovable.events.unset))}function Si(t,e,n){re(t),t.predroppable.current={role:e,key:n},K(t.predroppable.events.set,e,n)}function se(t){const e=t.predroppable;e.current&&(e.current=void 0,K(e.events.unset))}function Mi(t,e,n){if(!t.autoCastle)return!1;const i=t.pieces.get(e);if(!i||i.role!=="king")return!1;const r=P(e),s=P(n);if(r[1]!==0&&r[1]!==7||r[1]!==s[1])return!1;r[0]===4&&!t.pieces.has(n)&&(s[0]===6?n=L([7,s[1]]):s[0]===2&&(n=L([0,s[1]])));const o=t.pieces.get(n);return!o||o.color!==i.color||o.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(n),r[0]<s[0]?(t.pieces.set(L([6,s[1]]),i),t.pieces.set(L([5,s[1]]),o)):(t.pieces.set(L([2,s[1]]),i),t.pieces.set(L([3,s[1]]),o)),!0)}function An(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!i)return!1;const s=r&&r.color!==i.color?r:void 0;return n===t.selected&&I(t),K(t.events.move,e,n,s),Mi(t,e,n)||(t.pieces.set(n,i),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,K(t.events.change),s||!0}function Bt(t,e,n,i){if(t.pieces.has(n))if(i)t.pieces.delete(n);else return!1;return K(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,K(t.events.change),t.movable.dests=void 0,t.turnColor=Dt(t.turnColor),!0}function Rn(t,e,n){const i=An(t,e,n);return i&&(t.movable.dests=void 0,t.turnColor=Dt(t.turnColor),t.animation.current=void 0),i}function $n(t,e,n){if(Kt(t,e,n)){const i=Rn(t,e,n);if(i){const r=t.hold.stop();I(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return i!==!0&&(s.captured=i),K(t.movable.events.after,e,n,s),!0}}else if(Ri(t,e,n))return xi(t,e,n,{ctrlKey:t.stats.ctrlKey}),I(t),!0;return I(t),!1}function On(t,e,n,i){const r=t.pieces.get(e);r&&(Ai(t,e,n)||i)?(t.pieces.delete(e),Bt(t,r,n,i),K(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&$i(t,e,n)?Si(t,r.role,n):(re(t),se(t)),t.pieces.delete(e),I(t)}function gt(t,e,n){if(K(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){I(t),t.hold.cancel();return}else if((t.selectable.enabled||n)&&t.selected!==e&&$n(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(zn(t,e)||Wt(t,e))&&(Nn(t,e),t.hold.start())}function Nn(t,e){t.selected=e,Wt(t,e)?t.premovable.customDests||(t.premovable.dests=Mn(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function I(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function zn(t,e){const n=t.pieces.get(e);return!!n&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}const Kt=(t,e,n)=>{var i,r;return e!==n&&zn(t,e)&&(t.movable.free||!!(!((r=(i=t.movable.dests)===null||i===void 0?void 0:i.get(e))===null||r===void 0)&&r.includes(n)))};function Ai(t,e,n){const i=t.pieces.get(e);return!!i&&(e===n||!t.pieces.has(n))&&(t.movable.color==="both"||t.movable.color===i.color&&t.turnColor===i.color)}function Wt(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function Ri(t,e,n){var i,r;const s=(r=(i=t.premovable.customDests)===null||i===void 0?void 0:i.get(e))!==null&&r!==void 0?r:Mn(t.pieces,e,t.premovable.castle);return e!==n&&Wt(t,e)&&s.includes(n)}function $i(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);return!!i&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&t.movable.color===i.color&&t.turnColor!==i.color}function Oi(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}function Ni(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],i=e[1];let r=!1;if(Kt(t,n,i)){const s=Rn(t,n,i);if(s){const o={premove:!0};s!==!0&&(o.captured=s),K(t.movable.events.after,n,i,o),r=!0}}return re(t),r}function zi(t,e){const n=t.predroppable.current;let i=!1;if(!n)return!1;if(e(n)){const r={role:n.role,color:t.movable.color};Bt(t,r,n.key)&&(K(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return se(t),i}function Lt(t){re(t),se(t),I(t)}function Xt(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Lt(t)}function _e(t,e,n){let i=Math.floor(8*(t[0]-n.left)/n.width);e||(i=7-i);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),i>=0&&i<8&&r>=0&&r<8?L([i,r]):void 0}function Ti(t,e,n,i){const r=P(t),s=kn.filter(c=>Sn(r[0],r[1],c[0],c[1])||Pn(r[0],r[1],c[0],c[1])),a=s.map(c=>Cn(L(c),n,i)).map(c=>De(e,c)),[,l]=a.reduce((c,f,d)=>c[0]<f?c:[f,d],[a[0],0]);return L(s[l])}const W=t=>t.orientation==="white",Tn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Di={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},ji={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Dn(t){t==="start"&&(t=Tn);const e=new Map;let n=7,i=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--n,n<0)return e;i=0;break;case"~":{const s=e.get(L([i-1,n]));s&&(s.promoted=!0);break}default:{const s=r.charCodeAt(0);if(s<57)i+=s-48;else{const o=r.toLowerCase();e.set(L([i,n]),{role:Di[o],color:r===o?"black":"white"}),++i}}}return e}function Bi(t){return wi.map(e=>Nt.map(n=>{const i=t.get(n+e);if(i){let r=ji[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function jn(t,e){e.animation&&(It(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function Bn(t,e){var n,i,r;if(!((n=e.movable)===null||n===void 0)&&n.dests&&(t.movable.dests=void 0),!((i=e.drawable)===null||i===void 0)&&i.autoShapes&&(t.drawable.autoShapes=[]),It(t,e),e.fen&&(t.pieces=Dn(e.fen),t.drawable.shapes=((r=e.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in e&&Ei(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Nn(t,t.selected),jn(t,e),!t.movable.rookCastle&&t.movable.dests){const s=t.movable.color==="white"?"1":"8",o="e"+s,a=t.movable.dests.get(o),l=t.pieces.get(o);if(!a||!l||l.role!=="king")return;t.movable.dests.set(o,a.filter(c=>!(c==="a"+s&&a.includes("c"+s))&&!(c==="h"+s&&a.includes("g"+s))))}}function It(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)&&Jt(t[n])&&Jt(e[n])?It(t[n],e[n]):t[n]=e[n])}function Jt(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const ae=(t,e)=>e.animation.enabled?Li(t,e):ee(t,e);function ee(t,e){const n=t(e);return e.dom.redraw(),n}const ct=(t,e)=>({key:t,pos:P(t),piece:e}),Ki=(t,e)=>e.sort((n,i)=>De(t.pos,n.pos)-De(t.pos,i.pos))[0];function Wi(t,e){const n=new Map,i=[],r=new Map,s=[],o=[],a=new Map;let l,c,f;for(const[d,u]of t)a.set(d,ct(d,u));for(const d of Tt)l=e.pieces.get(d),c=a.get(d),l?c?mt(l,c.piece)||(s.push(c),o.push(ct(d,l))):o.push(ct(d,l)):c&&s.push(c);for(const d of o)c=Ki(d,s.filter(u=>mt(d.piece,u.piece))),c&&(f=[c.pos[0]-d.pos[0],c.pos[1]-d.pos[1]],n.set(d.key,f.concat(f)),i.push(c.key));for(const d of s)i.includes(d.key)||r.set(d.key,d.piece);return{anims:n,fadings:r}}function Kn(t,e){const n=t.animation.current;if(n===void 0){t.dom.destroyed||t.dom.redrawNow();return}const i=1-(e-n.start)*n.frequency;if(i<=0)t.animation.current=void 0,t.dom.redrawNow();else{const r=Ii(i);for(const s of n.plan.anims.values())s[2]=s[0]*r,s[3]=s[1]*r;t.dom.redrawNow(!0),requestAnimationFrame((s=performance.now())=>Kn(t,s))}}function Li(t,e){const n=new Map(e.pieces),i=t(e),r=Wi(n,e);if(r.anims.size||r.fadings.size){const s=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},s||Kn(e,performance.now())}else e.dom.redraw();return i}const Ii=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,Fi=["green","red","blue","yellow"];function Hi(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?I(t):Lt(t);const n=be(e),i=_e(n,W(t),t.dom.bounds());i&&(t.drawable.current={orig:i,pos:n,brush:Qi(e),snapToValidMove:t.drawable.defaultSnapToValidMove},Wn(t))}function Wn(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const n=_e(e.pos,W(t),t.dom.bounds());n||(e.snapToValidMove=!1);const i=e.snapToValidMove?Ti(e.orig,e.pos,W(t),t.dom.bounds()):n;i!==e.mouseSq&&(e.mouseSq=i,e.dest=i!==e.orig?i:void 0,t.dom.redrawNow()),Wn(t)}})}function qi(t,e){t.drawable.current&&(t.drawable.current.pos=be(e))}function Gi(t){const e=t.drawable.current;e&&(e.mouseSq&&Vi(t.drawable,e),Ln(t))}function Ln(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function Ui(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),In(t.drawable))}function Qi(t){var e;const n=(t.shiftKey||t.ctrlKey)&&yn(t),i=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return Fi[(n?1:0)+(i?2:0)]}function Vi(t,e){const n=r=>r.orig===e.orig&&r.dest===e.dest,i=t.shapes.find(n);i&&(t.shapes=t.shapes.filter(r=>!n(r))),(!i||i.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),In(t)}function In(t){t.onChange&&t.onChange(t.shapes)}function Zi(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),i=be(e),r=_e(i,W(t),n);if(!r)return;const s=t.pieces.get(r),o=t.selected;if(!o&&t.drawable.enabled&&(t.drawable.eraseOnClick||!s||s.color!==t.turnColor)&&Ui(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||s||o||Yi(t,i)))e.preventDefault();else if(e.touches)return;const a=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&Kt(t,t.selected,r)?ae(d=>gt(d,r),t):gt(t,r);const c=t.selected===r,f=Hn(t,r);if(s&&f&&c&&Oi(t,r)){t.draggable.current={orig:r,piece:s,origPos:i,pos:i,started:t.draggable.autoDistance&&t.stats.dragged,element:f,previouslySelected:o,originTarget:e.target,keyHasChanged:!1},f.cgDragging=!0,f.classList.add("dragging");const d=t.dom.elements.ghost;d&&(d.className=`ghost ${s.color} ${s.role}`,Q(d,Le(n)(P(r),W(t))),jt(d,!0)),Ft(t)}else a&&re(t),l&&se(t);t.dom.redraw()}function Yi(t,e){const n=W(t),i=t.dom.bounds(),r=Math.pow(i.width/8,2);for(const s of t.pieces.keys()){const o=Cn(s,n,i);if(De(o,e)<=r)return!0}return!1}function Xi(t,e,n,i){const r="a0";t.pieces.set(r,e),t.dom.redraw();const s=be(n);t.draggable.current={orig:r,piece:e,origPos:s,pos:s,started:!0,element:()=>Hn(t,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},Ft(t)}function Ft(t){requestAnimationFrame(()=>{var e;const n=t.draggable.current;if(!n)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(n.orig)&&(t.animation.current=void 0);const i=t.pieces.get(n.orig);if(!i||!mt(i,n.piece))Ge(t);else if(!n.started&&De(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const s=n.element();if(!s)return;s.cgDragging=!0,s.classList.add("dragging"),n.element=s}const r=t.dom.bounds();Q(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==_e(n.pos,W(t),r))}Ft(t)})}function Ji(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=be(e))}function er(t,e){const n=t.draggable.current;if(!n)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&n.originTarget!==e.target&&!n.newPiece){t.draggable.current=void 0;return}re(t),se(t);const i=be(e)||n.pos,r=_e(i,W(t),t.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?On(t,n.orig,r,n.force):(t.stats.ctrlKey=e.ctrlKey,$n(t,n.orig,r)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!r&&(t.pieces.delete(n.orig),K(t.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?I(t):t.selectable.enabled||I(t),Fn(t),t.draggable.current=void 0,t.dom.redraw()}function Ge(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,I(t),Fn(t),t.dom.redraw())}function Fn(t){const e=t.dom.elements;e.ghost&&jt(e.ghost,!1)}function Hn(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&n.tagName==="PIECE")return n;n=n.nextSibling}}function tr(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{en(t,2),setTimeout(()=>en(t,void 0),120)},120)}function en(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function nr(t,e){function n(){Ci(t),e()}return{set(i){i.orientation&&i.orientation!==t.orientation&&n(),jn(t,i),(i.fen?ae:ee)(r=>Bn(r,i),t)},state:t,getFen:()=>Bi(t.pieces),toggleOrientation:n,setPieces(i){ae(r=>Pi(r,i),t)},selectSquare(i,r){i?ae(s=>gt(s,i,r),t):t.selected&&(I(t),t.dom.redraw())},move(i,r){ae(s=>An(s,i,r),t)},newPiece(i,r){ae(s=>Bt(s,i,r),t)},playPremove(){if(t.premovable.current){if(ae(Ni,t))return!0;t.dom.redraw()}return!1},playPredrop(i){if(t.predroppable.current){const r=zi(t,i);return t.dom.redraw(),r}return!1},cancelPremove(){ee(re,t)},cancelPredrop(){ee(se,t)},cancelMove(){ee(i=>{Lt(i),Ge(i)},t)},stop(){ee(i=>{Xt(i),Ge(i)},t)},explode(i){tr(t,i)},setAutoShapes(i){ee(r=>r.drawable.autoShapes=i,t)},setShapes(i){ee(r=>r.drawable.shapes=i,t)},getKeyAtDomPos(i){return _e(i,W(t),t.dom.bounds())},redrawAll:e,dragNewPiece(i,r,s){Xi(t,i,r,s)},destroy(){Xt(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function ir(){return{pieces:Dn(Tn),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:_i()}}const tn={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function rr(){const t=M("defs"),e=T(M("filter"),{id:"cg-filter-blur"});return e.appendChild(T(M("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function sr(t,e,n){var i;const r=t.drawable,s=r.current,o=s&&s.mouseSq?s:void 0,a=new Map,l=t.dom.bounds(),c=r.autoShapes.filter(w=>!w.piece);for(const w of r.shapes.concat(c).concat(o?[o]:[])){if(!w.dest)continue;const k=(i=a.get(w.dest))!==null&&i!==void 0?i:new Set,p=Ve(Qe(P(w.orig),t.orientation),l),E=Ve(Qe(P(w.dest),t.orientation),l);k.add(bt(p,E)),a.set(w.dest,k)}const f=r.shapes.concat(c).map(w=>({shape:w,current:!1,hash:nn(w,wt(w.dest,a),!1,l)}));o&&f.push({shape:o,current:!0,hash:nn(o,wt(o.dest,a),!0,l)});const d=f.map(w=>w.hash).join(";");if(d===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=d;const u=e.querySelector("defs");or(r,f,u),ar(f,e.querySelector("g"),n.querySelector("g"),w=>hr(t,w,r.brushes,a,l))}function or(t,e,n){var i;const r=new Map;let s;for(const l of e.filter(c=>c.shape.dest&&c.shape.brush))s=qn(t.brushes[l.shape.brush],l.shape.modifiers),!((i=l.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(Ue(s).key,Ue(s)),r.set(s.key,s);const o=new Set;let a=n.firstElementChild;for(;a;)o.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[l,c]of r.entries())o.has(l)||n.appendChild(fr(c))}function ar(t,e,n,i){const r=new Map;for(const s of t)r.set(s.hash,!1);for(const s of[e,n]){const o=[];let a=s.firstElementChild,l;for(;a;)l=a.getAttribute("cgHash"),r.has(l)?r.set(l,!0):o.push(a),a=a.nextElementSibling;for(const c of o)s.removeChild(c)}for(const s of t.filter(o=>!r.get(o.hash)))for(const o of i(s))o.isCustom?n.appendChild(o.el):e.appendChild(o.el)}function nn({orig:t,dest:e,brush:n,piece:i,modifiers:r,customSvg:s,label:o},a,l,c){var f,d;return[c.width,c.height,l,t,e,n,a&&"-",i&&lr(i),r&&cr(r),s&&`custom-${rn(s.html)},${(d=(f=s.center)===null||f===void 0?void 0:f[0])!==null&&d!==void 0?d:"o"}`,o&&`label-${rn(o.text)}`].filter(u=>u).join(",")}function lr(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function cr(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function rn(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return e.toString()}function hr(t,{shape:e,current:n,hash:i},r,s,o){var a,l;const c=Ve(Qe(P(e.orig),t.orientation),o),f=e.dest?Ve(Qe(P(e.dest),t.orientation),o):c,d=e.brush&&qn(r[e.brush],e.modifiers),u=s.get(e.dest),w=[];if(d){const k=T(M("g"),{cgHash:i});w.push({el:k}),c[0]!==f[0]||c[1]!==f[1]?k.appendChild(ur(e,d,c,f,n,wt(e.dest,s))):k.appendChild(dr(r[e.brush],c,n,o))}if(e.label){const k=e.label;(a=k.fill)!==null&&a!==void 0||(k.fill=e.brush&&r[e.brush].color);const p=e.brush?void 0:"tr";w.push({el:pr(k,i,c,f,u,p),isCustom:!0})}if(e.customSvg){const k=(l=e.customSvg.center)!==null&&l!==void 0?l:"orig",[p,E]=k==="label"?Un(c,f,u).map(g=>g-.5):k==="dest"?f:c,A=T(M("g"),{transform:`translate(${p},${E})`,cgHash:i});A.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,w.push({el:A,isCustom:!0})}return w}function dr(t,e,n,i){const r=mr(),s=(i.width+i.height)/(4*Math.max(i.width,i.height));return T(M("circle"),{stroke:t.color,"stroke-width":r[n?0:1],fill:"none",opacity:Gn(t,n),cx:e[0],cy:e[1],r:s-r[1]/2})}function Ue(t){return["#ffffff","#fff","white"].includes(t.color)?tn.hilitePrimary:tn.hiliteWhite}function ur(t,e,n,i,r,s){var o;function a(f){var d;const u=wr(s&&!r),w=i[0]-n[0],k=i[1]-n[1],p=Math.atan2(k,w),E=Math.cos(p)*u,A=Math.sin(p)*u;return T(M("line"),{stroke:f?Ue(e).color:e.color,"stroke-width":gr(e,r)+(f?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${f?Ue(e).key:e.key})`,opacity:!((d=t.modifiers)===null||d===void 0)&&d.hilite?1:Gn(e,r),x1:n[0],y1:n[1],x2:i[0]-E,y2:i[1]-A})}if(!(!((o=t.modifiers)===null||o===void 0)&&o.hilite))return a(!1);const l=M("g"),c=T(M("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(br(n,i)),c.appendChild(a(!0)),l.appendChild(c),l.appendChild(a(!1)),l}function fr(t){const e=T(M("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(T(M("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function pr(t,e,n,i,r,s){var o;const l=.4*.75**t.text.length,c=Un(n,i,r),f=s==="tr"?.4:0,d=T(M("g"),{transform:`translate(${c[0]+f},${c[1]-f})`,cgHash:e});d.appendChild(T(M("circle"),{r:.4/2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:(o=t.fill)!==null&&o!==void 0?o:"#666",stroke:"white"}));const u=T(M("text"),{"font-size":l,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return u.innerHTML=t.text,d.appendChild(u),d}function Qe(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function wt(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function M(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function T(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.setAttribute(n,e[n]);return t}function qn(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(n=>n).join("")}:t}function mr(){return[3/64,4/64]}function gr(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Gn(t,e){return(t.opacity||1)*(e?.9:1)}function wr(t){return(t?20:10)/64}function Ve(t,e){const n=Math.min(1,e.width/e.height),i=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*i]}function br(t,e){const n={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return T(M("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function bt(t,e,n=!0){const i=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function _r(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((n,i)=>n+i*i,0))}function Un(t,e,n){let i=_r(t,e);const r=bt(t,e,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const s=bt(t,e);(n.has((s+1)%16)||n.has((s+15)%16))&&s&1&&(i-=.4)}return[t[0]-Math.cos(r)*i,t[1]-Math.sin(r)*i].map(s=>s+.5)}function kr(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const l of gi)t.classList.toggle("orientation-"+l,e.orientation===l);t.classList.toggle("manipulable",!e.viewOnly);const n=X("cg-container");t.appendChild(n);const i=X("cg-board");n.appendChild(i);let r,s,o;if(e.drawable.visible&&(r=T(M("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(rr()),r.appendChild(M("g")),s=T(M("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(M("g")),o=X("cg-auto-pieces"),n.appendChild(r),n.appendChild(s),n.appendChild(o)),e.coordinates){const l=e.orientation==="black"?" black":"",c=e.ranksPosition==="left"?" left":"";n.appendChild(sn(zt,"ranks"+l+c)),n.appendChild(sn(Nt,"files"+l))}let a;return e.draggable.enabled&&e.draggable.showGhost&&(a=X("piece","ghost"),jt(a,!1),n.appendChild(a)),{board:i,container:n,wrap:t,ghost:a,svg:r,customSvg:s,autoPieces:o}}function sn(t,e){const n=X("coords",e);let i;for(const r of t)i=X("coord"),i.textContent=r,n.appendChild(i);return n}function vr(t,e){if(!t.dropmode.active)return;re(t),se(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const i=be(e),r=i&&_e(i,W(t),t.dom.bounds());r&&On(t,"a0",r)}t.dom.redraw()}function yr(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),t.viewOnly)return;const i=Pr(t);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function Cr(t,e){const n=[];if("ResizeObserver"in window||n.push($e(document.body,"chessground.resize",e)),!t.viewOnly){const i=on(t,Ji,qi),r=on(t,er,Gi);for(const o of["touchmove","mousemove"])n.push($e(document,o,i));for(const o of["touchend","mouseup"])n.push($e(document,o,r));const s=()=>t.dom.bounds.clear();n.push($e(document,"scroll",s,{capture:!0,passive:!0})),n.push($e(window,"resize",s,{passive:!0}))}return()=>n.forEach(i=>i())}function $e(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}const Pr=t=>e=>{t.draggable.current?Ge(t):t.drawable.current?Ln(t):e.shiftKey||yn(e)?t.drawable.enabled&&Hi(t,e):t.viewOnly||(t.dropmode.active?vr(t,e):Zi(t,e))},on=(t,e,n)=>i=>{t.drawable.current?t.drawable.enabled&&n(t,i):t.viewOnly||e(t,i)};function Er(t){const e=W(t),n=Le(t.dom.bounds()),i=t.dom.elements.board,r=t.pieces,s=t.animation.current,o=s?s.plan.anims:new Map,a=s?s.plan.fadings:new Map,l=t.draggable.current,c=Sr(t),f=new Set,d=new Set,u=new Map,w=new Map;let k,p,E,A,g,y,R,$,J,U;for(p=i.firstChild;p;){if(k=p.cgKey,Qn(p))if(E=r.get(k),g=o.get(k),y=a.get(k),A=p.cgPiece,p.cgDragging&&(!l||l.orig!==k)&&(p.classList.remove("dragging"),Q(p,n(P(k),e)),p.cgDragging=!1),!y&&p.cgFading&&(p.cgFading=!1,p.classList.remove("fading")),E){if(g&&p.cgAnimating&&A===Oe(E)){const v=P(k);v[0]+=g[2],v[1]+=g[3],p.classList.add("anim"),Q(p,n(v,e))}else p.cgAnimating&&(p.cgAnimating=!1,p.classList.remove("anim"),Q(p,n(P(k),e)),t.addPieceZIndex&&(p.style.zIndex=ht(P(k),e)));A===Oe(E)&&(!y||!p.cgFading)?f.add(k):y&&A===Oe(y)?(p.classList.add("fading"),p.cgFading=!0):dt(u,A,p)}else dt(u,A,p);else if(Vn(p)){const v=p.className;c.get(k)===v?d.add(k):dt(w,v,p)}p=p.nextSibling}for(const[v,H]of c)if(!d.has(v)){J=w.get(H),U=J&&J.pop();const D=n(P(v),e);if(U)U.cgKey=v,Q(U,D);else{const j=X("square",H);j.cgKey=v,Q(j,D),i.insertBefore(j,i.firstChild)}}for(const[v,H]of r)if(g=o.get(v),!f.has(v))if(R=u.get(Oe(H)),$=R&&R.pop(),$){$.cgKey=v,$.cgFading&&($.classList.remove("fading"),$.cgFading=!1);const D=P(v);t.addPieceZIndex&&($.style.zIndex=ht(D,e)),g&&($.cgAnimating=!0,$.classList.add("anim"),D[0]+=g[2],D[1]+=g[3]),Q($,n(D,e))}else{const D=Oe(H),j=X("piece",D),oe=P(v);j.cgPiece=D,j.cgKey=v,g&&(j.cgAnimating=!0,oe[0]+=g[2],oe[1]+=g[3]),Q(j,n(oe,e)),t.addPieceZIndex&&(j.style.zIndex=ht(oe,e)),i.appendChild(j)}for(const v of u.values())ln(t,v);for(const v of w.values())ln(t,v)}function xr(t){const e=W(t),n=Le(t.dom.bounds());let i=t.dom.elements.board.firstChild;for(;i;)(Qn(i)&&!i.cgAnimating||Vn(i))&&Q(i,n(P(i.cgKey),e)),i=i.nextSibling}function an(t){var e,n;const i=t.dom.elements.wrap.getBoundingClientRect(),r=t.dom.elements.container,s=i.height/i.width,o=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=o*s;r.style.width=o+"px",r.style.height=a+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("--cg-width",o+"px"),(n=t.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",a+"px")}const Qn=t=>t.tagName==="PIECE",Vn=t=>t.tagName==="SQUARE";function ln(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function ht(t,e){const i=t[1];return`${e?10-i:3+i}`}const Oe=t=>`${t.color} ${t.role}`;function Sr(t){var e,n,i;const r=new Map;if(t.lastMove&&t.highlight.lastMove)for(const a of t.lastMove)Z(r,a,"last-move");if(t.check&&t.highlight.check&&Z(r,t.check,"check"),t.selected&&(Z(r,t.selected,"selected"),t.movable.showDests)){const a=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(a)for(const c of a)Z(r,c,"move-dest"+(t.pieces.has(c)?" oc":""));const l=(i=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(t.selected))!==null&&i!==void 0?i:t.premovable.dests;if(l)for(const c of l)Z(r,c,"premove-dest"+(t.pieces.has(c)?" oc":""))}const s=t.premovable.current;if(s)for(const a of s)Z(r,a,"current-premove");else t.predroppable.current&&Z(r,t.predroppable.current.key,"current-premove");const o=t.exploding;if(o)for(const a of o.keys)Z(r,a,"exploding"+o.stage);return t.highlight.custom&&t.highlight.custom.forEach((a,l)=>{Z(r,l,a)}),r}function Z(t,e,n){const i=t.get(e);i?t.set(e,`${i} ${n}`):t.set(e,n)}function dt(t,e,n){const i=t.get(e);i?i.push(n):t.set(e,[n])}function Mr(t,e,n){const i=new Map,r=[];for(const a of t)i.set(a.hash,!1);let s=e.firstElementChild,o;for(;s;)o=s.getAttribute("cgHash"),i.has(o)?i.set(o,!0):r.push(s),s=s.nextElementSibling;for(const a of r)e.removeChild(a);for(const a of t)i.get(a.hash)||e.appendChild(n(a))}function Ar(t,e){const i=t.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:Or(r),current:!1}));Mr(i,e,r=>$r(t,r,t.dom.bounds()))}function Rr(t){var e;const n=W(t),i=Le(t.dom.bounds());let r=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;r;)vn(r,i(P(r.cgKey),n),r.cgScale),r=r.nextSibling}function $r(t,{shape:e,hash:n},i){var r,s,o;const a=e.orig,l=(r=e.piece)===null||r===void 0?void 0:r.role,c=(s=e.piece)===null||s===void 0?void 0:s.color,f=(o=e.piece)===null||o===void 0?void 0:o.scale,d=X("piece",`${l} ${c}`);return d.setAttribute("cgHash",n),d.cgKey=a,d.cgScale=f,vn(d,Le(i)(P(a),W(t)),f),d}const Or=t=>{var e,n,i;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(n=t.piece)===null||n===void 0?void 0:n.color,(i=t.piece)===null||i===void 0?void 0:i.scale].join(",")};function Nr(t,e){const n=ir();Bn(n,e||{});function i(){const r="dom"in n?n.dom.unbind:void 0,s=kr(t,n),o=bi(()=>s.board.getBoundingClientRect()),a=f=>{Er(c),s.autoPieces&&Ar(c,s.autoPieces),!f&&s.svg&&sr(c,s.svg,s.customSvg)},l=()=>{an(c),xr(c),s.autoPieces&&Rr(c)},c=n;return c.dom={elements:s,bounds:o,redraw:zr(a),redrawNow:a,unbind:r},c.drawable.prevSvgHash="",an(c),a(!1),yr(c,l),r||(c.dom.unbind=Cr(c,l)),c.events.insert&&c.events.insert(s),c}return nr(i(),i)}function zr(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}const Ze=["a","b","c","d","e","f","g","h"],Zn=["1","2","3","4","5","6","7","8"],ge=["white","black"],q=["pawn","knight","bishop","rook","queen","king"],Tr=["a","h"],je=t=>"role"in t,m=t=>t!==void 0,x=t=>t==="white"?"black":"white",we=t=>t>>3,z=t=>t&7,_t=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,fe=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Pe(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function pe(t){if(t.length===2)return _t(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const ne=t=>Ze[z(t)]+Zn[we(t)],Yn=t=>{if(t[1]==="@"&&t.length===4){const e=Pe(t[0]),n=pe(t.slice(2));if(e&&m(n))return{role:e,to:n}}else if(t.length===4||t.length===5){const e=pe(t.slice(0,2)),n=pe(t.slice(2,4));let i;if(t.length===5&&(i=Pe(t[4]),!i))return;if(m(e)&&m(n))return{from:e,to:n,promotion:i}}},cn=t=>je(t)?`${fe(t.role).toUpperCase()}@${ne(t.to)}`:ne(t.from)+ne(t.to)+(t.promotion?fe(t.promotion):""),Ht=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,qt=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,hn=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),kt=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),dn=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,kt(t));class h{constructor(e,n){this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new h(0,1<<e-32):new h(1<<e,0)}static fromRank(e){return new h(255,0).shl64(8*e)}static fromFile(e){return new h(16843009<<e,16843009<<e)}static empty(){return new h(0,0)}static full(){return new h(4294967295,4294967295)}static corners(){return new h(129,2164260864)}static center(){return new h(402653184,24)}static backranks(){return new h(255,4278190080)}static backrank(e){return e==="white"?new h(255,0):new h(0,4278190080)}static lightSquares(){return new h(1437226410,1437226410)}static darkSquares(){return new h(2857740885,2857740885)}complement(){return new h(~this.lo,~this.hi)}xor(e){return new h(this.lo^e.lo,this.hi^e.hi)}union(e){return new h(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new h(this.lo&e.lo,this.hi&e.hi)}diff(e){return new h(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?h.empty():e>=32?new h(this.hi>>>e-32,0):e>0?new h(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?h.empty():e>=32?new h(0,this.lo<<e-32):e>0?new h(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new h(kt(this.hi),kt(this.lo))}rbit64(){return new h(dn(this.hi),dn(this.lo))}minus64(e){const n=this.lo-e.lo,i=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new h(n,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return hn(this.lo)+hn(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new h(this.lo,this.hi|1<<e-32):new h(this.lo|1<<e,this.hi)}without(e){return e>=32?new h(this.lo,this.hi&~(1<<e-32)):new h(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new h(this.lo,this.hi^1<<e-32):new h(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new h(this.lo&this.lo-1,this.hi):new h(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const i=31-Math.clz32(e&-e);e^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;e!==0;){const i=31-Math.clz32(e);e^=1<<i,yield i}}}const Ye=(t,e)=>{let n=h.empty();for(const i of e){const r=t+i;0<=r&&r<64&&Math.abs(z(t)-z(r))<=2&&(n=n.with(r))}return n},ie=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},Dr=ie(t=>Ye(t,[-9,-8,-7,-1,1,7,8,9])),jr=ie(t=>Ye(t,[-17,-15,-10,-6,6,10,15,17])),Br={white:ie(t=>Ye(t,[7,9])),black:ie(t=>Ye(t,[-7,-9]))},st=t=>Dr[t],ot=t=>jr[t],Ie=(t,e)=>Br[t][e],vt=ie(t=>h.fromFile(z(t)).without(t)),yt=ie(t=>h.fromRank(we(t)).without(t)),Ct=ie(t=>{const e=new h(134480385,2151686160),n=8*(we(t)-z(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Pt=ie(t=>{const e=new h(270549120,16909320),n=8*(we(t)+z(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Et=(t,e,n)=>{let i=n.intersect(e),r=i.bswap64();return i=i.minus64(t),r=r.minus64(t.bswap64()),i.xor(r.bswap64()).intersect(e)},Kr=(t,e)=>Et(h.fromSquare(t),vt[t],e),Wr=(t,e)=>{const n=yt[t];let i=e.intersect(n),r=i.rbit64();return i=i.minus64(h.fromSquare(t)),r=r.minus64(h.fromSquare(63-t)),i.xor(r.rbit64()).intersect(n)},xe=(t,e)=>{const n=h.fromSquare(t);return Et(n,Ct[t],e).xor(Et(n,Pt[t],e))},Se=(t,e)=>Kr(t,e).xor(Wr(t,e)),Gt=(t,e)=>xe(t,e).xor(Se(t,e)),Lr=(t,e,n)=>{switch(t.role){case"pawn":return Ie(t.color,e);case"knight":return ot(e);case"bishop":return xe(e,n);case"rook":return Se(e,n);case"queen":return Gt(e,n);case"king":return st(e)}},Xn=(t,e)=>{const n=h.fromSquare(e);return yt[t].intersects(n)?yt[t].with(t):Pt[t].intersects(n)?Pt[t].with(t):Ct[t].intersects(n)?Ct[t].with(t):vt[t].intersects(n)?vt[t].with(t):h.empty()},Be=(t,e)=>Xn(t,e).intersect(h.full().shl64(t).xor(h.full().shl64(e))).withoutFirst();class Ee{constructor(){}static default(){const e=new Ee;return e.reset(),e}reset(){this.occupied=new h(65535,4294901760),this.promoted=h.empty(),this.white=new h(65535,0),this.black=new h(0,4294901760),this.pawn=new h(65280,16711680),this.knight=new h(66,1107296256),this.bishop=new h(36,603979776),this.rook=new h(129,2164260864),this.queen=new h(8,134217728),this.king=new h(16,268435456)}static empty(){const e=new Ee;return e.clear(),e}clear(){this.occupied=h.empty(),this.promoted=h.empty();for(const e of ge)this[e]=h.empty();for(const e of q)this[e]=h.empty()}clone(){const e=new Ee;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of ge)e[n]=this[n];for(const n of q)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of q)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const i=this.getRole(e),r=this.promoted.has(e);return{color:n,role:i,promoted:r}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const i=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),i}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class V{constructor(){}static empty(){const e=new V;for(const n of q)e[n]=0;return e}static fromBoard(e,n){const i=new V;for(const r of q)i[r]=e.pieces(n,r).size();return i}clone(){const e=new V;for(const n of q)e[n]=this[n];return e}equals(e){return q.every(n=>this[n]===e[n])}add(e){const n=new V;for(const i of q)n[i]=this[i]+e[i];return n}subtract(e){const n=new V;for(const i of q)n[i]=this[i]-e[i];return n}nonEmpty(){return q.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class le{constructor(e,n){this.white=e,this.black=n}static empty(){return new le(V.empty(),V.empty())}static fromBoard(e){return new le(V.fromBoard(e,"white"),V.fromBoard(e,"black"))}clone(){return new le(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new le(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new le(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class Ke{constructor(e,n){this.white=e,this.black=n}static default(){return new Ke(3,3)}clone(){return new Ke(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}class Jn{unwrap(e,n){const i=this._chain(r=>b.ok(e?e(r):r),r=>n?b.ok(n(r)):b.err(r));if(i.isErr)throw i.error;return i.value}map(e,n){return this._chain(i=>b.ok(e(i)),i=>b.err(n?n(i):i))}chain(e,n){return this._chain(e,n||(i=>b.err(i)))}}class Ir extends Jn{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}}class Fr extends Jn{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}}var b;(function(t){t.ok=function(e){return new Ir(e)},t.err=function(e){return new Fr(e||new Error)},t.all=function(e){if(Array.isArray(e)){const r=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;r.push(o.value)}return t.ok(r)}const n={},i=Object.keys(e);for(let r=0;r<i.length;r++){const s=e[i[r]];if(s.isErr)return s;n[i[r]]=s.value}return t.ok(n)}})(b||(b={}));var te;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(te||(te={}));class ke extends Error{}const Hr=(t,e,n,i)=>n[e].intersect(Se(t,i).intersect(n.rooksAndQueens()).union(xe(t,i).intersect(n.bishopsAndQueens())).union(ot(t).intersect(n.knight)).union(st(t).intersect(n.king)).union(Ie(x(e),t).intersect(n.pawn)));class ue{constructor(){}static default(){const e=new ue;return e.castlingRights=h.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new h(14,0),h:new h(96,0)},black:{a:new h(0,234881024),h:new h(0,1610612736)}},e}static empty(){const e=new ue;return e.castlingRights=h.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:h.empty(),h:h.empty()},black:{a:h.empty(),h:h.empty()}},e}clone(){const e=new ue;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,i,r){const s=Ht(e,n),o=qt(e,n);this.castlingRights=this.castlingRights.with(r),this.rook[e][n]=r,this.path[e][n]=Be(r,o).with(o).union(Be(i,s).with(s)).without(i).without(r)}static fromSetup(e){const n=ue.empty(),i=e.castlingRights.intersect(e.board.rook);for(const r of ge){const s=h.backrank(r),o=e.board.kingOf(r);if(!m(o)||!s.has(o))continue;const a=i.intersect(e.board[r]).intersect(s),l=a.first();m(l)&&l<o&&n.add(r,"a",o,l);const c=a.last();m(c)&&o<c&&n.add(r,"h",o,c)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of ge)for(const i of Tr)this.rook[n][i]===e&&(this.rook[n][i]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(h.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class qr{constructor(e){this.rules=e}reset(){this.board=Ee.default(),this.pockets=void 0,this.turn="white",this.castles=ue.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=h.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=ue.fromSetup(e),this.epSquare=Gr(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,i){return Hr(e,n,this.board,i)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[x(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!m(n))return{king:n,blockers:h.empty(),checkers:h.empty(),variantEnd:e,mustCapture:!1};const i=Se(n,h.empty()).intersect(this.board.rooksAndQueens()).union(xe(n,h.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[x(this.turn)]);let r=h.empty();for(const o of i){const a=Be(n,o).intersect(this.board.occupied);a.moreThanOne()||(r=r.union(a))}const s=this.kingAttackers(n,x(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var e,n;const i=new this.constructor;return i.board=this.board.clone(),i.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(){if(this.board.occupied.isEmpty())return b.err(new ke(te.Empty));if(this.board.king.size()!==2)return b.err(new ke(te.Kings));if(!m(this.board.kingOf(this.turn)))return b.err(new ke(te.Kings));const e=this.board.kingOf(x(this.turn));return m(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?b.err(new ke(te.OppositeCheck)):h.backranks().intersects(this.board.pawn)?b.err(new ke(te.PawnsOnBackrank)):b.ok(void 0):b.err(new ke(te.Kings))}dropDests(e){return h.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return h.empty();const i=this.board.get(e);if(!i||i.color!==this.turn)return h.empty();let r,s;if(i.role==="pawn"){r=Ie(this.turn,e).intersect(this.board[x(this.turn)]);const o=this.turn==="white"?8:-8,a=e+o;if(0<=a&&a<64&&!this.board.occupied.has(a)){r=r.with(a);const l=this.turn==="white"?e<16:e>=48,c=a+o;l&&!this.board.occupied.has(c)&&(r=r.with(c))}m(this.epSquare)&&Qr(this,e,n)&&(s=h.fromSquare(this.epSquare))}else i.role==="bishop"?r=xe(e,this.board.occupied):i.role==="knight"?r=ot(e):i.role==="rook"?r=Se(e,this.board.occupied):i.role==="queen"?r=Gt(e,this.board.occupied):r=st(e);if(r=r.diff(this.board[this.turn]),m(n.king)){if(i.role==="king"){const o=this.board.occupied.without(e);for(const a of r)this.kingAttackers(a,x(this.turn),o).nonEmpty()&&(r=r.without(a));return r.union(un(this,"a",n)).union(un(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!m(o))return h.empty();r=r.intersect(Be(o,n.king).with(o))}n.blockers.has(e)&&(r=r.intersect(Xn(e,n.king)))}return s&&(r=r.union(s)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[x(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(h.darkSquares())||!this.board.bishop.intersects(h.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Ur(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return ge.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){if(je(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&h.backranks().has(e.to)?!1:this.dropDests(n).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&h.backranks().has(e.to)))return!1;const i=this.dests(e.from,n);return i.has(e.to)||i.has(Vr(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return m(e)&&this.kingAttackers(e,x(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:x(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,e));return n}play(e){const n=this.turn,i=this.epSquare,r=ei(this,e);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=x(n),je(e))this.board.set(e.to,{role:e.role,color:n}),this.pockets&&this.pockets[n][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===i&&(o=this.board.take(e.to+(n==="white"?-8:8)));const a=e.from-e.to;Math.abs(a)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(r){const a=this.castles.rook[n][r];if(m(a)){const l=this.board.take(a);this.board.set(Ht(n,r),s),l&&this.board.set(qt(n,r),l)}}this.castles.discardColor(n)}if(!r){const a=this.board.set(e.to,s)||o;a&&this.playCaptureAt(e.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class Xe extends qr{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}}const Gr=(t,e)=>{if(!m(e))return;const n=t.turn==="white"?5:2,i=t.turn==="white"?8:-8;if(we(e)!==n||t.board.occupied.has(e+i))return;const r=e-i;if(!(!t.board.pawn.has(r)||!t.board[x(t.turn)].has(r)))return e},Ur=t=>{if(!m(t.epSquare))return;const e=t.ctx(),i=t.board.pieces(t.turn,"pawn").intersect(Ie(x(t.turn),t.epSquare));for(const r of i)if(t.dests(r,e).has(t.epSquare))return t.epSquare},Qr=(t,e,n)=>{if(!m(t.epSquare)||!Ie(t.turn,e).has(t.epSquare))return!1;if(!m(n.king))return!0;const i=t.turn==="white"?8:-8,r=t.epSquare-i;return t.kingAttackers(n.king,x(t.turn),t.board.occupied.toggle(e).toggle(r).with(t.epSquare)).without(r).isEmpty()},un=(t,e,n)=>{if(!m(n.king)||n.checkers.nonEmpty())return h.empty();const i=t.castles.rook[t.turn][e];if(!m(i)||t.castles.path[t.turn][e].intersects(t.board.occupied))return h.empty();const r=Ht(t.turn,e),s=Be(n.king,r),o=t.board.occupied.without(n.king);for(const c of s)if(t.kingAttackers(c,x(t.turn),o).nonEmpty())return h.empty();const a=qt(t.turn,e),l=t.board.occupied.toggle(n.king).toggle(i).toggle(a);return t.kingAttackers(r,x(t.turn),l).nonEmpty()?h.empty():h.fromSquare(i)},ei=(t,e)=>{if(je(e))return;const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},Vr=(t,e)=>{const n=ei(t,e);if(!n)return e;const i=t.castles.rook[t.turn][n];return{from:e.from,to:m(i)?i:e.to}},Zr=(t,e)=>{const n=new Map,i=t.ctx();for(const[r,s]of t.allDests(i))if(s.nonEmpty()){const o=Array.from(s,ne);!(e!=null&&e.chess960)&&r===i.king&&z(r)===4&&(s.has(0)?o.push("c1"):s.has(56)&&o.push("c8"),s.has(7)?o.push("g1"):s.has(63)&&o.push("g8")),n.set(ne(r),o)}return n},Yr="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Xr=Yr+" w KQkq -",at=Xr+" 0 1";var S;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(S||(S={}));class N extends Error{}const Jr=(t,e,n)=>{let i=t.indexOf(e);for(;n-- >0&&i!==-1;)i=t.indexOf(e,i+e.length);return i},ye=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,ti=t=>{const e=Pe(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},ut=t=>{const e=Ee.empty();let n=7,i=0;for(let r=0;r<t.length;r++){const s=t[r];if(s==="/"&&i===8)i=0,n--;else{const o=parseInt(s,10);if(o>0)i+=o;else{if(i>=8||n<0)return b.err(new N(S.Board));const a=i+n*8,l=ti(s);if(!l)return b.err(new N(S.Board));t[r+1]==="~"&&(l.promoted=!0,r++),e.set(a,l),i++}}}return n!==0||i!==8?b.err(new N(S.Board)):b.ok(e)},fn=t=>{if(t.length>64)return b.err(new N(S.Pockets));const e=le.empty();for(const n of t){const i=ti(n);if(!i)return b.err(new N(S.Pockets));e[i.color][i.role]++}return b.ok(e)},es=(t,e)=>{let n=h.empty();if(e==="-")return b.ok(n);for(const i of e){const r=i.toLowerCase(),s=i===r?"black":"white",o=s==="white"?0:7;if("a"<=r&&r<="h")n=n.with(_t(r.charCodeAt(0)-97,o));else if(r==="k"||r==="q"){const a=t[s].intersect(h.backrank(s)).intersect(t.rook.union(t.king)),l=r==="k"?a.last():a.first();n=n.with(m(l)&&t.rook.has(l)?l:_t(r==="k"?7:0,o))}else return b.err(new N(S.Castling))}return ge.some(i=>h.backrank(i).intersect(n).size()>2)?b.err(new N(S.Castling)):b.ok(n)},pn=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=ye(e[1]),i=ye(e[2]);return!m(n)||n>3||!m(i)||i>3?b.err(new N(S.RemainingChecks)):b.ok(new Ke(3-n,3-i))}else if(e.length===2){const n=ye(e[0]),i=ye(e[1]);return!m(n)||n>3||!m(i)||i>3?b.err(new N(S.RemainingChecks)):b.ok(new Ke(n,i))}else return b.err(new N(S.RemainingChecks))},We=t=>{const e=t.split(/[\s_]+/),n=e.shift();let i,r=b.ok(void 0);if(n.endsWith("]")){const a=n.indexOf("[");if(a===-1)return b.err(new N(S.Fen));i=ut(n.slice(0,a)),r=fn(n.slice(a+1,-1))}else{const a=Jr(n,"/",7);a===-1?i=ut(n):(i=ut(n.slice(0,a)),r=fn(n.slice(a+1)))}let s;const o=e.shift();if(!m(o)||o==="w")s="white";else if(o==="b")s="black";else return b.err(new N(S.Turn));return i.chain(a=>{const l=e.shift(),c=m(l)?es(a,l):b.ok(h.empty()),f=e.shift();let d;if(m(f)&&f!=="-"&&(d=pe(f),!m(d)))return b.err(new N(S.EpSquare));let u=e.shift(),w;m(u)&&u.includes("+")&&(w=pn(u),u=e.shift());const k=m(u)?ye(u):0;if(!m(k))return b.err(new N(S.Halfmoves));const p=e.shift(),E=m(p)?ye(p):1;if(!m(E))return b.err(new N(S.Fullmoves));const A=e.shift();let g=b.ok(void 0);if(m(A)){if(m(w))return b.err(new N(S.RemainingChecks));g=pn(A)}else m(w)&&(g=w);return e.length>0?b.err(new N(S.Fen)):r.chain(y=>c.chain(R=>g.map($=>({board:a,pockets:y,turn:s,castlingRights:R,remainingChecks:$,epSquare:d,halfmoves:k,fullmoves:Math.max(1,E)}))))})},ts=t=>{let e=fe(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},ns=t=>{let e="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const s=r+i*8,o=t.get(s);o?(n>0&&(e+=n,n=0),e+=ts(o)):n++,r===7&&(n>0&&(e+=n,n=0),i!==0&&(e+="/"))}return e},mn=t=>q.map(e=>fe(e).repeat(t[e])).join(""),is=t=>mn(t.white).toUpperCase()+mn(t.black),rs=(t,e)=>{let n="";for(const i of ge){const r=h.backrank(i);let s=t.kingOf(i);m(s)&&!r.has(s)&&(s=void 0);const o=t.pieces(i,"rook").intersect(r);for(const a of e.intersect(r).reversed())if(a===o.first()&&m(s)&&a<s)n+=i==="white"?"Q":"q";else if(a===o.last()&&m(s)&&s<a)n+=i==="white"?"K":"k";else{const l=Ze[z(a)];n+=i==="white"?l.toUpperCase():l}}return n||"-"},ss=t=>`${t.white}+${t.black}`,ni=(t,e)=>[ns(t.board)+(t.pockets?`[${is(t.pockets)}]`:""),t.turn[0],rs(t.board,t.castlingRights),m(t.epSquare)?ne(t.epSquare):"-",...t.remainingChecks?[ss(t.remainingChecks)]:[],...e!=null&&e.epd?[]:[Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))]].join(" "),os=(t,e)=>{let n="";if(je(e))e.role!=="pawn"&&(n=fe(e.role).toUpperCase()),n+="@"+ne(e.to);else{const i=t.board.getRole(e.from);if(!i)return"--";if(i==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))n=e.to>e.from?"O-O":"O-O-O";else{const r=t.board.occupied.has(e.to)||i==="pawn"&&z(e.from)!==z(e.to);if(i!=="pawn"){n=fe(i).toUpperCase();let s;if(i==="king"?s=st(e.to).intersect(t.board.king):i==="queen"?s=Gt(e.to,t.board.occupied).intersect(t.board.queen):i==="rook"?s=Se(e.to,t.board.occupied).intersect(t.board.rook):i==="bishop"?s=xe(e.to,t.board.occupied).intersect(t.board.bishop):s=ot(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const a of s)t.dests(a,o).has(e.to)||(s=s.without(a));if(s.nonEmpty()){let a=!1,l=s.intersects(h.fromRank(we(e.from)));s.intersects(h.fromFile(z(e.from)))?a=!0:l=!0,l&&(n+=Ze[z(e.from)]),a&&(n+=Zn[we(e.from)])}}}else r&&(n=Ze[z(e.from)]);r&&(n+="x"),n+=ne(e.to),e.promotion&&(n+="="+fe(e.promotion).toUpperCase())}}return n},as=(t,e)=>{var n;const i=os(t,e);return t.play(e),!((n=t.outcome())===null||n===void 0)&&n.winner?i+"#":t.isCheck()?i+"+":i},ls=(t,e)=>as(t.clone(),e),gn=(t,e)=>{const n=t.ctx(),i=e.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!i){let f;if(e==="O-O"||e==="O-O+"||e==="O-O#"?f="h":(e==="O-O-O"||e==="O-O-O+"||e==="O-O-O#")&&(f="a"),f){const w=t.castles.rook[t.turn][f];return!m(n.king)||!m(w)||!t.dests(n.king,n).has(w)?void 0:{from:n.king,to:w}}const d=e.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!d)return;const u={role:d[1]?Pe(d[1]):"pawn",to:pe(d[2])};return t.isLegal(u,n)?u:void 0}const r=i[1]?Pe(i[1]):"pawn",s=pe(i[4]),o=i[5]?Pe(i[5]):void 0;if(!!o!==(r==="pawn"&&h.backranks().has(s))||o==="king"&&t.rules!=="antichess")return;let a=t.board.pieces(t.turn,r);r==="pawn"&&!i[2]?a=a.intersect(h.fromFile(z(s))):i[2]&&(a=a.intersect(h.fromFile(i[2].charCodeAt(0)-97))),i[3]&&(a=a.intersect(h.fromRank(i[3].charCodeAt(0)-49)));const l=r==="pawn"?h.fromFile(z(s)):h.empty();a=a.intersect(l.union(Lr({color:x(t.turn),role:r},s,t.board.occupied)));let c;for(const f of a)if(t.dests(f,n).has(s)){if(m(c))return;c=f}if(m(c))return{from:c,to:s,promotion:o}},cs=(t=Ut)=>({headers:t(),moves:new ii});class ii{constructor(){this.children=[]}*mainlineNodes(){let e=this;for(;e.children.length;){const n=e.children[0];yield n,e=n}}*mainline(){for(const e of this.mainlineNodes())yield e.data}end(){let e=this;for(;e.children.length;)e=e.children[0];return e}}class hs extends ii{constructor(e){super(),this.data=e}}const Ut=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),wn="\uFEFF",ft=t=>/^\s*$/.test(t),pt=t=>t.startsWith("%");class ds extends Error{}class us{constructor(e,n=Ut,i=1e6){this.emitGame=e,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=cs(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(e){if(this.budget-=e,this.budget<0)throw new ds("ERR_PGN_BUDGET")}parse(e,n){if(!(this.budget<0))try{let i=0;for(;;){const r=e.indexOf(`
`,i);if(r===-1)break;const s=r>i&&e[r-1]==="\r"?r-1:r;this.consumeBudget(r-i),this.lineBuf.push(e.slice(i,s)),i=r+1,this.handleLine()}this.consumeBudget(e.length-i),this.lineBuf.push(e.slice(i)),n!=null&&n.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let e=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(wn)&&(n=n.slice(wn.length)),this.state=1;case 1:if(ft(n)||pt(n))return;this.found=!0,this.state=2;case 2:{if(pt(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(r,s,o)=>(this.consumeBudget(200),this.game.headers.set(s,o.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,e=!1,""));if(ft(n))return;this.state=3}case 3:{if(e){if(pt(n))return;if(ft(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let r;for(;r=i.exec(n);){const s=this.stack[this.stack.length-1];let o=r[0];if(o===";")return;if(o.startsWith("$"))this.handleNag(parseInt(o.slice(1),10));else if(o==="!")this.handleNag(1);else if(o==="?")this.handleNag(2);else if(o==="!!")this.handleNag(3);else if(o==="??")this.handleNag(4);else if(o==="!?")this.handleNag(5);else if(o==="?!")this.handleNag(6);else if(o==="1-0"||o==="0-1"||o==="1/2-1/2"||o==="*")this.stack.length===1&&o!=="*"&&this.game.headers.set("Result",o);else if(o==="(")this.consumeBudget(100),this.stack.push({parent:s.parent,root:!1});else if(o===")")this.stack.length>1&&this.stack.pop();else if(o==="{"){const a=i.lastIndex,l=n[a]===" "?a+1:a;n=n.slice(l),this.state=4;continue e}else this.consumeBudget(100),o==="Z0"||o==="0000"||o==="@@@@"?o="--":o.startsWith("0")&&(o=o.replace(/0/g,"O")),s.node&&(s.parent=s.node),s.node=new hs({san:o,startingComments:s.startingComments}),s.startingComments=void 0,s.root=!1,s.parent.children.push(s.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const r=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,r)),this.handleComment(),n=n.slice(i),this.state=3,e=!1}}}}handleNag(e){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(e))}handleComment(){var e,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],r=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((e=i.node.data).comments||(e.comments=[]),i.node.data.comments.push(r)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(r)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(r))}emit(e){if(this.state===4&&this.handleComment(),e)return this.emitGame(this.game,e);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const fs=(t,e=Ut)=>{const n=[];return new us(i=>n.push(i),e,NaN).parse(t),n},et=class et{constructor(e,n){this.headers=e,this.tree=n}get event(){return this.headers.event}get site(){return this.headers.site}get white(){return this.headers.white}get black(){return this.headers.black}get puzzle(){return this.headers.puzzle}};_(et,"make_many",e=>fs(e).map(n=>{let i=n.headers.get("Event"),r=n.headers.get("Site"),s=n.headers.get("White"),o=n.headers.get("Black"),a=n.headers.get("Puzzle"),l=n.headers.get("FEN"),c=n.moves.children[0],f=l??at,d=c.data.san,u=Xe.fromSetup(We(f).unwrap()).unwrap(),w=gn(u,d),k=cn(w),p=Je.make(f,[k]);E(p,c,u,[]);function E(g,y,R,$){let J=gn(R,y.data.san),U=R.clone();U.play(J);let v=cn(J);g.append_uci(v,$),y.children.forEach(H=>{E(g,H,U,[...$,v])})}return new et({event:i,site:r,white:s,black:o,puzzle:a},p)}));let xt=et;const ze=class ze{constructor(e){_(this,"_children");this.data=e,this._children=B([])}static color_of(e){return We(e.data.before_fen).unwrap().turn}get clone(){let e=new ze({...this.data});return e.children=this.children.map(n=>n.clone),e}get length(){if(this.children.length>1)return 1;if(this.children.length===0)return 0;let e=1,n=this.children[0];for(;(n==null?void 0:n.children.length)===1;)e++,n=n.children[0];return e}get nb_first_variations(){var e;return((e=this.children_first_variations)==null?void 0:e.length)??0}get children_first_variations(){let e=this.children;for(;(e==null?void 0:e.length)===1;)e=e[0].children;if(e.length>1)return e}get children(){return this._children[0]()}set children(e){this._children[1](e)}};_(ze,"make",e=>new ze(e));let Ne=ze;const ce=class ce{constructor(e){this.root=e}get initial_color(){return Ne.color_of(this.root)}get clone(){return new ce(this.root.clone)}static make_data(e,n,i,r){let s=We(e).unwrap(),o=Xe.fromSetup(s).unwrap(),a=Yn(n),l=ls(o,a);return o.play(a),{path:[...r,n],ply:i,before_fen:e,san:l,after_fen:ni(o.toSetup()),uci:n}}_traverse_path(e){let n,i=[this.root];for(let r of e)n=i.find(s=>s.data.uci===r),i=(n==null?void 0:n.children)||this.root;return n}_find_path(e){let n=[],i=[],r=this.root,s=[r],o=!1;for(let a of e)if(o)i.push(a);else{let l=s.find(c=>c.data.uci===a);l?(n.push(a),r=l,s=qe(()=>r.children)):(o=!0,i.push(a))}return[n,r,i]}get_children(e){let n=this._traverse_path(e);return n==null?void 0:n.children.map(i=>i.data)}get_at(e){let n=this._traverse_path(e);return n==null?void 0:n.data}append_uci(e,n=[]){this.append_ucis([...n,e])}append_ucis(e){let[n,i,r]=this._find_path(e);for(let s of r){let o=Ne.make(ce.make_data(i.data.after_fen,s,i.data.ply+1,n)),a=qe(()=>i.children);i.children=[...a,o],i=o,n=[...n,s]}}};_(ce,"make",(e,n)=>{let i=n[0],r=n.slice(1),s=new ce(Ne.make(ce.make_data(e,i,1,[])));return s.append_ucis(r),s});let Je=ce;var ps=F('<div class="is2d chessboard">');const ms=t=>{let e,n;return bn(()=>{let i=t.color,r=t.dests,s={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:t.onMoveAfter}}};n=Nr(e,s)}),Y(()=>{let i,r;t.fen_uci?[i,r]=t.fen_uci:i=at;let s=[];r&&(s.push(r.slice(0,2)),s.push(r.slice(2,4)));let o=t.movable?t.color:void 0;n.set({fen:i,lastMove:s,turnColor:t.color,movable:{color:o,dests:t.dests}})}),Y(()=>{let i=t.orientation??"white";n.set({orientation:i})}),Y(()=>{let i=t.doPromotion;if(i){let r=n.state.pieces.get(i);n.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),(()=>{var i=ps();return Ot(r=>e=r,i),i})()};var gs=F("<div class=chesstree>"),ws=F("<div class=lines>"),bs=F("<div class=line>"),_s=F("<span class=index>"),ks=F("<div>");class Ce{constructor(){_(this,"_blacks");_(this,"_whites");this._blacks=B([],{equals:!1}),this._whites=B([],{equals:!1})}replace_all(e){this.blacks=e.blacks.slice(0),this.whites=e.whites.slice(0)}merge_dup(e){he(()=>{e.paths.forEach(n=>this.add_path(n))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(e){let n=new Ce;return n.blacks=e[0],n.whites=e[1],n}set blacks(e){this._blacks[1](e)}set whites(e){this._whites[1](e)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let e=[];return this.whites.forEach(n=>{for(let i=0;i<=n.length-1;i+=2)e.push(n.slice(0,i+1))}),this.blacks.forEach(n=>{for(let i=1;i<=n.length-1;i+=2)e.push(n.slice(0,i+1))}),e}clear(){this.blacks=[],this.whites=[]}remove_path(e){qe(()=>{if(e.length%2===0){let n=this.blacks;n=n.filter(i=>i.join("")!==e.join("")),this.blacks=n}else{let n=this.whites;n=n.filter(i=>i.join("")!==e.join("")),this.whites=n}})}add_path(e){qe(()=>{if(e.length%2===0){let n=this.blacks;if(n.find(r=>r.join("").startsWith(e.join(""))))return;let i=n.findIndex(r=>e.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,e):n.push(e),this.blacks=n}else{let n=this.whites;if(n.find(r=>r.join("").startsWith(e.join(""))))return;let i=n.findIndex(r=>e.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,e):n.push(e),this.whites=n}})}}const tt=class tt{constructor(e,n){_(this,"_tree");_(this,"_cursor_path");_(this,"_hidden_paths");_(this,"_revealed_paths");_(this,"_failed_paths");_(this,"_solved_paths");_(this,"reveal_hidden_paths",()=>{he(()=>{this.hidden_paths.forEach(e=>{this._revealed_paths.add_path(e)}),this._hidden_paths.clear()})});_(this,"reveal_one_random",()=>{var i,r;if(!this.tree)return!1;const e=((r=(i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))==null?void 0:r.children)??[this.tree.root],n=Cs(e);return n?(he(()=>{this._hidden_paths.remove_path(n.data.path),n.children.forEach(s=>this._hidden_paths.add_path(s.data.path)),this.cursor_path=n.data.path}),!0):!1});_(this,"try_next_uci_fail",e=>{var s,o,a;if(!this.tree)return!1;const n=((s=this.tree)==null?void 0:s._traverse_path(this.cursor_path))??this.tree.root,i=((a=(o=this.tree)==null?void 0:o._traverse_path(this.cursor_path))==null?void 0:a.children)??[this.tree.root],r=i.find(l=>l.data.uci===e)??i.find(l=>Ps(l.data)===e);if(r){if(this.failed_paths_expanded.find(c=>c.join("")===r.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return he(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(c=>this._hidden_paths.add_path(c.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(e),this._failed_paths.add_path([...n.data.path,e]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});_(this,"on_wheel",e=>{var i;let n=this.cursor_path;if(e<0)n.length>0&&this.try_set_cursor_path(n.slice(0,-1));else{let r=this.tree;if(r){let s;n.length===0?s=[r.root]:s=(i=r._traverse_path(n))==null?void 0:i.children;let o=s==null?void 0:s.map(a=>a.data.path).find(a=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>a.join("").startsWith(c.join(""))))});o&&this.try_set_cursor_path(o)}}});this.initial_fen=e,this._cursor_path=B([],{equals:!1}),this._tree=B(n),this._hidden_paths=new Ce,this._revealed_paths=new Ce,this._failed_paths=new Ce,this._solved_paths=new Ce}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths.paths}get failed_paths(){return this._failed_paths.paths}get solved_paths(){return this._solved_paths}get failed_paths_expanded(){return this._failed_paths.expand_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get initial_color(){var e;return(e=this.tree)==null?void 0:e.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(e){this._cursor_path[1](e)}set tree(e){this._tree[1](e)}get fen_last_move(){let e=this.tree;if(e){let n=e.get_at(this.cursor_path);if(!n)return;let i=n.after_fen,r=n.uci;return[i,r]}}try_set_cursor_path(e){return this.hidden_paths.find(i=>e.join("").startsWith(i.join("")))?!1:(this.cursor_path=e,!0)}get is_revealed(){return this.hidden_paths.length===0}add_uci(e){let n=this.tree,i=this.cursor_path;return n?n.append_uci(e,i):n=Je.make(this.initial_fen,[e]),i=[...i,e],he(()=>{this.tree=n,this.cursor_path=i}),i}drop_failed_paths(){}get is_next_hidden_cursor_path(){var i;let e=this.cursor_path,n=this.tree;if(n){let r;return e.length===0?r=[n.root]:r=(i=n._traverse_path(e))==null?void 0:i.children,!!(r!=null&&r.map(s=>s.data.path).find(s=>{var o;return(o=this.hidden_paths)==null?void 0:o.some(a=>s.join("").startsWith(a.join("")))}))}}get can_navigate_next(){var i;let e=this.cursor_path,n=this.tree;if(n){let r;return e.length===0?r=[n.root]:r=(i=n._traverse_path(e))==null?void 0:i.children,(r==null?void 0:r.map(o=>o.data.path).find(o=>{var a;return!((a=this.hidden_paths)!=null&&a.some(l=>o.join("").startsWith(l.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_last(){var i,r;let e=this.cursor_path,n=this.tree;if(n){let s;e.length===0?s=[n.root]:s=(i=n._traverse_path(e))==null?void 0:i.children;let o=s==null?void 0:s.map(a=>a.data.path).find(a=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>a.join("").startsWith(c.join(""))))});if(o){let a=n._traverse_path(o);for(;a.children.length>0&&!((r=this.hidden_paths)!=null&&r.some(l=>a.children[0].data.path.join("").startsWith(l.join(""))));)a=a.children[0];o=a.data.path,this.try_set_cursor_path(o)}}}navigate_next(){var i;let e=this.cursor_path,n=this.tree;if(n){let r;e.length===0?r=[n.root]:r=(i=n._traverse_path(e))==null?void 0:i.children;let s=r==null?void 0:r.map(o=>o.data.path).find(o=>{var a;return!((a=this.hidden_paths)!=null&&a.some(l=>o.join("").startsWith(l.join(""))))});s&&this.try_set_cursor_path(s)}}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_first(){this.try_set_cursor_path(this.cursor_path.slice(0,1))}};_(tt,"make",(e,n=(e==null?void 0:e.root.data.before_fen)||at)=>new tt(n,e));let St=tt;const vs=t=>{let e;return Y(()=>{let n=t.lala.cursor_path,i=e.parentElement;if(!i)return;const r=e.querySelector(".on_path_end");if(!r){i.scrollTop=n.length>0?99999:0;return}let s=r.offsetTop-i.offsetHeight/2+r.offsetHeight;i.scrollTo({behavior:"smooth",top:s})}),(()=>{var n=gs();return Ot(i=>e=i,n),G(n,O(Te,{get when(){return t.lala.tree},get fallback(){return[]},children:i=>O(Mt,{on_set_path:r=>t.lala.try_set_cursor_path(r),get cursor_path(){return t.lala.cursor_path},get hidden_paths(){return t.lala.hidden_paths},get revealed_paths(){return t.lala.revealed_paths},get solved_paths(){return t.lala.solved_paths_expanded},get failed_paths(){return t.lala.failed_paths_expanded},get lines(){return[i().root]}})})),n})()},Mt=t=>O(Yt,{get each(){return t.lines},children:e=>[O(ys,lt({get data(){return e.data}},t)),O(di,{get children(){return[O(Zt,{get when(){return e.children.length===1},get children(){return O(Mt,lt(t,{get lines(){return e.children}}))}}),O(Zt,{get when(){return e.children.length>1},get children(){var n=ws();return G(n,O(Yt,{get each(){return e.children},children:i=>(()=>{var r=bs();return G(r,O(Mt,lt(t,{lines:[i],show_index:!0}))),r})()})),n}})]}})]}),ys=t=>{let e=`${Math.ceil(t.data.ply/2)}.`;t.data.ply%2===0&&(e+="..");let n=()=>t.cursor_path.join("").startsWith(t.data.path.join("")),i=()=>t.cursor_path.join("")===t.data.path.join(""),r=t.data.path.join(""),s=()=>t.hidden_paths.find(u=>u.join("")===r),o=()=>t.hidden_paths.find(u=>r.startsWith(u.join(""))),a=()=>t.revealed_paths.find(u=>u.join("")===r),l=()=>t.revealed_paths.find(u=>r.startsWith(u.join(""))),c=()=>t.failed_paths.find(u=>u.join("")===r),f=()=>t.solved_paths.find(u=>u.join("")===r),d=()=>["move",i()?"on_path_end":n()?"on_path":"",s()?"on_hidden_path_start":o()?"on_hidden_path":"",a()?"on_revealed_path_start":l()?"on_revealed_path":"",c()?"on_failed_path":"",f()?"on_solved_path":"",t.collapsed?"collapsed":""].join(" ");return(()=>{var u=ks();return u.$$click=()=>t.on_set_path(t.data.path),G(u,O(Te,{get when(){return t.show_index||t.data.ply&1},get children(){var w=_s();return G(w,e),w}}),null),G(u,()=>t.data.san,null),He(()=>ve(u,d())),u})()};function Cs(t){let e=t.length*(t.length+1)/2,n=Math.floor(Math.random()*e)+1,i=0;for(let r=0;r<t.length;r++)if(i+=t.length-r,n<=i)return t[r]}const Ps=t=>{let e=t.uci.slice(0,2),n=t.uci[3];if(t.san==="O-O")return e+"g"+n;if(t.san==="O-O-O")return e+"c"+n};_n(["click"]);const nt=class nt{constructor(){_(this,"_add_uci");_(this,"_promotion");_(this,"_position");_(this,"m_fen");_(this,"m_dests");_(this,"m_color");_(this,"_last_move");_(this,"_on_wheel");_(this,"set_on_wheel",e=>{this._on_wheel[1](e)});_(this,"on_set_fen_uci",(e,n)=>{he(()=>{this.add_uci=void 0,this.last_move=n,this.position=Xe.fromSetup(We(e).unwrap()).unwrap()})});_(this,"reset_move_after",()=>{this.position=this.position});_(this,"on_move_after",(e,n)=>{let i=this.position.board.get(pe(e)),r=e+n;i.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(r+="q"),this.position.play(Yn(r)),he(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=n),this.add_uci=r})});this._on_wheel=B(void 0,{equals:!1}),this._last_move=B(void 0,{equals:!1}),this._add_uci=B(void 0,{equals:!1}),this._promotion=B(void 0,{equals:!1}),this._position=B(Xe.fromSetup(We(at).unwrap()).unwrap(),{equals:!1}),this.m_dests=de(()=>Zr(this.position)),this.m_fen=de(()=>ni(this.position.toSetup())),this.m_color=de(()=>this.position.turn)}get position(){return this._position[0]()}set position(e){this._position[1](e)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(e){this._promotion[1](e)}get add_uci(){return this._add_uci[0]()}set add_uci(e){this._add_uci[1](e)}get last_move(){return this._last_move[0]()}set last_move(e){this._last_move[1](e)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let e=this.fen,n=this.last_move;return[e,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};_(nt,"init",()=>new nt);let At=nt;const Es=(t,e,n,i)=>{let r=xt.make_many(t).map(s=>{var c;let o=(c=s.site)!=null&&c.includes("http")?s.site:`https://lichess.org/study/${e}`,a=s.event,l;if(a!=null&&a.includes(": "))[n,l]=a.split(": ");else{let f=s.white,d=s.black;l=`${f} vs ${d} at ${a}`}return{name:l,site:o,pgn:s}});return{name:n,orientation:i,chapters:r}},xs=(t,e,n)=>fetch(`pgns/${t}.pgn`).then(i=>i.text()).then(i=>Es(i,t,e,n)),it=class it{read_study(e){let{study_name:n,orientation:i}=As.study_by_id(e);return xs(e,n,i)}};_(it,"init",()=>new it);let Rt=it;const Ss=Rt.init(),Ms={Openings:[["Slav Defense","TCnt4Tx7","black"],["Sicilian Defense","dgldIBYr","white"],["French Defense","bLcOj6sO","black"],["e4 vs Minor Defenses","F8wyMEli","white"],["Spanish Opening",""]],Masters:[["Bobby Fischer 60 Memorable Games","6kq6sDHS"],["Magnus Carlsen 2023",""],["Tata Steel 2023",""]],Tactics:[["50 Puzzles 1600","u1600"],["50 Puzzles 2000","u2000"],["50 Puzzles 2200","u2200"]],Endgames:[["100 Endgames You Must Know",""],["King and Pawn Endgames",""]]},rt=class rt{constructor(){_(this,"all");_(this,"openings");_(this,"masters");_(this,"tactics");_(this,"endgames");_(this,"recent");_(this,"completed")}study_by_id(e){return this.all.find(i=>i.study_link===e)}};_(rt,"init",()=>{function e(i){return Ms[i].map(r=>({category:i,study_name:r[0],study_link:r[1],orientation:r[2]}))}let n=new rt;return n.openings=e("Openings"),n.masters=e("Masters"),n.tactics=e("Tactics"),n.endgames=e("Endgames"),n.all=[...n.openings,...n.masters,...n.tactics,...n.endgames],n.recent=[],n.completed=[],n});let $t=rt;const As=$t.init();var Rs=F("<span>Loading..."),$s=F("<h3>Puzzle Completed!"),Os=F("<span class=link>Continue with next puzzle."),Ns=F("<div class=home><div class=board-wrap></div><div class=replay-wrap><div class=replay><div class=replay-header><span>#1</span><span>All Puzzles</span><span>lichess</span></div><div class=replay-v></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=></button></div><div class=replay-tools></div></div></div><div class=side><div class=side-header><span class=title>Puzzle Set U1600 </span><span class=run>Run #1</span><span class=time>Total Time: 1:02:50</span></div><div class=side-tools><div class=jump-toggle><input type=checkbox id=jump-next><label for=jump-next>Jump to next puzzle immediately</label></div><div class=show-dropdown><label for=show-only>Show Only</label><select id=show-only><option value=failed>Solved Puzzles</option><option value=failed>Unseen Puzzles</option><option value=failed>Failed Puzzles</option><option value=failed>Skipped Puzzles</option></select></div></div><div class=side-list>List of Puzzles in the Set"),zs=F("<div class=info><h3><span class=turn></span> to play</h3><span>Find the best move for "),Ts=F("<span>View Solution");const Ks=()=>{let e=ui().id;console.log(e);const[n]=fi("u1600",Ss.read_study);return O(Te,{get when(){return n.loading},get fallback(){return O(Ds,{get pgn(){return n()}})},get children(){return Rs()}})},Ds=t=>{const e=pi(),[n,i]=B(!1),[r,s]=B(!1),[o,a]=B(!1),[l,c]=B(0),f=de(()=>t.pgn.chapters[l()]);c(0);const d=new At,u=de(Re(f,g=>{let y=St.make(g.pgn.tree);return y.tree.root.children.map(R=>R.data.path).forEach(R=>y._hidden_paths.add_path(R)),d.on_set_fen_uci(y.initial_fen),a(!1),setTimeout(()=>{y.cursor_path=y.tree.root.data.path,a(!0)},600),y}));Y(Re(()=>d.add_uci,g=>{if(!g)return;u().try_next_uci_fail(g)&&(s(!0),setTimeout(()=>{u().reveal_one_random(),s(!1)},600))})),Y(Re(()=>u().fen_last_move,g=>{if(g){let[y,R]=g;d.on_set_fen_uci(y,R)}else d.on_set_fen_uci(u().initial_fen)})),Y(Re(()=>{var g;return(g=u().tree)==null?void 0:g.get_at(u().cursor_path)},g=>{g&&e.move(g)}));const w=()=>{c(l()+1)},k=()=>{if(!o())return!1;u().reveal_hidden_paths()};Y(()=>{u().is_revealed&&n()&&setTimeout(()=>{w()},600)}),Y(Re(()=>d.on_wheel,g=>{r()||g&&u().on_wheel(g)}));const p=g=>{const y=g.target;y.tagName!=="PIECE"&&y.tagName!=="SQUARE"&&y.tagName!=="CG-BOARD"||(g.preventDefault(),d.set_on_wheel(Math.sign(g.deltaY)))};let E;bn(()=>{E.addEventListener("wheel",p,{passive:!1})}),mi(()=>{E.removeEventListener("wheel",p)});const A=de(()=>x(u().initial_color));return(()=>{var g=Ns(),y=g.firstChild,R=y.nextSibling,$=R.firstChild,J=$.firstChild,U=J.nextSibling,v=U.nextSibling,H=v.firstChild,D=H.nextSibling,j=D.nextSibling,oe=j.nextSibling,ri=v.nextSibling,si=R.nextSibling,oi=si.firstChild,ai=oi.nextSibling,li=ai.firstChild,Qt=li.firstChild;return Ot(C=>E=C,g),G(y,O(ms,{get orientation(){return x(u().initial_color??"white")},get movable(){return de(()=>!r()&&!u().is_revealed)()&&u().is_next_hidden_cursor_path},get doPromotion(){return d.promotion},get onMoveAfter(){return d.on_move_after},get fen_uci(){return d.fen_uci},get color(){return d.turnColor},get dests(){return d.dests}})),G(U,O(vs,{get lala(){return u()}})),H.$$click=()=>u().navigate_first(),D.$$click=()=>u().navigate_prev(),j.$$click=()=>u().navigate_next(),oe.$$click=()=>u().navigate_last(),G(ri,O(Te,{get when(){return u().is_revealed},get fallback(){return[(()=>{var C=zs(),Me=C.firstChild,Fe=Me.firstChild,Ae=Me.nextSibling;return Ae.firstChild,G(Fe,A),G(Ae,A,null),C})(),(()=>{var C=Ts();return C.$$click=()=>k(),He(()=>ve(C,"solution"+(o()?"":" fade-out"))),C})()]},get children(){return[$s(),O(Te,{get when(){return!n()},get children(){var C=Os();return C.$$click=()=>w(),C}})]}})),Qt.addEventListener("change",C=>i(C.currentTarget.checked)),He(C=>{var Me="fbt first"+(!r()&&u().can_navigate_prev?"":" disabled"),Fe="fbt prev"+(!r()&&u().can_navigate_prev?"":" disabled"),Ae="fbt next"+(!r()&&u().can_navigate_next?"":" disabled"),Vt="fbt last"+(!r()&&u().can_navigate_next?"":" disabled");return Me!==C.e&&ve(H,C.e=Me),Fe!==C.t&&ve(D,C.t=Fe),Ae!==C.a&&ve(j,C.a=Ae),Vt!==C.o&&ve(oe,C.o=Vt),C},{e:void 0,t:void 0,a:void 0,o:void 0}),He(()=>Qt.checked=n()),g})()};_n(["click"]);export{Ks as default};
