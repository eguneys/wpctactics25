var fn=Object.defineProperty;var pn=(e,t,n)=>t in e?fn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var m=(e,t,n)=>(pn(e,typeof t!="symbol"?t+"":t,n),n);import{m as ct,s as _n,o as $t,c as B,u as Re,t as x,I as He,d as Mt,i as P,a as k,S as ee,b as je,e as jt,M as he,F as dt,f as ve,g as se,h as q,j as J,k as gn,l as ut,C as ht,p as ft,n as A,q as vn,r as mn,v as bn,P as pt,w as _t,x as wn,y as oe,z as yn,A as gt,U as zt,B as kn}from"./index-Bsu4zmON.js";import{f as ze}from"./util-Dh_741V6.js";const Cn=(e,t)=>{const n=new Map,i=e.ctx();for(const[r,o]of e.allDests(i))if(o.nonEmpty()){const s=Array.from(o,ct);!(t!=null&&t.chess960)&&r===i.king&&_n(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(ct(r),s)}return n},Sn=["white","black"],Ie=["a","b","c","d","e","f","g","h"],Be=["1","2","3","4","5","6","7","8"],Pn=[...Be].reverse(),Fe=Array.prototype.concat(...Ie.map(e=>Be.map(t=>e+t))),L=e=>Fe[8*e[0]+e[1]],C=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],At=Fe.map(C);function xn(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const $n=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Ve=e=>e==="white"?"black":"white",fe=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},Ee=(e,t)=>e.role===t.role&&e.color===t.color,pe=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],I=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},qt=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},Ue=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ne=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Dt=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},V=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function Et(e,t,n){const i=C(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const te=(e,t)=>Math.abs(e-t),Mn=e=>(t,n,i,r)=>te(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),Wt=(e,t,n,i)=>{const r=te(e,n),o=te(t,i);return r===1&&o===2||r===2&&o===1},Tt=(e,t,n,i)=>te(e,n)===te(t,i),Ot=(e,t,n,i)=>e===n||t===i,Nt=(e,t,n,i)=>Tt(e,t,n,i)||Ot(e,t,n,i),jn=(e,t,n)=>(i,r,o,s)=>te(i,o)<2&&te(r,s)<2||n&&r===s&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function zn(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(C(r)[0]);return i}function Kt(e,t,n){const i=e.get(t);if(!i)return[];const r=C(t),o=i.role,s=o==="pawn"?Mn(i.color):o==="knight"?Wt:o==="bishop"?Tt:o==="rook"?Ot:o==="queen"?Nt:jn(i.color,zn(e,i.color),n);return At.filter(l=>(r[0]!==l[0]||r[1]!==l[1])&&s(r[0],r[1],l[0],l[1])).map(L)}function W(e,...t){e&&setTimeout(()=>e(...t),1)}function An(e){e.orientation=Ve(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function qn(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function Dn(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function En(e,t,n,i){Y(e),e.premovable.current=[t,n],W(e.premovable.events.set,t,n,i)}function G(e){e.premovable.current&&(e.premovable.current=void 0,W(e.premovable.events.unset))}function Wn(e,t,n){G(e),e.predroppable.current={role:t,key:n},W(e.predroppable.events.set,t,n)}function Y(e){const t=e.predroppable;t.current&&(t.current=void 0,W(t.events.unset))}function Tn(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=C(t),o=C(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=L([7,o[1]]):o[0]===2&&(n=L([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(L([6,o[1]]),i),e.pieces.set(L([5,o[1]]),s)):(e.pieces.set(L([2,o[1]]),i),e.pieces.set(L([3,o[1]]),s)),!0)}function Lt(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&R(e),W(e.events.move,t,n,o),Tn(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,W(e.events.change),o||!0}function Ze(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return W(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,W(e.events.change),e.movable.dests=void 0,e.turnColor=Ve(e.turnColor),!0}function Rt(e,t,n){const i=Lt(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=Ve(e.turnColor),e.animation.current=void 0),i}function Ht(e,t,n){if(Ge(e,t,n)){const i=Rt(e,t,n);if(i){const r=e.hold.stop();R(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),W(e.movable.events.after,t,n,o),!0}}else if(Nn(e,t,n))return En(e,t,n,{ctrlKey:e.stats.ctrlKey}),R(e),!0;return R(e),!1}function It(e,t,n,i){const r=e.pieces.get(t);r&&(On(e,t,n)||i)?(e.pieces.delete(t),Ze(e,r,n,i),W(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&Kn(e,t,n)?Wn(e,r.role,n):(G(e),Y(e)),e.pieces.delete(t),R(e)}function We(e,t,n){if(W(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){R(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&Ht(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Ft(e,t)||Ye(e,t))&&(Bt(e,t),e.hold.start())}function Bt(e,t){e.selected=t,Ye(e,t)?e.premovable.customDests||(e.premovable.dests=Kt(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function R(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Ft(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const Ge=(e,t,n)=>{var i,r;return t!==n&&Ft(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function On(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function Ye(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Nn(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:Kt(e.pieces,t,e.premovable.castle);return t!==n&&Ye(e,t)&&o.includes(n)}function Kn(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function Ln(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function Rn(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(Ge(e,n,i)){const o=Rt(e,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),W(e.movable.events.after,n,i,s),r=!0}}return G(e),r}function Hn(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};Ze(e,r,n.key)&&(W(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return Y(e),i}function Xe(e){G(e),Y(e),R(e)}function vt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Xe(e)}function ie(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?L([i,r]):void 0}function In(e,t,n,i){const r=C(e),o=At.filter(a=>Nt(r[0],r[1],a[0],a[1])||Wt(r[0],r[1],a[0],a[1])),l=o.map(a=>Et(L(a),n,i)).map(a=>fe(t,a)),[,c]=l.reduce((a,u,d)=>a[0]<u?a:[u,d],[l[0],0]);return L(o[c])}const T=e=>e.orientation==="white",Vt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Bn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Fn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Ut(e){e==="start"&&(e=Vt);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(L([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();t.set(L([i,n]),{role:Bn[s],color:r===s?"black":"white"}),++i}}}return t}function Vn(e){return Pn.map(t=>Ie.map(n=>{const i=e.get(n+t);if(i){let r=Fn[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Zt(e,t){t.animation&&(Qe(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Gt(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),Qe(e,t),t.fen&&(e.pieces=Ut(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&Dn(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Bt(e,e.selected),Zt(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,l=e.movable.dests.get(s),c=e.pieces.get(s);if(!l||!c||c.role!=="king")return;e.movable.dests.set(s,l.filter(a=>!(a==="a"+o&&l.includes("c"+o))&&!(a==="h"+o&&l.includes("g"+o))))}}function Qe(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&mt(e[n])&&mt(t[n])?Qe(e[n],t[n]):e[n]=t[n])}function mt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const Q=(e,t)=>t.animation.enabled?Gn(e,t):Z(e,t);function Z(e,t){const n=e(t);return t.dom.redraw(),n}const Ae=(e,t)=>({key:e,pos:C(e),piece:t}),Un=(e,t)=>t.sort((n,i)=>fe(e.pos,n.pos)-fe(e.pos,i.pos))[0];function Zn(e,t){const n=new Map,i=[],r=new Map,o=[],s=[],l=new Map;let c,a,u;for(const[d,f]of e)l.set(d,Ae(d,f));for(const d of Fe)c=t.pieces.get(d),a=l.get(d),c?a?Ee(c,a.piece)||(o.push(a),s.push(Ae(d,c))):s.push(Ae(d,c)):a&&o.push(a);for(const d of s)a=Un(d,o.filter(f=>Ee(d.piece,f.piece))),a&&(u=[a.pos[0]-d.pos[0],a.pos[1]-d.pos[1]],n.set(d.key,u.concat(u)),i.push(a.key));for(const d of o)i.includes(d.key)||r.set(d.key,d.piece);return{anims:n,fadings:r}}function Yt(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=Yn(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Yt(e,o))}}function Gn(e,t){const n=new Map(t.pieces),i=e(t),r=Zn(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||Yt(t,performance.now())}else t.dom.redraw();return i}const Yn=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Xn=["green","red","blue","yellow"];function Qn(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?R(e):Xe(e);const n=ne(t),i=ie(n,T(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:ni(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Xt(e))}function Xt(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=ie(t.pos,T(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?In(t.orig,t.pos,T(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),Xt(e)}})}function Jn(e,t){e.drawable.current&&(e.drawable.current.pos=ne(t))}function ei(e){const t=e.drawable.current;t&&(t.mouseSq&&ii(e.drawable,t),Qt(e))}function Qt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ti(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Jt(e.drawable))}function ni(e){var t;const n=(e.shiftKey||e.ctrlKey)&&Dt(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Xn[(n?1:0)+(i?2:0)]}function ii(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Jt(e)}function Jt(e){e.onChange&&e.onChange(e.shapes)}function ri(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=ne(t),r=ie(i,T(e),n);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&ti(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||oi(e,i)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Ge(e,e.selected,r)?Q(d=>We(d,r),e):We(e,r);const a=e.selected===r,u=tn(e,r);if(o&&u&&a&&Ln(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className=`ghost ${o.color} ${o.role}`,I(d,pe(n)(C(r),T(e))),Ue(d,!0)),Je(e)}else l&&G(e),c&&Y(e);e.dom.redraw()}function oi(e,t){const n=T(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const s=Et(o,n,i);if(fe(s,t)<=r)return!0}return!1}function si(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=ne(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>tn(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},Je(e)}function Je(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!Ee(i,n.piece))me(e);else if(!n.started&&fe(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();I(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ie(n.pos,T(e),r))}Je(e)})}function li(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ne(t))}function ai(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}G(e),Y(e);const i=ne(t)||n.pos,r=ie(i,T(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?It(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,Ht(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),W(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?R(e):e.selectable.enabled||R(e),en(e),e.draggable.current=void 0,e.dom.redraw()}function me(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,R(e),en(e),e.dom.redraw())}function en(e){const t=e.dom.elements;t.ghost&&Ue(t.ghost,!1)}function tn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function ci(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{bt(e,2),setTimeout(()=>bt(e,void 0),120)},120)}function bt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function di(e,t){function n(){An(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),Zt(e,i),(i.fen?Q:Z)(r=>Gt(r,i),e)},state:e,getFen:()=>Vn(e.pieces),toggleOrientation:n,setPieces(i){Q(r=>qn(r,i),e)},selectSquare(i,r){i?Q(o=>We(o,i,r),e):e.selected&&(R(e),e.dom.redraw())},move(i,r){Q(o=>Lt(o,i,r),e)},newPiece(i,r){Q(o=>Ze(o,i,r),e)},playPremove(){if(e.premovable.current){if(Q(Rn,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=Hn(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){Z(G,e)},cancelPredrop(){Z(Y,e)},cancelMove(){Z(i=>{Xe(i),me(i)},e)},stop(){Z(i=>{vt(i),me(i)},e)},explode(i){ci(e,i)},setAutoShapes(i){Z(r=>r.drawable.autoShapes=i,e)},setShapes(i){Z(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return ie(i,T(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){si(e,i,r,o)},destroy(){vt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function ui(){return{pieces:Ut(Vt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:$n()}}const wt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function hi(){const e=S("defs"),t=D(S("filter"),{id:"cg-filter-blur"});return t.appendChild(D(S("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function fi(e,t,n){var i;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,l=new Map,c=e.dom.bounds(),a=r.autoShapes.filter(p=>!p.piece);for(const p of r.shapes.concat(a).concat(s?[s]:[])){if(!p.dest)continue;const v=(i=l.get(p.dest))!==null&&i!==void 0?i:new Set,h=ye(we(C(p.orig),e.orientation),c),O=ye(we(C(p.dest),e.orientation),c);v.add(Oe(h,O)),l.set(p.dest,v)}const u=r.shapes.concat(a).map(p=>({shape:p,current:!1,hash:yt(p,Te(p.dest,l),!1,c)}));s&&u.push({shape:s,current:!0,hash:yt(s,Te(s.dest,l),!0,c)});const d=u.map(p=>p.hash).join(";");if(d===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=d;const f=t.querySelector("defs");pi(r,u,f),_i(u,t.querySelector("g"),n.querySelector("g"),p=>mi(e,p,r.brushes,l,c))}function pi(e,t,n){var i;const r=new Map;let o;for(const c of t.filter(a=>a.shape.dest&&a.shape.brush))o=nn(e.brushes[c.shape.brush],c.shape.modifiers),!((i=c.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(be(o).key,be(o)),r.set(o.key,o);const s=new Set;let l=n.firstElementChild;for(;l;)s.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(const[c,a]of r.entries())s.has(c)||n.appendChild(yi(a))}function _i(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const s=[];let l=o.firstElementChild,c;for(;l;)c=l.getAttribute("cgHash"),r.has(c)?r.set(c,!0):s.push(l),l=l.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function yt({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:s},l,c,a){var u,d;return[a.width,a.height,c,e,t,n,l&&"-",i&&gi(i),r&&vi(r),o&&`custom-${kt(o.html)},${(d=(u=o.center)===null||u===void 0?void 0:u[0])!==null&&d!==void 0?d:"o"}`,s&&`label-${kt(s.text)}`].filter(f=>f).join(",")}function gi(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function vi(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function kt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function mi(e,{shape:t,current:n,hash:i},r,o,s){var l,c;const a=ye(we(C(t.orig),e.orientation),s),u=t.dest?ye(we(C(t.dest),e.orientation),s):a,d=t.brush&&nn(r[t.brush],t.modifiers),f=o.get(t.dest),p=[];if(d){const v=D(S("g"),{cgHash:i});p.push({el:v}),a[0]!==u[0]||a[1]!==u[1]?v.appendChild(wi(t,d,a,u,n,Te(t.dest,o))):v.appendChild(bi(r[t.brush],a,n,s))}if(t.label){const v=t.label;(l=v.fill)!==null&&l!==void 0||(v.fill=t.brush&&r[t.brush].color);const h=t.brush?void 0:"tr";p.push({el:ki(v,i,a,u,f,h),isCustom:!0})}if(t.customSvg){const v=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[h,O]=v==="label"?on(a,u,f).map($=>$-.5):v==="dest"?u:a,E=D(S("g"),{transform:`translate(${h},${O})`,cgHash:i});E.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,p.push({el:E,isCustom:!0})}return p}function bi(e,t,n,i){const r=Ci(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return D(S("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:rn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function be(e){return["#ffffff","#fff","white"].includes(e.color)?wt.hilitePrimary:wt.hiliteWhite}function wi(e,t,n,i,r,o){var s;function l(u){var d;const f=Pi(o&&!r),p=i[0]-n[0],v=i[1]-n[1],h=Math.atan2(v,p),O=Math.cos(h)*f,E=Math.sin(h)*f;return D(S("line"),{stroke:u?be(t).color:t.color,"stroke-width":Si(t,r)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?be(t).key:t.key})`,opacity:!((d=e.modifiers)===null||d===void 0)&&d.hilite?1:rn(t,r),x1:n[0],y1:n[1],x2:i[0]-O,y2:i[1]-E})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return l(!1);const c=S("g"),a=D(S("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(xi(n,i)),a.appendChild(l(!0)),c.appendChild(a),c.appendChild(l(!1)),c}function yi(e){const t=D(S("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(D(S("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function ki(e,t,n,i,r,o){var s;const c=.4*.75**e.text.length,a=on(n,i,r),u=o==="tr"?.4:0,d=D(S("g"),{transform:`translate(${a[0]+u},${a[1]-u})`,cgHash:t});d.appendChild(D(S("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const f=D(S("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return f.innerHTML=e.text,d.appendChild(f),d}function we(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Te(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function S(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function D(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function nn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function Ci(){return[3/64,4/64]}function Si(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function rn(e,t){return(e.opacity||1)*(t?.9:1)}function Pi(e){return(e?20:10)/64}function ye(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function xi(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return D(S("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function Oe(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function $i(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function on(e,t,n){let i=$i(e,t);const r=Oe(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=Oe(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function Mi(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of Sn)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=V("cg-container");e.appendChild(n);const i=V("cg-board");n.appendChild(i);let r,o,s;if(t.drawable.visible&&(r=D(S("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(hi()),r.appendChild(S("g")),o=D(S("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(S("g")),s=V("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),t.coordinates){const c=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";n.appendChild(Ct(Be,"ranks"+c+a)),n.appendChild(Ct(Ie,"files"+c))}let l;return t.draggable.enabled&&t.draggable.showGhost&&(l=V("piece","ghost"),Ue(l,!1),n.appendChild(l)),{board:i,container:n,wrap:e,ghost:l,svg:r,customSvg:o,autoPieces:s}}function Ct(e,t){const n=V("coords",t);let i;for(const r of e)i=V("coord"),i.textContent=r,n.appendChild(i);return n}function ji(e,t){if(!e.dropmode.active)return;G(e),Y(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=ne(t),r=i&&ie(i,T(e),e.dom.bounds());r&&It(e,"a0",r)}e.dom.redraw()}function zi(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=qi(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function Ai(e,t){const n=[];if("ResizeObserver"in window||n.push(de(document.body,"chessground.resize",t)),!e.viewOnly){const i=St(e,li,Jn),r=St(e,ai,ei);for(const s of["touchmove","mousemove"])n.push(de(document,s,i));for(const s of["touchend","mouseup"])n.push(de(document,s,r));const o=()=>e.dom.bounds.clear();n.push(de(document,"scroll",o,{capture:!0,passive:!0})),n.push(de(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function de(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const qi=e=>t=>{e.draggable.current?me(e):e.drawable.current?Qt(e):t.shiftKey||Dt(t)?e.drawable.enabled&&Qn(e,t):e.viewOnly||(e.dropmode.active?ji(e,t):ri(e,t))},St=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function Di(e){const t=T(e),n=pe(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,l=o?o.plan.fadings:new Map,c=e.draggable.current,a=Wi(e),u=new Set,d=new Set,f=new Map,p=new Map;let v,h,O,E,$,H,ae,K,M,g;for(h=i.firstChild;h;){if(v=h.cgKey,sn(h))if(O=r.get(v),$=s.get(v),H=l.get(v),E=h.cgPiece,h.cgDragging&&(!c||c.orig!==v)&&(h.classList.remove("dragging"),I(h,n(C(v),t)),h.cgDragging=!1),!H&&h.cgFading&&(h.cgFading=!1,h.classList.remove("fading")),O){if($&&h.cgAnimating&&E===ue(O)){const w=C(v);w[0]+=$[2],w[1]+=$[3],h.classList.add("anim"),I(h,n(w,t))}else h.cgAnimating&&(h.cgAnimating=!1,h.classList.remove("anim"),I(h,n(C(v),t)),e.addPieceZIndex&&(h.style.zIndex=qe(C(v),t)));E===ue(O)&&(!H||!h.cgFading)?u.add(v):H&&E===ue(H)?(h.classList.add("fading"),h.cgFading=!0):De(f,E,h)}else De(f,E,h);else if(ln(h)){const w=h.className;a.get(v)===w?d.add(v):De(p,w,h)}h=h.nextSibling}for(const[w,X]of a)if(!d.has(w)){M=p.get(X),g=M&&M.pop();const j=n(C(w),t);if(g)g.cgKey=w,I(g,j);else{const N=V("square",X);N.cgKey=w,I(N,j),i.insertBefore(N,i.firstChild)}}for(const[w,X]of r)if($=s.get(w),!u.has(w))if(ae=f.get(ue(X)),K=ae&&ae.pop(),K){K.cgKey=w,K.cgFading&&(K.classList.remove("fading"),K.cgFading=!1);const j=C(w);e.addPieceZIndex&&(K.style.zIndex=qe(j,t)),$&&(K.cgAnimating=!0,K.classList.add("anim"),j[0]+=$[2],j[1]+=$[3]),I(K,n(j,t))}else{const j=ue(X),N=V("piece",j),U=C(w);N.cgPiece=j,N.cgKey=w,$&&(N.cgAnimating=!0,U[0]+=$[2],U[1]+=$[3]),I(N,n(U,t)),e.addPieceZIndex&&(N.style.zIndex=qe(U,t)),i.appendChild(N)}for(const w of f.values())xt(e,w);for(const w of p.values())xt(e,w)}function Ei(e){const t=T(e),n=pe(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(sn(i)&&!i.cgAnimating||ln(i))&&I(i,n(C(i.cgKey),t)),i=i.nextSibling}function Pt(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=s*o;r.style.width=s+"px",r.style.height=l+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",l+"px")}const sn=e=>e.tagName==="PIECE",ln=e=>e.tagName==="SQUARE";function xt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function qe(e,t){const i=e[1];return`${t?10-i:3+i}`}const ue=e=>`${e.color} ${e.role}`;function Wi(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const l of e.lastMove)F(r,l,"last-move");if(e.check&&e.highlight.check&&F(r,e.check,"check"),e.selected&&(F(r,e.selected,"selected"),e.movable.showDests)){const l=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(l)for(const a of l)F(r,a,"move-dest"+(e.pieces.has(a)?" oc":""));const c=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(c)for(const a of c)F(r,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const l of o)F(r,l,"current-premove");else e.predroppable.current&&F(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const l of s.keys)F(r,l,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((l,c)=>{F(r,c,l)}),r}function F(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function De(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function Ti(e,t,n){const i=new Map,r=[];for(const l of e)i.set(l.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const l of r)t.removeChild(l);for(const l of e)i.get(l.hash)||t.appendChild(n(l))}function Oi(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:Li(r),current:!1}));Ti(i,t,r=>Ki(e,r,e.dom.bounds()))}function Ni(e){var t;const n=T(e),i=pe(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)qt(r,i(C(r.cgKey),n),r.cgScale),r=r.nextSibling}function Ki(e,{shape:t,hash:n},i){var r,o,s;const l=t.orig,c=(r=t.piece)===null||r===void 0?void 0:r.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,u=(s=t.piece)===null||s===void 0?void 0:s.scale,d=V("piece",`${c} ${a}`);return d.setAttribute("cgHash",n),d.cgKey=l,d.cgScale=u,qt(d,pe(i)(C(l),T(e)),u),d}const Li=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function Ri(e,t){const n=ui();Gt(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=Mi(e,n),s=xn(()=>o.board.getBoundingClientRect()),l=u=>{Di(a),o.autoPieces&&Oi(a,o.autoPieces),!u&&o.svg&&fi(a,o.svg,o.customSvg)},c=()=>{Pt(a),Ei(a),o.autoPieces&&Ni(a)},a=n;return a.dom={elements:o,bounds:s,redraw:Hi(l),redrawNow:l,unbind:r},a.drawable.prevSvgHash="",Pt(a),l(!1),zi(a,c),r||(a.dom.unbind=Ai(a,c)),a.events.insert&&a.events.insert(o),a}return di(i(),i)}function Hi(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var Ii=x('<div class="is2d chessboard">');const Bi=e=>{let t,n;return $t(()=>{let i=e.color,r=e.dests,o={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:e.onMoveAfter}}};n=Ri(t,o)}),B(()=>{let i,r;e.fen_uci?[i,r]=e.fen_uci:i=He;let o=[];r&&(o.push(r.slice(0,2)),o.push(r.slice(2,4)));let s=e.movable?e.color:void 0;n.set({fen:i,lastMove:o,turnColor:e.color,movable:{color:s,dests:e.dests}})}),B(()=>{let i=e.orientation??"white";n.set({orientation:i})}),B(()=>{let i=e.doPromotion;if(i){let r=n.state.pieces.get(i);n.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),(()=>{var i=Ii();return Re(r=>t=r,i),i})()};var Fi=x("<div class=chesstree>"),Vi=x("<div class=lines>"),Ui=x("<div class=line>"),Zi=x("<span class=index>"),Gi=x("<div>");class le{constructor(){m(this,"_blacks");m(this,"_whites");this._blacks=q([],{equals:!1}),this._whites=q([],{equals:!1})}replace_all(t){this.blacks=t.blacks.slice(0),this.whites=t.whites.slice(0)}merge_dup(t){J(()=>{t.paths.forEach(n=>this.add_path(n))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(t){let n=new le;return n.blacks=t[0],n.whites=t[1],n}set blacks(t){this._blacks[1](t)}set whites(t){this._whites[1](t)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let t=[];return this.whites.forEach(n=>{for(let i=0;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),this.blacks.forEach(n=>{for(let i=1;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),t}clear(){this.blacks=[],this.whites=[]}remove_path(t){ut(()=>{if(t.length%2===0){let n=this.blacks;n=n.filter(i=>i.join("")!==t.join("")),this.blacks=n}else{let n=this.whites;n=n.filter(i=>i.join("")!==t.join("")),this.whites=n}})}add_path(t){ut(()=>{if(t.length%2===0){let n=this.blacks;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.blacks=n}else{let n=this.whites;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.whites=n}})}}const ke=class ke{constructor(t,n){m(this,"_tree");m(this,"_cursor_path");m(this,"_hidden_paths");m(this,"_revealed_paths");m(this,"_failed_paths");m(this,"_solved_paths");m(this,"reveal_hidden_paths",()=>{J(()=>{this.hidden_paths.forEach(t=>{this._revealed_paths.add_path(t)}),this._hidden_paths.clear()})});m(this,"reveal_one_random",()=>{var i,r;if(!this.tree)return!1;const t=((r=(i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))==null?void 0:r.children)??[this.tree.root],n=Qi(t);return n?(J(()=>{this._hidden_paths.remove_path(n.data.path),n.children.forEach(o=>this._hidden_paths.add_path(o.data.path)),this.cursor_path=n.data.path}),!0):!1});m(this,"try_next_uci_fail",t=>{var o,s,l;if(!this.tree)return!1;const n=((o=this.tree)==null?void 0:o._traverse_path(this.cursor_path))??this.tree.root,i=((l=(s=this.tree)==null?void 0:s._traverse_path(this.cursor_path))==null?void 0:l.children)??[this.tree.root],r=i.find(c=>c.data.uci===t)??i.find(c=>Ji(c.data)===t);if(r){if(this.failed_paths_expanded.find(a=>a.join("")===r.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return J(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this._failed_paths.add_path([...n.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});m(this,"on_wheel",t=>{var i;let n=this.cursor_path;if(t<0)n.length>0&&this.try_set_cursor_path(n.slice(0,-1));else{let r=this.tree;if(r){let o;n.length===0?o=[r.root]:o=(i=r._traverse_path(n))==null?void 0:i.children;let s=o==null?void 0:o.map(l=>l.data.path).find(l=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>l.join("").startsWith(a.join(""))))});s&&this.try_set_cursor_path(s)}}});this.initial_fen=t,this._cursor_path=q([],{equals:!1}),this._tree=q(n),this._hidden_paths=new le,this._revealed_paths=new le,this._failed_paths=new le,this._solved_paths=new le}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths.paths}get failed_paths(){return this._failed_paths.paths}get solved_paths(){return this._solved_paths}get failed_paths_expanded(){return this._failed_paths.expand_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get revealed_paths_expanded(){return this._revealed_paths.expand_paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let n=t.get_at(this.cursor_path);if(!n)return;let i=n.after_fen,r=n.uci;return[i,r]}}try_set_cursor_path(t){return this.hidden_paths.find(i=>t.join("").startsWith(i.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let n=this.tree,i=this.cursor_path;return n?n.append_uci(t,i):n=gn.make(this.initial_fen,[t]),i=[...i,t],J(()=>{this.tree=n,this.cursor_path=i}),i}drop_failed_paths(){}get is_next_hidden_cursor_path(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,!!(r!=null&&r.map(o=>o.data.path).find(o=>{var s;return(s=this.hidden_paths)==null?void 0:s.some(l=>o.join("").startsWith(l.join("")))}))}}get can_navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,(r==null?void 0:r.map(s=>s.data.path).find(s=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>s.join("").startsWith(c.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_last(){var i,r;let t=this.cursor_path,n=this.tree;if(n){let o;t.length===0?o=[n.root]:o=(i=n._traverse_path(t))==null?void 0:i.children;let s=o==null?void 0:o.map(l=>l.data.path).find(l=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>l.join("").startsWith(a.join(""))))});if(s){let l=n._traverse_path(s);for(;l.children.length>0&&!((r=this.hidden_paths)!=null&&r.some(c=>l.children[0].data.path.join("").startsWith(c.join(""))));)l=l.children[0];s=l.data.path,this.try_set_cursor_path(s)}}}navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children;let o=r==null?void 0:r.map(s=>s.data.path).find(s=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>s.join("").startsWith(c.join(""))))});o&&this.try_set_cursor_path(o)}}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_first(){this.try_set_cursor_path(this.cursor_path.slice(0,1))}};m(ke,"make",(t,n=(t==null?void 0:t.root.data.before_fen)||He)=>new ke(n,t));let Ne=ke;const Yi=e=>{let t;return B(()=>{let n=e.lala.cursor_path,i=t.parentElement;if(!i)return;const r=t.querySelector(".on_path_end");if(!r){i.scrollTop=n.length>0?99999:0;return}let o=r.offsetTop-i.offsetHeight/2+r.offsetHeight;i.scrollTo({behavior:"smooth",top:o})}),(()=>{var n=Fi();return Re(i=>t=i,n),P(n,k(ee,{get when(){return e.lala.tree},get fallback(){return[]},children:i=>k(Ke,{on_set_path:r=>e.lala.try_set_cursor_path(r),get cursor_path(){return e.lala.cursor_path},get hidden_paths(){return e.lala.hidden_paths},get revealed_paths(){return e.lala.revealed_paths},get solved_paths(){return e.lala.solved_paths_expanded},get failed_paths(){return e.lala.failed_paths_expanded},get lines(){return[i().root]}})})),n})()},Ke=e=>k(dt,{get each(){return e.lines},children:t=>[k(Xi,je({get data(){return t.data}},e)),k(jt,{get children(){return[k(he,{get when(){return t.children.length===1},get children(){return k(Ke,je(e,{get lines(){return t.children}}))}}),k(he,{get when(){return t.children.length>1},get children(){var n=Vi();return P(n,k(dt,{get each(){return t.children},children:i=>(()=>{var r=Ui();return P(r,k(Ke,je(e,{lines:[i],show_index:!0}))),r})()})),n}})]}})]}),Xi=e=>{let t=`${Math.ceil(e.data.ply/2)}.`;e.data.ply%2===0&&(t+="..");let n=()=>e.cursor_path.join("").startsWith(e.data.path.join("")),i=()=>e.cursor_path.join("")===e.data.path.join(""),r=e.data.path.join(""),o=()=>e.hidden_paths.find(f=>f.join("")===r),s=()=>e.hidden_paths.find(f=>r.startsWith(f.join(""))),l=()=>e.revealed_paths.find(f=>f.join("")===r),c=()=>e.revealed_paths.find(f=>r.startsWith(f.join(""))),a=()=>e.failed_paths.find(f=>f.join("")===r),u=()=>e.solved_paths.find(f=>f.join("")===r),d=()=>["move",i()?"on_path_end":n()?"on_path":"",o()?"on_hidden_path_start":s()?"on_hidden_path":"",l()?"on_revealed_path_start":c()?"on_revealed_path":"",a()?"on_failed_path":"",u()?"on_solved_path":"",e.collapsed?"collapsed":""].join(" ");return(()=>{var f=Gi();return f.$$click=()=>e.on_set_path(e.data.path),P(f,k(ee,{get when(){return e.show_index||e.data.ply&1},get children(){var p=Zi();return P(p,t),p}}),null),P(f,()=>e.data.san,null),ve(()=>se(f,d())),f})()};function Qi(e){let t=e.length*(e.length+1)/2,n=Math.floor(Math.random()*t)+1,i=0;for(let r=0;r<e.length;r++)if(i+=e.length-r,n<=i)return e[r]}const Ji=e=>{let t=e.uci.slice(0,2),n=e.uci[3];if(e.san==="O-O")return t+"g"+n;if(e.san==="O-O-O")return t+"c"+n};Mt(["click"]);const Ce=class Ce{constructor(){m(this,"_add_uci");m(this,"_promotion");m(this,"_position");m(this,"m_fen");m(this,"m_dests");m(this,"m_color");m(this,"_last_move");m(this,"_on_wheel");m(this,"set_on_wheel",t=>{this._on_wheel[1](t)});m(this,"on_set_fen_uci",(t,n)=>{J(()=>{this.add_uci=void 0,this.last_move=n,this.position=ht.fromSetup(ft(t).unwrap()).unwrap()})});m(this,"reset_move_after",()=>{this.position=this.position});m(this,"on_move_after",(t,n)=>{let i=this.position.board.get(mn(t)),r=t+n;i.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(r+="q"),this.position.play(bn(r)),J(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=n),this.add_uci=r})});this._on_wheel=q(void 0,{equals:!1}),this._last_move=q(void 0,{equals:!1}),this._add_uci=q(void 0,{equals:!1}),this._promotion=q(void 0,{equals:!1}),this._position=q(ht.fromSetup(ft(He).unwrap()).unwrap(),{equals:!1}),this.m_dests=A(()=>Cn(this.position)),this.m_fen=A(()=>vn(this.position.toSetup())),this.m_color=A(()=>this.position.turn)}get position(){return this._position[0]()}set position(t){this._position[1](t)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(t){this._promotion[1](t)}get add_uci(){return this._add_uci[0]()}set add_uci(t){this._add_uci[1](t)}get last_move(){return this._last_move[0]()}set last_move(t){this._last_move[1](t)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let t=this.fen,n=this.last_move;return[t,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};m(Ce,"init",()=>new Ce);let Le=Ce;var er=x("<span>Loading..."),tr=x("<span>Failed loading PGNs.."),nr=x("<h3>Puzzle Completed!"),ir=x("<h4>"),rr=x("<span class=success>solved +1"),or=x("<span class=success>failed +1"),sr=x("<span class=success>skipped +1"),lr=x("<span class=link>Continue with next puzzle."),ar=x("<div class=home><div class=board-wrap></div><div class=replay-wrap><div class=replay><div class=replay-header><span>#</span><span>All Puzzles</span><span>lichess</span></div><div class=replay-v></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=></button></div><div class=replay-tools></div></div></div><div class=side><div class=side-header><span class=title>Set: </span><span class=run>Run: #</span><span class=time>Total Time: </span></div><div class=side-tools><div class=jump-toggle><input type=checkbox id=jump-next><label for=jump-next>Jump to next puzzle immediately</label></div><div class=show-dropdown><label for=show-only>Show Only</label><select id=show-only><option value=failed>Solved Puzzles</option><option value=failed>Unseen Puzzles</option><option value=failed>Failed Puzzles</option><option value=failed>Skipped Puzzles</option></select></div></div><div class=side-list>List of Puzzles in the Set"),cr=x("<div class=info><h3><span class=turn></span> to play</h3><span>Find the best move for </span><h4>"),dr=x("<span>View Solution");const _r=()=>{let e=pt.active_user??pt.anonymous_user;const[t]=_t(()=>zt.get_or_create_active_run_for_user(e)),n=A(()=>{var r;return(r=t())==null?void 0:r.set_id}),[i]=_t(n,r=>kn.get_study_by_id(r));return k(ee,{get when(){return i.loading},get fallback(){return k(ee,{get when(){return i.error},get fallback(){return k(ee,{get when(){return A(()=>!!i())()&&!!t()},get children(){return k(ur,{get pgn(){return i()},get run(){return t()}})}})},get children(){return tr()}})},get children(){return er()}})},ur=e=>{const[t,n]=q(e.run,{equals:!1}),i=()=>e.pgn;let r;const[o,s]=q(0),l=A(()=>[...Array(e.pgn.chapters.length).keys()]),c=A(()=>t().solved),a=A(()=>t().failed),u=A(()=>t().skipped),d=A(()=>{let _=[...c(),...a(),...u()];return l().filter(y=>!_.includes(y))}),f=wn(),[p,v]=q(!1),[h,O]=q(!1),[E,$]=q(!1),[H,ae]=q(d()[0]),K=A(()=>e.pgn.chapters[H()]),M=new Le,g=A(oe(K,_=>{let y=Ne.make(_.pgn.tree);return y.tree.root.children.map(z=>z.data.path).forEach(z=>y._hidden_paths.add_path(z)),M.on_set_fen_uci(y.initial_fen),$(!1),s(0),setTimeout(()=>{y.cursor_path=y.tree.root.data.path,$(!0),r=setInterval(()=>s(o()+1e3),1e3)},600),y}));B(oe(()=>M.add_uci,_=>{if(!_)return;g().try_next_uci_fail(_)&&(O(!0),setTimeout(()=>{g().reveal_one_random(),O(!1)},600))})),B(oe(()=>g().fen_last_move,_=>{if(_){let[y,z]=_;M.on_set_fen_uci(y,z)}else M.on_set_fen_uci(g().initial_fen)})),B(oe(()=>{var _;return(_=g().tree)==null?void 0:_.get_at(g().cursor_path)},_=>{_&&f.move(_)}));const w=()=>{ae(H()+1)},X=()=>{if(!E())return!1;g().reveal_hidden_paths()};B(()=>{g().is_revealed&&p()&&setTimeout(()=>{w()},600)});let j=A(()=>{if(g().is_revealed){let _=g().failed_paths_expanded.length>0,y=g().revealed_paths_expanded.length>0;return _?"failed":y?"revealed":"solved"}return"thinking"});B(oe(j,_=>{let y=H(),z=t();_==="failed"?z.failed.push(y):_==="revealed"?z.skipped.push(y):_==="solved"&&z.solved.push(y),z.elapsed_ms+=o(),zt._save_run(z),clearInterval(r),n(z)})),B(oe(()=>M.on_wheel,_=>{h()||_&&g().on_wheel(_)}));const N=_=>{const y=_.target;y.tagName!=="PIECE"&&y.tagName!=="SQUARE"&&y.tagName!=="CG-BOARD"||(_.preventDefault(),M.set_on_wheel(Math.sign(_.deltaY)))};let U;$t(()=>{U.addEventListener("wheel",N,{passive:!1})}),yn(()=>{U.removeEventListener("wheel",N)});const et=A(()=>gt(g().initial_color));return(()=>{var _=ar(),y=_.firstChild,z=y.nextSibling,an=z.firstChild,tt=an.firstChild,nt=tt.firstChild;nt.firstChild;var it=tt.nextSibling,rt=it.nextSibling,Se=rt.firstChild,Pe=Se.nextSibling,xe=Pe.nextSibling,ot=xe.nextSibling,cn=rt.nextSibling,dn=z.nextSibling,st=dn.firstChild,$e=st.firstChild;$e.firstChild;var Me=$e.nextSibling;Me.firstChild;var lt=Me.nextSibling;lt.firstChild;var un=st.nextSibling,hn=un.firstChild,at=hn.firstChild;return Re(b=>U=b,_),P(y,k(Bi,{get orientation(){return gt(g().initial_color??"white")},get movable(){return A(()=>!h()&&!g().is_revealed)()&&g().is_next_hidden_cursor_path},get doPromotion(){return M.promotion},get onMoveAfter(){return M.on_move_after},get fen_uci(){return M.fen_uci},get color(){return M.turnColor},get dests(){return M.dests}})),P(nt,()=>H()+1,null),P(it,k(Yi,{get lala(){return g()}})),Se.$$click=()=>g().navigate_first(),Pe.$$click=()=>g().navigate_prev(),xe.$$click=()=>g().navigate_next(),ot.$$click=()=>g().navigate_last(),P(cn,k(ee,{get when(){return g().is_revealed},get fallback(){return[(()=>{var b=cr(),ce=b.firstChild,_e=ce.firstChild,re=ce.nextSibling;re.firstChild;var ge=re.nextSibling;return P(_e,et),P(re,et,null),P(ge,()=>ze(o(),!1)),b})(),(()=>{var b=dr();return b.$$click=()=>X(),ve(()=>se(b,"solution"+(E()?"":" fade-out"))),b})()]},get children(){return[nr(),(()=>{var b=ir();return P(b,()=>ze(o(),!1)),b})(),k(jt,{get children(){return[k(he,{get when(){return j()==="solved"},get children(){return rr()}}),k(he,{get when(){return j()==="failed"},get children(){return or()}}),k(he,{get when(){return j()==="revealed"},get children(){return sr()}})]}}),k(ee,{get when(){return!p()},get children(){var b=lr();return b.$$click=()=>w(),b}})]}})),P($e,()=>i().name,null),P(Me,()=>t().no,null),P(lt,()=>ze(t().elapsed_ms),null),at.addEventListener("change",b=>v(b.currentTarget.checked)),ve(b=>{var ce="fbt first"+(!h()&&g().can_navigate_prev?"":" disabled"),_e="fbt prev"+(!h()&&g().can_navigate_prev?"":" disabled"),re="fbt next"+(!h()&&g().can_navigate_next?"":" disabled"),ge="fbt last"+(!h()&&g().can_navigate_next?"":" disabled");return ce!==b.e&&se(Se,b.e=ce),_e!==b.t&&se(Pe,b.t=_e),re!==b.a&&se(xe,b.a=re),ge!==b.o&&se(ot,b.o=ge),b},{e:void 0,t:void 0,a:void 0,o:void 0}),ve(()=>at.checked=p()),_})()};Mt(["click"]);export{_r as default};
