var Gn=Object.defineProperty;var Zn=(e,t,n)=>t in e?Gn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var $=(e,t,n)=>(Zn(e,typeof t!="symbol"?t+"":t,n),n);import{m as Et,s as Yn,o as Jt,c as U,u as rt,t as C,I as ot,d as en,i as b,a as w,S as L,b as Be,e as tn,M as ye,F as Ze,f as k,g as he,h as oe,j as E,k as ee,l as Xn,n as Tt,C as Wt,p as Ot,q as Qn,r as Jn,v as ei,P as ze,w as Nt,x as ti,y as Q,z as ni,A as Rt,B as Fe,U as Ye,D as ii}from"./index-D66NgmRw.js";import{S as Kt,f as Me}from"./session_store-CgU1Qj2R.js";const ri=(e,t)=>{const n=new Map,i=e.ctx();for(const[r,o]of e.allDests(i))if(o.nonEmpty()){const l=Array.from(o,Et);!(t!=null&&t.chess960)&&r===i.king&&Yn(r)===4&&(o.has(0)?l.push("c1"):o.has(56)&&l.push("c8"),o.has(7)?l.push("g1"):o.has(63)&&l.push("g8")),n.set(Et(r),l)}return n},oi=["white","black"],lt=["a","b","c","d","e","f","g","h"],st=["1","2","3","4","5","6","7","8"],li=[...st].reverse(),at=Array.prototype.concat(...lt.map(e=>st.map(t=>e+t))),I=e=>at[8*e[0]+e[1]],P=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],nn=at.map(P);function si(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const ai=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},ct=e=>e==="white"?"black":"white",$e=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},Xe=(e,t)=>e.role===t.role&&e.color===t.color,Se=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],V=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},rn=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},dt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ae=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},on=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},Y=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function ln(e,t,n){const i=P(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const se=(e,t)=>Math.abs(e-t),ci=e=>(t,n,i,r)=>se(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),sn=(e,t,n,i)=>{const r=se(e,n),o=se(t,i);return r===1&&o===2||r===2&&o===1},an=(e,t,n,i)=>se(e,n)===se(t,i),cn=(e,t,n,i)=>e===n||t===i,dn=(e,t,n,i)=>an(e,t,n,i)||cn(e,t,n,i),di=(e,t,n)=>(i,r,o,l)=>se(i,o)<2&&se(r,l)<2||n&&r===l&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function ui(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(P(r)[0]);return i}function un(e,t,n){const i=e.get(t);if(!i)return[];const r=P(t),o=i.role,l=o==="pawn"?ci(i.color):o==="knight"?sn:o==="bishop"?an:o==="rook"?cn:o==="queen"?dn:di(i.color,ui(e,i.color),n);return nn.filter(s=>(r[0]!==s[0]||r[1]!==s[1])&&l(r[0],r[1],s[0],s[1])).map(I)}function R(e,...t){e&&setTimeout(()=>e(...t),1)}function hi(e){e.orientation=ct(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function fi(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function pi(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function _i(e,t,n,i){ne(e),e.premovable.current=[t,n],R(e.premovable.events.set,t,n,i)}function te(e){e.premovable.current&&(e.premovable.current=void 0,R(e.premovable.events.unset))}function gi(e,t,n){te(e),e.predroppable.current={role:t,key:n},R(e.predroppable.events.set,t,n)}function ne(e){const t=e.predroppable;t.current&&(t.current=void 0,R(t.events.unset))}function vi(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=P(t),o=P(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=I([7,o[1]]):o[0]===2&&(n=I([0,o[1]])));const l=e.pieces.get(n);return!l||l.color!==i.color||l.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(I([6,o[1]]),i),e.pieces.set(I([5,o[1]]),l)):(e.pieces.set(I([2,o[1]]),i),e.pieces.set(I([3,o[1]]),l)),!0)}function hn(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&B(e),R(e.events.move,t,n,o),vi(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,R(e.events.change),o||!0}function ut(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return R(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,R(e.events.change),e.movable.dests=void 0,e.turnColor=ct(e.turnColor),!0}function fn(e,t,n){const i=hn(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=ct(e.turnColor),e.animation.current=void 0),i}function pn(e,t,n){if(ht(e,t,n)){const i=fn(e,t,n);if(i){const r=e.hold.stop();B(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),R(e.movable.events.after,t,n,o),!0}}else if(bi(e,t,n))return _i(e,t,n,{ctrlKey:e.stats.ctrlKey}),B(e),!0;return B(e),!1}function _n(e,t,n,i){const r=e.pieces.get(t);r&&(mi(e,t,n)||i)?(e.pieces.delete(t),ut(e,r,n,i),R(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&wi(e,t,n)?gi(e,r.role,n):(te(e),ne(e)),e.pieces.delete(t),B(e)}function Qe(e,t,n){if(R(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){B(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&pn(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(vn(e,t)||ft(e,t))&&(gn(e,t),e.hold.start())}function gn(e,t){e.selected=t,ft(e,t)?e.premovable.customDests||(e.premovable.dests=un(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function B(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function vn(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const ht=(e,t,n)=>{var i,r;return t!==n&&vn(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function mi(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function ft(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function bi(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:un(e.pieces,t,e.premovable.castle);return t!==n&&ft(e,t)&&o.includes(n)}function wi(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function ki(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function yi(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(ht(e,n,i)){const o=fn(e,n,i);if(o){const l={premove:!0};o!==!0&&(l.captured=o),R(e.movable.events.after,n,i,l),r=!0}}return te(e),r}function $i(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};ut(e,r,n.key)&&(R(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return ne(e),i}function pt(e){te(e),ne(e),B(e)}function Lt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,pt(e)}function ce(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?I([i,r]):void 0}function Si(e,t,n,i){const r=P(e),o=nn.filter(a=>dn(r[0],r[1],a[0],a[1])||sn(r[0],r[1],a[0],a[1])),s=o.map(a=>ln(I(a),n,i)).map(a=>$e(t,a)),[,c]=s.reduce((a,h,u)=>a[0]<h?a:[h,u],[s[0],0]);return I(o[c])}const K=e=>e.orientation==="white",mn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ci={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},xi={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function bn(e){e==="start"&&(e=mn);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(I([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const l=r.toLowerCase();t.set(I([i,n]),{role:Ci[l],color:r===l?"black":"white"}),++i}}}return t}function Pi(e){return li.map(t=>lt.map(n=>{const i=e.get(n+t);if(i){let r=xi[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function wn(e,t){t.animation&&(_t(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function kn(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),_t(e,t),t.fen&&(e.pieces=bn(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&pi(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&gn(e,e.selected),wn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",l="e"+o,s=e.movable.dests.get(l),c=e.pieces.get(l);if(!s||!c||c.role!=="king")return;e.movable.dests.set(l,s.filter(a=>!(a==="a"+o&&s.includes("c"+o))&&!(a==="h"+o&&s.includes("g"+o))))}}function _t(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&Ht(e[n])&&Ht(t[n])?_t(e[n],t[n]):e[n]=t[n])}function Ht(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const le=(e,t)=>t.animation.enabled?ji(e,t):J(e,t);function J(e,t){const n=e(t);return t.dom.redraw(),n}const Ue=(e,t)=>({key:e,pos:P(e),piece:t}),Mi=(e,t)=>t.sort((n,i)=>$e(e.pos,n.pos)-$e(e.pos,i.pos))[0];function zi(e,t){const n=new Map,i=[],r=new Map,o=[],l=[],s=new Map;let c,a,h;for(const[u,p]of e)s.set(u,Ue(u,p));for(const u of at)c=t.pieces.get(u),a=s.get(u),c?a?Xe(c,a.piece)||(o.push(a),l.push(Ue(u,c))):l.push(Ue(u,c)):a&&o.push(a);for(const u of l)a=Mi(u,o.filter(p=>Xe(u.piece,p.piece))),a&&(h=[a.pos[0]-u.pos[0],a.pos[1]-u.pos[1]],n.set(u.key,h.concat(h)),i.push(a.key));for(const u of o)i.includes(u.key)||r.set(u.key,u.piece);return{anims:n,fadings:r}}function yn(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=Ai(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>yn(e,o))}}function ji(e,t){const n=new Map(t.pieces),i=e(t),r=zi(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||yn(t,performance.now())}else t.dom.redraw();return i}const Ai=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,qi=["green","red","blue","yellow"];function Di(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?B(e):pt(e);const n=ae(t),i=ce(n,K(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:Oi(t),snapToValidMove:e.drawable.defaultSnapToValidMove},$n(e))}function $n(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=ce(t.pos,K(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?Si(t.orig,t.pos,K(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),$n(e)}})}function Ei(e,t){e.drawable.current&&(e.drawable.current.pos=ae(t))}function Ti(e){const t=e.drawable.current;t&&(t.mouseSq&&Ni(e.drawable,t),Sn(e))}function Sn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Wi(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Cn(e.drawable))}function Oi(e){var t;const n=(e.shiftKey||e.ctrlKey)&&on(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return qi[(n?1:0)+(i?2:0)]}function Ni(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Cn(e)}function Cn(e){e.onChange&&e.onChange(e.shapes)}function Ri(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=ae(t),r=ce(i,K(e),n);if(!r)return;const o=e.pieces.get(r),l=e.selected;if(!l&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Wi(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||l||Ki(e,i)))t.preventDefault();else if(t.touches)return;const s=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&ht(e,e.selected,r)?le(u=>Qe(u,r),e):Qe(e,r);const a=e.selected===r,h=Pn(e,r);if(o&&h&&a&&ki(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:l,originTarget:t.target,keyHasChanged:!1},h.cgDragging=!0,h.classList.add("dragging");const u=e.dom.elements.ghost;u&&(u.className=`ghost ${o.color} ${o.role}`,V(u,Se(n)(P(r),K(e))),dt(u,!0)),gt(e)}else s&&te(e),c&&ne(e);e.dom.redraw()}function Ki(e,t){const n=K(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const l=ln(o,n,i);if($e(l,t)<=r)return!0}return!1}function Li(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=ae(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>Pn(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},gt(e)}function gt(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!Xe(i,n.piece))je(e);else if(!n.started&&$e(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();V(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ce(n.pos,K(e),r))}gt(e)})}function Hi(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ae(t))}function Ii(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}te(e),ne(e);const i=ae(t)||n.pos,r=ce(i,K(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?_n(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,pn(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),R(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?B(e):e.selectable.enabled||B(e),xn(e),e.draggable.current=void 0,e.dom.redraw()}function je(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,B(e),xn(e),e.dom.redraw())}function xn(e){const t=e.dom.elements;t.ghost&&dt(t.ghost,!1)}function Pn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Bi(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{It(e,2),setTimeout(()=>It(e,void 0),120)},120)}function It(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Fi(e,t){function n(){hi(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),wn(e,i),(i.fen?le:J)(r=>kn(r,i),e)},state:e,getFen:()=>Pi(e.pieces),toggleOrientation:n,setPieces(i){le(r=>fi(r,i),e)},selectSquare(i,r){i?le(o=>Qe(o,i,r),e):e.selected&&(B(e),e.dom.redraw())},move(i,r){le(o=>hn(o,i,r),e)},newPiece(i,r){le(o=>ut(o,i,r),e)},playPremove(){if(e.premovable.current){if(le(yi,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=$i(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){J(te,e)},cancelPredrop(){J(ne,e)},cancelMove(){J(i=>{pt(i),je(i)},e)},stop(){J(i=>{Lt(i),je(i)},e)},explode(i){Bi(e,i)},setAutoShapes(i){J(r=>r.drawable.autoShapes=i,e)},setShapes(i){J(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return ce(i,K(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){Li(e,i,r,o)},destroy(){Lt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ui(){return{pieces:bn(mn),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:ai()}}const Bt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Vi(){const e=j("defs"),t=O(j("filter"),{id:"cg-filter-blur"});return t.appendChild(O(j("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Gi(e,t,n){var i;const r=e.drawable,o=r.current,l=o&&o.mouseSq?o:void 0,s=new Map,c=e.dom.bounds(),a=r.autoShapes.filter(v=>!v.piece);for(const v of r.shapes.concat(a).concat(l?[l]:[])){if(!v.dest)continue;const m=(i=s.get(v.dest))!==null&&i!==void 0?i:new Set,_=De(qe(P(v.orig),e.orientation),c),T=De(qe(P(v.dest),e.orientation),c);m.add(et(_,T)),s.set(v.dest,m)}const h=r.shapes.concat(a).map(v=>({shape:v,current:!1,hash:Ft(v,Je(v.dest,s),!1,c)}));l&&h.push({shape:l,current:!0,hash:Ft(l,Je(l.dest,s),!0,c)});const u=h.map(v=>v.hash).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const p=t.querySelector("defs");Zi(r,h,p),Yi(h,t.querySelector("g"),n.querySelector("g"),v=>Ji(e,v,r.brushes,s,c))}function Zi(e,t,n){var i;const r=new Map;let o;for(const c of t.filter(a=>a.shape.dest&&a.shape.brush))o=Mn(e.brushes[c.shape.brush],c.shape.modifiers),!((i=c.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(Ae(o).key,Ae(o)),r.set(o.key,o);const l=new Set;let s=n.firstElementChild;for(;s;)l.add(s.getAttribute("cgKey")),s=s.nextElementSibling;for(const[c,a]of r.entries())l.has(c)||n.appendChild(nr(a))}function Yi(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const l=[];let s=o.firstElementChild,c;for(;s;)c=s.getAttribute("cgHash"),r.has(c)?r.set(c,!0):l.push(s),s=s.nextElementSibling;for(const a of l)o.removeChild(a)}for(const o of e.filter(l=>!r.get(l.hash)))for(const l of i(o))l.isCustom?n.appendChild(l.el):t.appendChild(l.el)}function Ft({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:l},s,c,a){var h,u;return[a.width,a.height,c,e,t,n,s&&"-",i&&Xi(i),r&&Qi(r),o&&`custom-${Ut(o.html)},${(u=(h=o.center)===null||h===void 0?void 0:h[0])!==null&&u!==void 0?u:"o"}`,l&&`label-${Ut(l.text)}`].filter(p=>p).join(",")}function Xi(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Qi(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Ut(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function Ji(e,{shape:t,current:n,hash:i},r,o,l){var s,c;const a=De(qe(P(t.orig),e.orientation),l),h=t.dest?De(qe(P(t.dest),e.orientation),l):a,u=t.brush&&Mn(r[t.brush],t.modifiers),p=o.get(t.dest),v=[];if(u){const m=O(j("g"),{cgHash:i});v.push({el:m}),a[0]!==h[0]||a[1]!==h[1]?m.appendChild(tr(t,u,a,h,n,Je(t.dest,o))):m.appendChild(er(r[t.brush],a,n,l))}if(t.label){const m=t.label;(s=m.fill)!==null&&s!==void 0||(m.fill=t.brush&&r[t.brush].color);const _=t.brush?void 0:"tr";v.push({el:ir(m,i,a,h,p,_),isCustom:!0})}if(t.customSvg){const m=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[_,T]=m==="label"?jn(a,h,p).map(W=>W-.5):m==="dest"?h:a,A=O(j("g"),{transform:`translate(${_},${T})`,cgHash:i});A.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,v.push({el:A,isCustom:!0})}return v}function er(e,t,n,i){const r=rr(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return O(j("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:zn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function Ae(e){return["#ffffff","#fff","white"].includes(e.color)?Bt.hilitePrimary:Bt.hiliteWhite}function tr(e,t,n,i,r,o){var l;function s(h){var u;const p=lr(o&&!r),v=i[0]-n[0],m=i[1]-n[1],_=Math.atan2(m,v),T=Math.cos(_)*p,A=Math.sin(_)*p;return O(j("line"),{stroke:h?Ae(t).color:t.color,"stroke-width":or(t,r)+(h?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${h?Ae(t).key:t.key})`,opacity:!((u=e.modifiers)===null||u===void 0)&&u.hilite?1:zn(t,r),x1:n[0],y1:n[1],x2:i[0]-T,y2:i[1]-A})}if(!(!((l=e.modifiers)===null||l===void 0)&&l.hilite))return s(!1);const c=j("g"),a=O(j("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(sr(n,i)),a.appendChild(s(!0)),c.appendChild(a),c.appendChild(s(!1)),c}function nr(e){const t=O(j("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(O(j("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function ir(e,t,n,i,r,o){var l;const c=.4*.75**e.text.length,a=jn(n,i,r),h=o==="tr"?.4:0,u=O(j("g"),{transform:`translate(${a[0]+h},${a[1]-h})`,cgHash:t});u.appendChild(O(j("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(l=e.fill)!==null&&l!==void 0?l:"#666",stroke:"white"}));const p=O(j("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return p.innerHTML=e.text,u.appendChild(p),u}function qe(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Je(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function j(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function O(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function Mn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function rr(){return[3/64,4/64]}function or(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function zn(e,t){return(e.opacity||1)*(t?.9:1)}function lr(e){return(e?20:10)/64}function De(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function sr(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return O(j("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function et(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function ar(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function jn(e,t,n){let i=ar(e,t);const r=et(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=et(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function cr(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of oi)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=Y("cg-container");e.appendChild(n);const i=Y("cg-board");n.appendChild(i);let r,o,l;if(t.drawable.visible&&(r=O(j("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(Vi()),r.appendChild(j("g")),o=O(j("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(j("g")),l=Y("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(l)),t.coordinates){const c=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";n.appendChild(Vt(st,"ranks"+c+a)),n.appendChild(Vt(lt,"files"+c))}let s;return t.draggable.enabled&&t.draggable.showGhost&&(s=Y("piece","ghost"),dt(s,!1),n.appendChild(s)),{board:i,container:n,wrap:e,ghost:s,svg:r,customSvg:o,autoPieces:l}}function Vt(e,t){const n=Y("coords",t);let i;for(const r of e)i=Y("coord"),i.textContent=r,n.appendChild(i);return n}function dr(e,t){if(!e.dropmode.active)return;te(e),ne(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=ae(t),r=i&&ce(i,K(e),e.dom.bounds());r&&_n(e,"a0",r)}e.dom.redraw()}function ur(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=fr(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function hr(e,t){const n=[];if("ResizeObserver"in window||n.push(we(document.body,"chessground.resize",t)),!e.viewOnly){const i=Gt(e,Hi,Ei),r=Gt(e,Ii,Ti);for(const l of["touchmove","mousemove"])n.push(we(document,l,i));for(const l of["touchend","mouseup"])n.push(we(document,l,r));const o=()=>e.dom.bounds.clear();n.push(we(document,"scroll",o,{capture:!0,passive:!0})),n.push(we(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function we(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const fr=e=>t=>{e.draggable.current?je(e):e.drawable.current?Sn(e):t.shiftKey||on(t)?e.drawable.enabled&&Di(e,t):e.viewOnly||(e.dropmode.active?dr(e,t):Ri(e,t))},Gt=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function pr(e){const t=K(e),n=Se(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,l=o?o.plan.anims:new Map,s=o?o.plan.fadings:new Map,c=e.draggable.current,a=gr(e),h=new Set,u=new Set,p=new Map,v=new Map;let m,_,T,A,W,G,pe,q,de,ie;for(_=i.firstChild;_;){if(m=_.cgKey,An(_))if(T=r.get(m),W=l.get(m),G=s.get(m),A=_.cgPiece,_.cgDragging&&(!c||c.orig!==m)&&(_.classList.remove("dragging"),V(_,n(P(m),t)),_.cgDragging=!1),!G&&_.cgFading&&(_.cgFading=!1,_.classList.remove("fading")),T){if(W&&_.cgAnimating&&A===ke(T)){const x=P(m);x[0]+=W[2],x[1]+=W[3],_.classList.add("anim"),V(_,n(x,t))}else _.cgAnimating&&(_.cgAnimating=!1,_.classList.remove("anim"),V(_,n(P(m),t)),e.addPieceZIndex&&(_.style.zIndex=Ve(P(m),t)));A===ke(T)&&(!G||!_.cgFading)?h.add(m):G&&A===ke(G)?(_.classList.add("fading"),_.cgFading=!0):Ge(p,A,_)}else Ge(p,A,_);else if(qn(_)){const x=_.className;a.get(m)===x?u.add(m):Ge(v,x,_)}_=_.nextSibling}for(const[x,X]of a)if(!u.has(x)){de=v.get(X),ie=de&&de.pop();const z=n(P(x),t);if(ie)ie.cgKey=x,V(ie,z);else{const D=Y("square",X);D.cgKey=x,V(D,z),i.insertBefore(D,i.firstChild)}}for(const[x,X]of r)if(W=l.get(x),!h.has(x))if(pe=p.get(ke(X)),q=pe&&pe.pop(),q){q.cgKey=x,q.cgFading&&(q.classList.remove("fading"),q.cgFading=!1);const z=P(x);e.addPieceZIndex&&(q.style.zIndex=Ve(z,t)),W&&(q.cgAnimating=!0,q.classList.add("anim"),z[0]+=W[2],z[1]+=W[3]),V(q,n(z,t))}else{const z=ke(X),D=Y("piece",z),ue=P(x);D.cgPiece=z,D.cgKey=x,W&&(D.cgAnimating=!0,ue[0]+=W[2],ue[1]+=W[3]),V(D,n(ue,t)),e.addPieceZIndex&&(D.style.zIndex=Ve(ue,t)),i.appendChild(D)}for(const x of p.values())Yt(e,x);for(const x of v.values())Yt(e,x)}function _r(e){const t=K(e),n=Se(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(An(i)&&!i.cgAnimating||qn(i))&&V(i,n(P(i.cgKey),t)),i=i.nextSibling}function Zt(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,l=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,s=l*o;r.style.width=l+"px",r.style.height=s+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",l+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",s+"px")}const An=e=>e.tagName==="PIECE",qn=e=>e.tagName==="SQUARE";function Yt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Ve(e,t){const i=e[1];return`${t?10-i:3+i}`}const ke=e=>`${e.color} ${e.role}`;function gr(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const s of e.lastMove)Z(r,s,"last-move");if(e.check&&e.highlight.check&&Z(r,e.check,"check"),e.selected&&(Z(r,e.selected,"selected"),e.movable.showDests)){const s=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(s)for(const a of s)Z(r,a,"move-dest"+(e.pieces.has(a)?" oc":""));const c=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(c)for(const a of c)Z(r,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const s of o)Z(r,s,"current-premove");else e.predroppable.current&&Z(r,e.predroppable.current.key,"current-premove");const l=e.exploding;if(l)for(const s of l.keys)Z(r,s,"exploding"+l.stage);return e.highlight.custom&&e.highlight.custom.forEach((s,c)=>{Z(r,c,s)}),r}function Z(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function Ge(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function vr(e,t,n){const i=new Map,r=[];for(const s of e)i.set(s.hash,!1);let o=t.firstElementChild,l;for(;o;)l=o.getAttribute("cgHash"),i.has(l)?i.set(l,!0):r.push(o),o=o.nextElementSibling;for(const s of r)t.removeChild(s);for(const s of e)i.get(s.hash)||t.appendChild(n(s))}function mr(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:kr(r),current:!1}));vr(i,t,r=>wr(e,r,e.dom.bounds()))}function br(e){var t;const n=K(e),i=Se(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)rn(r,i(P(r.cgKey),n),r.cgScale),r=r.nextSibling}function wr(e,{shape:t,hash:n},i){var r,o,l;const s=t.orig,c=(r=t.piece)===null||r===void 0?void 0:r.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,h=(l=t.piece)===null||l===void 0?void 0:l.scale,u=Y("piece",`${c} ${a}`);return u.setAttribute("cgHash",n),u.cgKey=s,u.cgScale=h,rn(u,Se(i)(P(s),K(e)),h),u}const kr=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function yr(e,t){const n=Ui();kn(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=cr(e,n),l=si(()=>o.board.getBoundingClientRect()),s=h=>{pr(a),o.autoPieces&&mr(a,o.autoPieces),!h&&o.svg&&Gi(a,o.svg,o.customSvg)},c=()=>{Zt(a),_r(a),o.autoPieces&&br(a)},a=n;return a.dom={elements:o,bounds:l,redraw:$r(s),redrawNow:s,unbind:r},a.drawable.prevSvgHash="",Zt(a),s(!1),ur(a,c),r||(a.dom.unbind=hr(a,c)),a.events.insert&&a.events.insert(o),a}return Fi(i(),i)}function $r(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var Sr=C('<div class="is2d chessboard">');const Cr=e=>{let t,n;return Jt(()=>{let i=e.color,r=e.dests,o={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:e.onMoveAfter}}};n=yr(t,o)}),U(()=>{let i,r;e.fen_uci?[i,r]=e.fen_uci:i=ot;let o=[];r&&(o.push(r.slice(0,2)),o.push(r.slice(2,4)));let l=e.movable?e.color:void 0;n.set({fen:i,lastMove:o,turnColor:e.color,movable:{color:l,dests:e.dests}})}),U(()=>{let i=e.orientation??"white";n.set({orientation:i})}),U(()=>{let i=e.doPromotion;if(i){let r=n.state.pieces.get(i);n.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),(()=>{var i=Sr();return rt(r=>t=r,i),i})()};var xr=C("<div class=chesstree>"),Pr=C("<div class=lines>"),Mr=C("<div class=line>"),zr=C("<span class=index>"),jr=C("<div>");class fe{constructor(){$(this,"_blacks");$(this,"_whites");this._blacks=E([],{equals:!1}),this._whites=E([],{equals:!1})}replace_all(t){this.blacks=t.blacks.slice(0),this.whites=t.whites.slice(0)}merge_dup(t){ee(()=>{t.paths.forEach(n=>this.add_path(n))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(t){let n=new fe;return n.blacks=t[0],n.whites=t[1],n}set blacks(t){this._blacks[1](t)}set whites(t){this._whites[1](t)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let t=[];return this.whites.forEach(n=>{for(let i=0;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),this.blacks.forEach(n=>{for(let i=1;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),t}clear(){this.blacks=[],this.whites=[]}remove_path(t){Tt(()=>{if(t.length%2===0){let n=this.blacks;n=n.filter(i=>i.join("")!==t.join("")),this.blacks=n}else{let n=this.whites;n=n.filter(i=>i.join("")!==t.join("")),this.whites=n}})}add_path(t){Tt(()=>{if(t.length%2===0){let n=this.blacks;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.blacks=n}else{let n=this.whites;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.whites=n}})}}const Ee=class Ee{constructor(t,n){$(this,"_tree");$(this,"_cursor_path");$(this,"_hidden_paths");$(this,"_revealed_paths");$(this,"_failed_paths");$(this,"_solved_paths");$(this,"reveal_hidden_paths",()=>{ee(()=>{this.hidden_paths.forEach(t=>{this._revealed_paths.add_path(t)}),this._hidden_paths.clear()})});$(this,"reveal_one_random",()=>{var i,r;if(!this.tree)return!1;const t=((r=(i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))==null?void 0:r.children)??[this.tree.root],n=Dr(t);return n?(ee(()=>{this._hidden_paths.remove_path(n.data.path),n.children.forEach(o=>this._hidden_paths.add_path(o.data.path)),this.cursor_path=n.data.path}),!0):!1});$(this,"try_next_uci_fail",t=>{var o,l,s;if(!this.tree)return!1;const n=((o=this.tree)==null?void 0:o._traverse_path(this.cursor_path))??this.tree.root,i=((s=(l=this.tree)==null?void 0:l._traverse_path(this.cursor_path))==null?void 0:s.children)??[this.tree.root],r=i.find(c=>c.data.uci===t)??i.find(c=>Er(c.data)===t);if(r){if(this.failed_paths_expanded.find(a=>a.join("")===r.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return ee(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this._failed_paths.add_path([...n.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});$(this,"on_wheel",t=>{var i;let n=this.cursor_path;if(t<0)n.length>0&&this.try_set_cursor_path(n.slice(0,-1));else{let r=this.tree;if(r){let o;n.length===0?o=[r.root]:o=(i=r._traverse_path(n))==null?void 0:i.children;let l=o==null?void 0:o.map(s=>s.data.path).find(s=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>s.join("").startsWith(a.join(""))))});l&&this.try_set_cursor_path(l)}}});this.initial_fen=t,this._cursor_path=E([],{equals:!1}),this._tree=E(n),this._hidden_paths=new fe,this._revealed_paths=new fe,this._failed_paths=new fe,this._solved_paths=new fe}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths.paths}get failed_paths(){return this._failed_paths.paths}get solved_paths(){return this._solved_paths}get failed_paths_expanded(){return this._failed_paths.expand_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get revealed_paths_expanded(){return this._revealed_paths.expand_paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let n=t.get_at(this.cursor_path);if(!n)return;let i=n.after_fen,r=n.uci;return[i,r]}}try_set_cursor_path(t){return this.hidden_paths.find(i=>t.join("").startsWith(i.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let n=this.tree,i=this.cursor_path;return n?n.append_uci(t,i):n=Xn.make(this.initial_fen,[t]),i=[...i,t],ee(()=>{this.tree=n,this.cursor_path=i}),i}drop_failed_paths(){}get is_next_hidden_cursor_path(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,!!(r!=null&&r.map(o=>o.data.path).find(o=>{var l;return(l=this.hidden_paths)==null?void 0:l.some(s=>o.join("").startsWith(s.join("")))}))}}get can_navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,(r==null?void 0:r.map(l=>l.data.path).find(l=>{var s;return!((s=this.hidden_paths)!=null&&s.some(c=>l.join("").startsWith(c.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_last(){var i,r;let t=this.cursor_path,n=this.tree;if(n){let o;t.length===0?o=[n.root]:o=(i=n._traverse_path(t))==null?void 0:i.children;let l=o==null?void 0:o.map(s=>s.data.path).find(s=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>s.join("").startsWith(a.join(""))))});if(l){let s=n._traverse_path(l);for(;s.children.length>0&&!((r=this.hidden_paths)!=null&&r.some(c=>s.children[0].data.path.join("").startsWith(c.join(""))));)s=s.children[0];l=s.data.path,this.try_set_cursor_path(l)}}}navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children;let o=r==null?void 0:r.map(l=>l.data.path).find(l=>{var s;return!((s=this.hidden_paths)!=null&&s.some(c=>l.join("").startsWith(c.join(""))))});o&&this.try_set_cursor_path(o)}}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_first(){this.try_set_cursor_path(this.cursor_path.slice(0,1))}};$(Ee,"make",(t,n=(t==null?void 0:t.root.data.before_fen)||ot)=>new Ee(n,t));let tt=Ee;const Ar=e=>{let t;return U(()=>{let n=e.lala.cursor_path,i=t.parentElement;if(!i)return;const r=t.querySelector(".on_path_end");if(!r){i.scrollTop=n.length>0?99999:0;return}let o=r.offsetTop-i.offsetHeight/2+r.offsetHeight;i.scrollTo({behavior:"smooth",top:o})}),(()=>{var n=xr();return rt(i=>t=i,n),b(n,w(L,{get when(){return e.lala.tree},get fallback(){return[]},children:i=>w(nt,{on_set_path:r=>e.lala.try_set_cursor_path(r),get cursor_path(){return e.lala.cursor_path},get hidden_paths(){return e.lala.hidden_paths},get revealed_paths(){return e.lala.revealed_paths},get solved_paths(){return e.lala.solved_paths_expanded},get failed_paths(){return e.lala.failed_paths_expanded},get lines(){return[i().root]}})})),n})()},nt=e=>w(Ze,{get each(){return e.lines},children:t=>[w(qr,Be({get data(){return t.data}},e)),w(tn,{get children(){return[w(ye,{get when(){return t.children.length===1},get children(){return w(nt,Be(e,{get lines(){return t.children}}))}}),w(ye,{get when(){return t.children.length>1},get children(){var n=Pr();return b(n,w(Ze,{get each(){return t.children},children:i=>(()=>{var r=Mr();return b(r,w(nt,Be(e,{lines:[i],show_index:!0}))),r})()})),n}})]}})]}),qr=e=>{let t=`${Math.ceil(e.data.ply/2)}.`;e.data.ply%2===0&&(t+="..");let n=k(()=>e.cursor_path.join("").startsWith(e.data.path.join(""))),i=k(()=>e.cursor_path.join("")===e.data.path.join("")),r=e.data.path.join(""),o=k(()=>e.hidden_paths.find(p=>p.join("")===r)),l=k(()=>e.hidden_paths.find(p=>r.startsWith(p.join("")))),s=k(()=>e.revealed_paths.find(p=>p.join("")===r)),c=k(()=>e.revealed_paths.find(p=>r.startsWith(p.join("")))),a=k(()=>e.failed_paths.find(p=>p.join("")===r)),h=k(()=>e.solved_paths.find(p=>p.join("")===r)),u=k(()=>["move",i()?"on_path_end":n()?"on_path":"",o()?"on_hidden_path_start":l()?"on_hidden_path":"",s()?"on_revealed_path_start":c()?"on_revealed_path":"",a()?"on_failed_path":"",h()?"on_solved_path":"",e.collapsed?"collapsed":""].join(" "));return(()=>{var p=jr();return p.$$click=()=>e.on_set_path(e.data.path),b(p,w(L,{get when(){return e.show_index||e.data.ply&1},get children(){var v=zr();return b(v,t),v}}),null),b(p,()=>e.data.san,null),he(()=>oe(p,u())),p})()};function Dr(e){let t=e.length*(e.length+1)/2,n=Math.floor(Math.random()*t)+1,i=0;for(let r=0;r<e.length;r++)if(i+=e.length-r,n<=i)return e[r]}const Er=e=>{let t=e.uci.slice(0,2),n=e.uci[3];if(e.san==="O-O")return t+"g"+n;if(e.san==="O-O-O")return t+"c"+n};en(["click"]);const Te=class Te{constructor(){$(this,"_add_uci");$(this,"_promotion");$(this,"_position");$(this,"m_fen");$(this,"m_dests");$(this,"m_color");$(this,"_last_move");$(this,"_on_wheel");$(this,"set_on_wheel",t=>{this._on_wheel[1](t)});$(this,"on_set_fen_uci",(t,n)=>{ee(()=>{this.add_uci=void 0,this.last_move=n,this.position=Wt.fromSetup(Ot(t).unwrap()).unwrap()})});$(this,"reset_move_after",()=>{this.position=this.position});$(this,"on_move_after",(t,n)=>{let i=this.position.board.get(Jn(t)),r=t+n;i.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(r+="q"),this.position.play(ei(r)),ee(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=n),this.add_uci=r})});this._on_wheel=E(void 0,{equals:!1}),this._last_move=E(void 0,{equals:!1}),this._add_uci=E(void 0,{equals:!1}),this._promotion=E(void 0,{equals:!1}),this._position=E(Wt.fromSetup(Ot(ot).unwrap()).unwrap(),{equals:!1}),this.m_dests=k(()=>ri(this.position)),this.m_fen=k(()=>Qn(this.position.toSetup())),this.m_color=k(()=>this.position.turn)}get position(){return this._position[0]()}set position(t){this._position[1](t)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(t){this._promotion[1](t)}get add_uci(){return this._add_uci[0]()}set add_uci(t){this._add_uci[1](t)}get last_move(){return this._last_move[0]()}set last_move(t){this._last_move[1](t)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let t=this.fen,n=this.last_move;return[t,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};$(Te,"init",()=>new Te);let it=Te;var Tr=C("<span>Loading..."),Wr=C("<span>Failed loading PGNs.."),Or=C("<span>#"),Nr=C("<span> Puzzles"),Rr=C("<h3>Puzzle Completed!"),Xt=C("<h4>"),Kr=C("<span class=success>solved +1"),Lr=C("<span class=success>failed +1"),Hr=C("<span class=success>skipped +1"),Ir=C("<span class=link>Continue with next puzzle."),Br=C('<div class=home><div class=board-wrap></div><div class=replay-wrap><div class=replay><div class=replay-header><span>lichess</span></div><div class=replay-v></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=></button></div><div class=replay-tools></div></div></div><div class=side><div class=side-header><span class=title>Set: </span><span class=run>Run: #</span><span class=time>Total Time: </span></div><div class=side-tools><div class=jump-toggle><input type=checkbox id=jump-next><label for=jump-next>Jump to next puzzle immediately</label></div><div class=show-dropdown><label for=show-only>Show Only</label><select id=show-only><option value="">Normal Run</option><option value=solved>Solved Puzzles</option><option value=unseen>Unseen Puzzles</option><option value=failed>Failed Puzzles</option><option value=skipped>Skipped Puzzles</option></select></div></div></div><div class=under><div class=side-list>'),Qt=C("<span> There are no <!> Puzzles "),Fr=C("<span> You've finished a Run. "),Ur=C("<div class=end-stats><div class=out><span class=solved>Solved: <!>/</span><span class=failed>Failed: <!>/</span><span class=skipped>Skipped: <!>/<!> </span></div><span>Time Spent: <!> "),Vr=C("<button>Start a New Run"),Gr=C("<div class=info>"),Zr=C("<button>Go back to Run"),Yr=C("<div class=info><h3><span class=turn></span> to play</h3><span>Find the best move for "),Xr=C("<span>View Solution"),Qr=C("<span>");const io=()=>{let e=ze.active_user??ze.anonymous_user;const[t]=Nt(()=>Ye.get_or_create_active_run_for_user(e)),n=k(()=>{var r;return(r=t())==null?void 0:r.set_id}),[i]=Nt(n,r=>ii.get_study_by_id(r));return w(L,{get when(){return i.loading},get fallback(){return w(L,{get when(){return i.error},get fallback(){return w(L,{get when(){return k(()=>!!i())()&&!!t()},get children(){return w(Jr,{get pgn(){return i()},get run(){return t()}})}})},get children(){return Wr()}})},get children(){return Tr()}})},Jr=e=>{let t=ze.active_user??ze.anonymous_user;const[n,i]=E(e.run,{equals:!1}),r=()=>e.pgn,o=()=>r().hide_first;let l;const[s,c]=E(0),[a,h]=E(Kt.navigate_filter);Kt.navigate_filter=void 0;const u=k(()=>[...Array(e.pgn.chapters.length).keys()]),p=()=>n().solved,v=()=>n().failed,m=()=>n().skipped,_=k(()=>{let d=[...p(),...v(),...m()];return u().filter(g=>!d.includes(g))}),T=k(()=>{let d=a();if(d==="failed")return v();if(d==="skipped")return m();if(d==="solved")return p();if(d==="unseen")return _()}),A=k(()=>a()===void 0),W=ti(),[G,pe]=E(!1),[q,de]=E(!1),[ie,x]=E(!1);let X=T();const[z,D]=E(X?X[0]:_()[0]),ue=k(()=>e.pgn.chapters[z()??0]),F=new it,S=k(Q(ue,d=>{let g=tt.make(d.pgn.tree.clone);return o()&&g._hidden_paths.add_path(g.tree.root.data.path),g.tree.root.children.map(M=>M.data.path).forEach(M=>g._hidden_paths.add_path(M)),F.on_set_fen_uci(g.initial_fen),x(!1),c(0),setTimeout(()=>{o()?g.cursor_path=[]:g.cursor_path=g.tree.root.data.path,x(!0),clearInterval(l),l=setInterval(()=>c(s()+1e3),1e3)},600),g}));U(Q(A,d=>{c(0),clearInterval(l),d&&(l=setInterval(()=>c(s()+1e3),1e3))})),U(Q(()=>F.add_uci,d=>{if(!d)return;S().try_next_uci_fail(d)&&(de(!0),setTimeout(()=>{S().reveal_one_random(),de(!1)},600))})),U(Q(()=>S().fen_last_move,d=>{if(d){let[g,M]=d;F.on_set_fen_uci(g,M)}else F.on_set_fen_uci(S().initial_fen)})),U(Q(()=>{var d;return(d=S().tree)==null?void 0:d.get_at(S().cursor_path)},d=>{d&&W.move(d)}));const vt=()=>{let d=z();if(d===void 0)return;let g=T();g?d=g[g.indexOf(d)+1]:d=d+1,d>=e.pgn.chapters.length?D(void 0):D(d)},Dn=()=>{if(!ie())return!1;S().reveal_hidden_paths()};U(()=>{S().is_revealed&&G()&&setTimeout(()=>{vt()},600)});let Ce=k(Q(()=>S().is_revealed,d=>{if(!A())return"not_in_run";if(d){let g=S().failed_paths_expanded.length>0,M=S().revealed_paths_expanded.length>0;return g?"failed":M?"revealed":"solved"}return"thinking"}));U(Q(Ce,d=>{if(d==="not_in_run"||d==="thinking")return;let g=z(),M=n();d==="failed"?M.failed.push(g):d==="revealed"?M.skipped.push(g):d==="solved"&&M.solved.push(g),M.elapsed_ms+=s(),Ye._save_run(M),clearInterval(l),i(M)})),U(Q(()=>F.on_wheel,d=>{q()||d&&S().on_wheel(d)}));const mt=d=>{const g=d.target;g.tagName!=="PIECE"&&g.tagName!=="SQUARE"&&g.tagName!=="CG-BOARD"||(d.preventDefault(),F.set_on_wheel(Math.sign(d.deltaY)))};let We;Jt(()=>{We.addEventListener("wheel",mt,{passive:!1})}),ni(()=>{We.removeEventListener("wheel",mt)});const bt=k(()=>{let d=S().initial_color;return o()?d:Rt(d)}),En=d=>{let g=k(()=>m().includes(d)),M=k(()=>p().includes(d)),ge=k(()=>v().includes(d)),ve=k(()=>d===z());const Ne=k(()=>{var me;return(me=T())==null?void 0:me.includes(d)});let xe=k(()=>ve()?"current":g()?"skipped":M()?"solved":ge()?"failed":"");return[Ne()?"filtered":"",xe()].join(" ")},_e=d=>{h(d===""?void 0:d);let g=T();D(g?g[0]:_()[0])},Tn=d=>{let g=m().includes(d),M=p().includes(d),ge=v().includes(d);h(g?"skipped":M||ge?"solved":"unseen")},Oe=()=>{let d=a();return d==="failed"?"Failed":d==="skipped"?"Skipped":d==="solved"?"Solved":d==="unseen"?"Unseen":"All"};let[Wn,wt]=E(!1);const On=async()=>{wt(!0);let d=await Ye.start_new_run(t);ee(()=>{wt(!1),i(d),D(0)})};return(()=>{var d=Br(),g=d.firstChild,M=g.nextSibling,ge=M.firstChild,ve=ge.firstChild,Ne=ve.firstChild,xe=ve.nextSibling,me=xe.nextSibling,Re=me.firstChild,Ke=Re.nextSibling,Le=Ke.nextSibling,kt=Le.nextSibling,Nn=me.nextSibling,yt=M.nextSibling,$t=yt.firstChild,He=$t.firstChild;He.firstChild;var Ie=He.nextSibling;Ie.firstChild;var St=Ie.nextSibling;St.firstChild;var Rn=$t.nextSibling,Ct=Rn.firstChild,xt=Ct.firstChild,Kn=Ct.nextSibling,Ln=Kn.firstChild,Pt=Ln.nextSibling,Hn=yt.nextSibling,In=Hn.firstChild;return rt(f=>We=f,d),b(g,w(Cr,{get orientation(){return Rt(S().initial_color??"white")},get movable(){return k(()=>z()!==void 0&&!q()&&!S().is_revealed)()&&S().is_next_hidden_cursor_path},get doPromotion(){return F.promotion},get onMoveAfter(){return F.on_move_after},get fen_uci(){return F.fen_uci},get color(){return F.turnColor},get dests(){return F.dests}})),b(ve,w(L,{get when(){return z()!==void 0},get fallback(){return(()=>{var f=Qt(),y=f.firstChild,H=y.nextSibling;return H.nextSibling,b(f,Oe,H),f})()},get children(){return[(()=>{var f=Or();return f.firstChild,b(f,()=>z()+1,null),f})(),(()=>{var f=Nr(),y=f.firstChild;return b(f,Oe,y),f})()]}}),Ne),b(xe,w(Ar,{get lala(){return S()}})),Re.$$click=()=>S().navigate_first(),Ke.$$click=()=>S().navigate_prev(),Le.$$click=()=>S().navigate_next(),kt.$$click=()=>S().navigate_last(),b(Nn,w(L,{get when(){return z()!==void 0},get fallback(){return(()=>{var f=Gr();return b(f,w(L,{get when(){return A()},get fallback(){return[(()=>{var y=Qt(),H=y.firstChild,N=H.nextSibling;return N.nextSibling,b(y,Oe,N),y})(),(()=>{var y=Zr();return y.$$click=()=>_e(""),y})()]},get children(){return[Fr(),(()=>{var y=Ur(),H=y.firstChild,N=H.firstChild,re=N.firstChild,Mt=re.nextSibling;Mt.nextSibling;var be=N.nextSibling,Bn=be.firstChild,zt=Bn.nextSibling;zt.nextSibling;var Pe=be.nextSibling,Fn=Pe.firstChild,jt=Fn.nextSibling,Un=jt.nextSibling,At=Un.nextSibling;At.nextSibling;var qt=H.nextSibling,Vn=qt.firstChild,Dt=Vn.nextSibling;return Dt.nextSibling,N.$$click=()=>_e("solved"),b(N,()=>n().solved.length,Mt),b(N,()=>Fe(n()),null),be.$$click=()=>_e("failed"),b(be,()=>n().failed.length,zt),b(be,()=>Fe(n()),null),Pe.$$click=()=>_e("skipped"),b(Pe,()=>n().skipped.length,jt),b(Pe,()=>Fe(n()),At),b(qt,()=>Me(n().elapsed_ms),Dt),y})(),w(L,{get when(){return!Wn()},get children(){var y=Vr();return y.$$click=()=>On(),y}})]}})),f})()},get children(){return w(L,{get when(){return S().is_revealed},get fallback(){return[(()=>{var f=Yr(),y=f.firstChild,H=y.firstChild,N=y.nextSibling;return N.firstChild,b(H,bt),b(N,bt,null),b(f,w(L,{get when(){return A()},get children(){var re=Xt();return b(re,()=>Me(s(),!1)),re}}),null),f})(),(()=>{var f=Xr();return f.$$click=()=>Dn(),he(()=>oe(f,"solution"+(ie()?"":" fade-out"))),f})()]},get children(){return[Rr(),w(L,{get when(){return A()},get children(){var f=Xt();return b(f,()=>Me(s(),!1)),f}}),w(tn,{get children(){return[w(ye,{get when(){return Ce()==="solved"},get children(){return Kr()}}),w(ye,{get when(){return Ce()==="failed"},get children(){return Lr()}}),w(ye,{get when(){return Ce()==="revealed"},get children(){return Hr()}})]}}),w(L,{get when(){return!G()},get children(){var f=Ir();return f.$$click=()=>vt(),f}})]}})}})),b(He,()=>r().name,null),b(Ie,()=>n().no,null),b(St,()=>Me(n().elapsed_ms),null),xt.addEventListener("change",f=>pe(f.currentTarget.checked)),Pt.addEventListener("change",f=>_e(f.currentTarget.value)),b(In,w(Ze,{get each(){return u()},children:f=>(()=>{var y=Qr();return y.$$click=()=>{Tn(f),D(f)},b(y,f+1),he(()=>oe(y,En(f))),y})()})),he(f=>{var y="fbt first"+(!q()&&S().can_navigate_prev?"":" disabled"),H="fbt prev"+(!q()&&S().can_navigate_prev?"":" disabled"),N="fbt next"+(!q()&&S().can_navigate_next?"":" disabled"),re="fbt last"+(!q()&&S().can_navigate_next?"":" disabled");return y!==f.e&&oe(Re,f.e=y),H!==f.t&&oe(Ke,f.t=H),N!==f.a&&oe(Le,f.a=N),re!==f.o&&oe(kt,f.o=re),f},{e:void 0,t:void 0,a:void 0,o:void 0}),he(()=>xt.checked=G()),he(()=>Pt.value=a()===void 0?"":a()),d})()};en(["click"]);export{io as default};
