var _n=Object.defineProperty;var gn=(e,t,n)=>t in e?_n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var w=(e,t,n)=>(gn(e,typeof t!="symbol"?t+"":t,n),n);import{m as ht,s as vn,o as jt,c as F,u as Be,t as x,I as Fe,d as zt,i as P,a as C,S as ne,b as Ae,e as At,M as fe,F as Te,f as b,g as he,h as J,j as q,k as te,l as mn,n as ft,C as pt,p as _t,q as bn,r as wn,v as yn,P as gt,w as vt,x as kn,y as ae,z as Cn,A as mt,U as qt,B as Sn}from"./index-BuIFLwUl.js";import{f as qe}from"./util-Dh_741V6.js";const Pn=(e,t)=>{const n=new Map,i=e.ctx();for(const[r,o]of e.allDests(i))if(o.nonEmpty()){const s=Array.from(o,ht);!(t!=null&&t.chess960)&&r===i.king&&vn(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(ht(r),s)}return n},$n=["white","black"],Ve=["a","b","c","d","e","f","g","h"],Ue=["1","2","3","4","5","6","7","8"],xn=[...Ue].reverse(),Ze=Array.prototype.concat(...Ve.map(e=>Ue.map(t=>e+t))),R=e=>Ze[8*e[0]+e[1]],S=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Dt=Ze.map(S);function Mn(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const jn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Ge=e=>e==="white"?"black":"white",pe=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},Oe=(e,t)=>e.role===t.role&&e.color===t.color,_e=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],B=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Et=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},Ye=(e,t)=>{e.style.visibility=t?"visible":"hidden"},re=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Wt=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},U=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function Tt(e,t,n){const i=S(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const ie=(e,t)=>Math.abs(e-t),zn=e=>(t,n,i,r)=>ie(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),Ot=(e,t,n,i)=>{const r=ie(e,n),o=ie(t,i);return r===1&&o===2||r===2&&o===1},Nt=(e,t,n,i)=>ie(e,n)===ie(t,i),Kt=(e,t,n,i)=>e===n||t===i,Rt=(e,t,n,i)=>Nt(e,t,n,i)||Kt(e,t,n,i),An=(e,t,n)=>(i,r,o,s)=>ie(i,o)<2&&ie(r,s)<2||n&&r===s&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function qn(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(S(r)[0]);return i}function Lt(e,t,n){const i=e.get(t);if(!i)return[];const r=S(t),o=i.role,s=o==="pawn"?zn(i.color):o==="knight"?Ot:o==="bishop"?Nt:o==="rook"?Kt:o==="queen"?Rt:An(i.color,qn(e,i.color),n);return Dt.filter(l=>(r[0]!==l[0]||r[1]!==l[1])&&s(r[0],r[1],l[0],l[1])).map(R)}function W(e,...t){e&&setTimeout(()=>e(...t),1)}function Dn(e){e.orientation=Ge(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function En(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function Wn(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function Tn(e,t,n,i){X(e),e.premovable.current=[t,n],W(e.premovable.events.set,t,n,i)}function Y(e){e.premovable.current&&(e.premovable.current=void 0,W(e.premovable.events.unset))}function On(e,t,n){Y(e),e.predroppable.current={role:t,key:n},W(e.predroppable.events.set,t,n)}function X(e){const t=e.predroppable;t.current&&(t.current=void 0,W(t.events.unset))}function Nn(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=S(t),o=S(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=R([7,o[1]]):o[0]===2&&(n=R([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(R([6,o[1]]),i),e.pieces.set(R([5,o[1]]),s)):(e.pieces.set(R([2,o[1]]),i),e.pieces.set(R([3,o[1]]),s)),!0)}function Ht(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&L(e),W(e.events.move,t,n,o),Nn(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,W(e.events.change),o||!0}function Xe(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return W(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,W(e.events.change),e.movable.dests=void 0,e.turnColor=Ge(e.turnColor),!0}function It(e,t,n){const i=Ht(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=Ge(e.turnColor),e.animation.current=void 0),i}function Bt(e,t,n){if(Qe(e,t,n)){const i=It(e,t,n);if(i){const r=e.hold.stop();L(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),W(e.movable.events.after,t,n,o),!0}}else if(Rn(e,t,n))return Tn(e,t,n,{ctrlKey:e.stats.ctrlKey}),L(e),!0;return L(e),!1}function Ft(e,t,n,i){const r=e.pieces.get(t);r&&(Kn(e,t,n)||i)?(e.pieces.delete(t),Xe(e,r,n,i),W(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&Ln(e,t,n)?On(e,r.role,n):(Y(e),X(e)),e.pieces.delete(t),L(e)}function Ne(e,t,n){if(W(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){L(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&Bt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Ut(e,t)||Je(e,t))&&(Vt(e,t),e.hold.start())}function Vt(e,t){e.selected=t,Je(e,t)?e.premovable.customDests||(e.premovable.dests=Lt(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function L(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Ut(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const Qe=(e,t,n)=>{var i,r;return t!==n&&Ut(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function Kn(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function Je(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Rn(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:Lt(e.pieces,t,e.premovable.castle);return t!==n&&Je(e,t)&&o.includes(n)}function Ln(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function Hn(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function In(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(Qe(e,n,i)){const o=It(e,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),W(e.movable.events.after,n,i,s),r=!0}}return Y(e),r}function Bn(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};Xe(e,r,n.key)&&(W(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return X(e),i}function et(e){Y(e),X(e),L(e)}function bt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,et(e)}function oe(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?R([i,r]):void 0}function Fn(e,t,n,i){const r=S(e),o=Dt.filter(a=>Rt(r[0],r[1],a[0],a[1])||Ot(r[0],r[1],a[0],a[1])),l=o.map(a=>Tt(R(a),n,i)).map(a=>pe(t,a)),[,c]=l.reduce((a,u,d)=>a[0]<u?a:[u,d],[l[0],0]);return R(o[c])}const T=e=>e.orientation==="white",Zt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Vn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Un={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Gt(e){e==="start"&&(e=Zt);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(R([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();t.set(R([i,n]),{role:Vn[s],color:r===s?"black":"white"}),++i}}}return t}function Zn(e){return xn.map(t=>Ve.map(n=>{const i=e.get(n+t);if(i){let r=Un[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Yt(e,t){t.animation&&(tt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Xt(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),tt(e,t),t.fen&&(e.pieces=Gt(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&Wn(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Vt(e,e.selected),Yt(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,l=e.movable.dests.get(s),c=e.pieces.get(s);if(!l||!c||c.role!=="king")return;e.movable.dests.set(s,l.filter(a=>!(a==="a"+o&&l.includes("c"+o))&&!(a==="h"+o&&l.includes("g"+o))))}}function tt(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&wt(e[n])&&wt(t[n])?tt(e[n],t[n]):e[n]=t[n])}function wt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const ee=(e,t)=>t.animation.enabled?Xn(e,t):G(e,t);function G(e,t){const n=e(t);return t.dom.redraw(),n}const De=(e,t)=>({key:e,pos:S(e),piece:t}),Gn=(e,t)=>t.sort((n,i)=>pe(e.pos,n.pos)-pe(e.pos,i.pos))[0];function Yn(e,t){const n=new Map,i=[],r=new Map,o=[],s=[],l=new Map;let c,a,u;for(const[d,f]of e)l.set(d,De(d,f));for(const d of Ze)c=t.pieces.get(d),a=l.get(d),c?a?Oe(c,a.piece)||(o.push(a),s.push(De(d,c))):s.push(De(d,c)):a&&o.push(a);for(const d of s)a=Gn(d,o.filter(f=>Oe(d.piece,f.piece))),a&&(u=[a.pos[0]-d.pos[0],a.pos[1]-d.pos[1]],n.set(d.key,u.concat(u)),i.push(a.key));for(const d of o)i.includes(d.key)||r.set(d.key,d.piece);return{anims:n,fadings:r}}function Qt(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=Qn(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Qt(e,o))}}function Xn(e,t){const n=new Map(t.pieces),i=e(t),r=Yn(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||Qt(t,performance.now())}else t.dom.redraw();return i}const Qn=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Jn=["green","red","blue","yellow"];function ei(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?L(e):et(e);const n=re(t),i=oe(n,T(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:ri(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Jt(e))}function Jt(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=oe(t.pos,T(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?Fn(t.orig,t.pos,T(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),Jt(e)}})}function ti(e,t){e.drawable.current&&(e.drawable.current.pos=re(t))}function ni(e){const t=e.drawable.current;t&&(t.mouseSq&&oi(e.drawable,t),en(e))}function en(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ii(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),tn(e.drawable))}function ri(e){var t;const n=(e.shiftKey||e.ctrlKey)&&Wt(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Jn[(n?1:0)+(i?2:0)]}function oi(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),tn(e)}function tn(e){e.onChange&&e.onChange(e.shapes)}function si(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=re(t),r=oe(i,T(e),n);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&ii(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||li(e,i)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Qe(e,e.selected,r)?ee(d=>Ne(d,r),e):Ne(e,r);const a=e.selected===r,u=rn(e,r);if(o&&u&&a&&Hn(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className=`ghost ${o.color} ${o.role}`,B(d,_e(n)(S(r),T(e))),Ye(d,!0)),nt(e)}else l&&Y(e),c&&X(e);e.dom.redraw()}function li(e,t){const n=T(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const s=Tt(o,n,i);if(pe(s,t)<=r)return!0}return!1}function ai(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=re(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>rn(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},nt(e)}function nt(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!Oe(i,n.piece))me(e);else if(!n.started&&pe(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();B(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==oe(n.pos,T(e),r))}nt(e)})}function ci(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=re(t))}function di(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}Y(e),X(e);const i=re(t)||n.pos,r=oe(i,T(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?Ft(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,Bt(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),W(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?L(e):e.selectable.enabled||L(e),nn(e),e.draggable.current=void 0,e.dom.redraw()}function me(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,L(e),nn(e),e.dom.redraw())}function nn(e){const t=e.dom.elements;t.ghost&&Ye(t.ghost,!1)}function rn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function ui(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{yt(e,2),setTimeout(()=>yt(e,void 0),120)},120)}function yt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function hi(e,t){function n(){Dn(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),Yt(e,i),(i.fen?ee:G)(r=>Xt(r,i),e)},state:e,getFen:()=>Zn(e.pieces),toggleOrientation:n,setPieces(i){ee(r=>En(r,i),e)},selectSquare(i,r){i?ee(o=>Ne(o,i,r),e):e.selected&&(L(e),e.dom.redraw())},move(i,r){ee(o=>Ht(o,i,r),e)},newPiece(i,r){ee(o=>Xe(o,i,r),e)},playPremove(){if(e.premovable.current){if(ee(In,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=Bn(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){G(Y,e)},cancelPredrop(){G(X,e)},cancelMove(){G(i=>{et(i),me(i)},e)},stop(){G(i=>{bt(i),me(i)},e)},explode(i){ui(e,i)},setAutoShapes(i){G(r=>r.drawable.autoShapes=i,e)},setShapes(i){G(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return oe(i,T(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){ai(e,i,r,o)},destroy(){bt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function fi(){return{pieces:Gt(Zt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:jn()}}const kt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function pi(){const e=$("defs"),t=D($("filter"),{id:"cg-filter-blur"});return t.appendChild(D($("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function _i(e,t,n){var i;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,l=new Map,c=e.dom.bounds(),a=r.autoShapes.filter(_=>!_.piece);for(const _ of r.shapes.concat(a).concat(s?[s]:[])){if(!_.dest)continue;const v=(i=l.get(_.dest))!==null&&i!==void 0?i:new Set,h=ye(we(S(_.orig),e.orientation),c),O=ye(we(S(_.dest),e.orientation),c);v.add(Re(h,O)),l.set(_.dest,v)}const u=r.shapes.concat(a).map(_=>({shape:_,current:!1,hash:Ct(_,Ke(_.dest,l),!1,c)}));s&&u.push({shape:s,current:!0,hash:Ct(s,Ke(s.dest,l),!0,c)});const d=u.map(_=>_.hash).join(";");if(d===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=d;const f=t.querySelector("defs");gi(r,u,f),vi(u,t.querySelector("g"),n.querySelector("g"),_=>wi(e,_,r.brushes,l,c))}function gi(e,t,n){var i;const r=new Map;let o;for(const c of t.filter(a=>a.shape.dest&&a.shape.brush))o=on(e.brushes[c.shape.brush],c.shape.modifiers),!((i=c.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(be(o).key,be(o)),r.set(o.key,o);const s=new Set;let l=n.firstElementChild;for(;l;)s.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(const[c,a]of r.entries())s.has(c)||n.appendChild(Ci(a))}function vi(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const s=[];let l=o.firstElementChild,c;for(;l;)c=l.getAttribute("cgHash"),r.has(c)?r.set(c,!0):s.push(l),l=l.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Ct({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:s},l,c,a){var u,d;return[a.width,a.height,c,e,t,n,l&&"-",i&&mi(i),r&&bi(r),o&&`custom-${St(o.html)},${(d=(u=o.center)===null||u===void 0?void 0:u[0])!==null&&d!==void 0?d:"o"}`,s&&`label-${St(s.text)}`].filter(f=>f).join(",")}function mi(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function bi(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function St(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function wi(e,{shape:t,current:n,hash:i},r,o,s){var l,c;const a=ye(we(S(t.orig),e.orientation),s),u=t.dest?ye(we(S(t.dest),e.orientation),s):a,d=t.brush&&on(r[t.brush],t.modifiers),f=o.get(t.dest),_=[];if(d){const v=D($("g"),{cgHash:i});_.push({el:v}),a[0]!==u[0]||a[1]!==u[1]?v.appendChild(ki(t,d,a,u,n,Ke(t.dest,o))):v.appendChild(yi(r[t.brush],a,n,s))}if(t.label){const v=t.label;(l=v.fill)!==null&&l!==void 0||(v.fill=t.brush&&r[t.brush].color);const h=t.brush?void 0:"tr";_.push({el:Si(v,i,a,u,f,h),isCustom:!0})}if(t.customSvg){const v=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[h,O]=v==="label"?ln(a,u,f).map(j=>j-.5):v==="dest"?u:a,E=D($("g"),{transform:`translate(${h},${O})`,cgHash:i});E.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,_.push({el:E,isCustom:!0})}return _}function yi(e,t,n,i){const r=Pi(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return D($("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:sn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function be(e){return["#ffffff","#fff","white"].includes(e.color)?kt.hilitePrimary:kt.hiliteWhite}function ki(e,t,n,i,r,o){var s;function l(u){var d;const f=xi(o&&!r),_=i[0]-n[0],v=i[1]-n[1],h=Math.atan2(v,_),O=Math.cos(h)*f,E=Math.sin(h)*f;return D($("line"),{stroke:u?be(t).color:t.color,"stroke-width":$i(t,r)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?be(t).key:t.key})`,opacity:!((d=e.modifiers)===null||d===void 0)&&d.hilite?1:sn(t,r),x1:n[0],y1:n[1],x2:i[0]-O,y2:i[1]-E})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return l(!1);const c=$("g"),a=D($("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(Mi(n,i)),a.appendChild(l(!0)),c.appendChild(a),c.appendChild(l(!1)),c}function Ci(e){const t=D($("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(D($("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Si(e,t,n,i,r,o){var s;const c=.4*.75**e.text.length,a=ln(n,i,r),u=o==="tr"?.4:0,d=D($("g"),{transform:`translate(${a[0]+u},${a[1]-u})`,cgHash:t});d.appendChild(D($("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const f=D($("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return f.innerHTML=e.text,d.appendChild(f),d}function we(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Ke(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function $(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function D(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function on(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function Pi(){return[3/64,4/64]}function $i(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function sn(e,t){return(e.opacity||1)*(t?.9:1)}function xi(e){return(e?20:10)/64}function ye(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function Mi(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return D($("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function Re(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function ji(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function ln(e,t,n){let i=ji(e,t);const r=Re(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=Re(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function zi(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of $n)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=U("cg-container");e.appendChild(n);const i=U("cg-board");n.appendChild(i);let r,o,s;if(t.drawable.visible&&(r=D($("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(pi()),r.appendChild($("g")),o=D($("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild($("g")),s=U("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),t.coordinates){const c=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";n.appendChild(Pt(Ue,"ranks"+c+a)),n.appendChild(Pt(Ve,"files"+c))}let l;return t.draggable.enabled&&t.draggable.showGhost&&(l=U("piece","ghost"),Ye(l,!1),n.appendChild(l)),{board:i,container:n,wrap:e,ghost:l,svg:r,customSvg:o,autoPieces:s}}function Pt(e,t){const n=U("coords",t);let i;for(const r of e)i=U("coord"),i.textContent=r,n.appendChild(i);return n}function Ai(e,t){if(!e.dropmode.active)return;Y(e),X(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=re(t),r=i&&oe(i,T(e),e.dom.bounds());r&&Ft(e,"a0",r)}e.dom.redraw()}function qi(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=Ei(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function Di(e,t){const n=[];if("ResizeObserver"in window||n.push(de(document.body,"chessground.resize",t)),!e.viewOnly){const i=$t(e,ci,ti),r=$t(e,di,ni);for(const s of["touchmove","mousemove"])n.push(de(document,s,i));for(const s of["touchend","mouseup"])n.push(de(document,s,r));const o=()=>e.dom.bounds.clear();n.push(de(document,"scroll",o,{capture:!0,passive:!0})),n.push(de(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function de(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const Ei=e=>t=>{e.draggable.current?me(e):e.drawable.current?en(e):t.shiftKey||Wt(t)?e.drawable.enabled&&ei(e,t):e.viewOnly||(e.dropmode.active?Ai(e,t):si(e,t))},$t=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function Wi(e){const t=T(e),n=_e(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,l=o?o.plan.fadings:new Map,c=e.draggable.current,a=Oi(e),u=new Set,d=new Set,f=new Map,_=new Map;let v,h,O,E,j,H,se,K,z,g;for(h=i.firstChild;h;){if(v=h.cgKey,an(h))if(O=r.get(v),j=s.get(v),H=l.get(v),E=h.cgPiece,h.cgDragging&&(!c||c.orig!==v)&&(h.classList.remove("dragging"),B(h,n(S(v),t)),h.cgDragging=!1),!H&&h.cgFading&&(h.cgFading=!1,h.classList.remove("fading")),O){if(j&&h.cgAnimating&&E===ue(O)){const k=S(v);k[0]+=j[2],k[1]+=j[3],h.classList.add("anim"),B(h,n(k,t))}else h.cgAnimating&&(h.cgAnimating=!1,h.classList.remove("anim"),B(h,n(S(v),t)),e.addPieceZIndex&&(h.style.zIndex=Ee(S(v),t)));E===ue(O)&&(!H||!h.cgFading)?u.add(v):H&&E===ue(H)?(h.classList.add("fading"),h.cgFading=!0):We(f,E,h)}else We(f,E,h);else if(cn(h)){const k=h.className;a.get(v)===k?d.add(v):We(_,k,h)}h=h.nextSibling}for(const[k,Q]of a)if(!d.has(k)){z=_.get(Q),g=z&&z.pop();const A=n(S(k),t);if(g)g.cgKey=k,B(g,A);else{const N=U("square",Q);N.cgKey=k,B(N,A),i.insertBefore(N,i.firstChild)}}for(const[k,Q]of r)if(j=s.get(k),!u.has(k))if(se=f.get(ue(Q)),K=se&&se.pop(),K){K.cgKey=k,K.cgFading&&(K.classList.remove("fading"),K.cgFading=!1);const A=S(k);e.addPieceZIndex&&(K.style.zIndex=Ee(A,t)),j&&(K.cgAnimating=!0,K.classList.add("anim"),A[0]+=j[2],A[1]+=j[3]),B(K,n(A,t))}else{const A=ue(Q),N=U("piece",A),Z=S(k);N.cgPiece=A,N.cgKey=k,j&&(N.cgAnimating=!0,Z[0]+=j[2],Z[1]+=j[3]),B(N,n(Z,t)),e.addPieceZIndex&&(N.style.zIndex=Ee(Z,t)),i.appendChild(N)}for(const k of f.values())Mt(e,k);for(const k of _.values())Mt(e,k)}function Ti(e){const t=T(e),n=_e(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(an(i)&&!i.cgAnimating||cn(i))&&B(i,n(S(i.cgKey),t)),i=i.nextSibling}function xt(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=s*o;r.style.width=s+"px",r.style.height=l+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",l+"px")}const an=e=>e.tagName==="PIECE",cn=e=>e.tagName==="SQUARE";function Mt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Ee(e,t){const i=e[1];return`${t?10-i:3+i}`}const ue=e=>`${e.color} ${e.role}`;function Oi(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const l of e.lastMove)V(r,l,"last-move");if(e.check&&e.highlight.check&&V(r,e.check,"check"),e.selected&&(V(r,e.selected,"selected"),e.movable.showDests)){const l=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(l)for(const a of l)V(r,a,"move-dest"+(e.pieces.has(a)?" oc":""));const c=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(c)for(const a of c)V(r,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const l of o)V(r,l,"current-premove");else e.predroppable.current&&V(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const l of s.keys)V(r,l,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((l,c)=>{V(r,c,l)}),r}function V(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function We(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function Ni(e,t,n){const i=new Map,r=[];for(const l of e)i.set(l.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const l of r)t.removeChild(l);for(const l of e)i.get(l.hash)||t.appendChild(n(l))}function Ki(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:Hi(r),current:!1}));Ni(i,t,r=>Li(e,r,e.dom.bounds()))}function Ri(e){var t;const n=T(e),i=_e(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)Et(r,i(S(r.cgKey),n),r.cgScale),r=r.nextSibling}function Li(e,{shape:t,hash:n},i){var r,o,s;const l=t.orig,c=(r=t.piece)===null||r===void 0?void 0:r.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,u=(s=t.piece)===null||s===void 0?void 0:s.scale,d=U("piece",`${c} ${a}`);return d.setAttribute("cgHash",n),d.cgKey=l,d.cgScale=u,Et(d,_e(i)(S(l),T(e)),u),d}const Hi=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function Ii(e,t){const n=fi();Xt(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=zi(e,n),s=Mn(()=>o.board.getBoundingClientRect()),l=u=>{Wi(a),o.autoPieces&&Ki(a,o.autoPieces),!u&&o.svg&&_i(a,o.svg,o.customSvg)},c=()=>{xt(a),Ti(a),o.autoPieces&&Ri(a)},a=n;return a.dom={elements:o,bounds:s,redraw:Bi(l),redrawNow:l,unbind:r},a.drawable.prevSvgHash="",xt(a),l(!1),qi(a,c),r||(a.dom.unbind=Di(a,c)),a.events.insert&&a.events.insert(o),a}return hi(i(),i)}function Bi(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var Fi=x('<div class="is2d chessboard">');const Vi=e=>{let t,n;return jt(()=>{let i=e.color,r=e.dests,o={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:e.onMoveAfter}}};n=Ii(t,o)}),F(()=>{let i,r;e.fen_uci?[i,r]=e.fen_uci:i=Fe;let o=[];r&&(o.push(r.slice(0,2)),o.push(r.slice(2,4)));let s=e.movable?e.color:void 0;n.set({fen:i,lastMove:o,turnColor:e.color,movable:{color:s,dests:e.dests}})}),F(()=>{let i=e.orientation??"white";n.set({orientation:i})}),F(()=>{let i=e.doPromotion;if(i){let r=n.state.pieces.get(i);n.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),(()=>{var i=Fi();return Be(r=>t=r,i),i})()};var Ui=x("<div class=chesstree>"),Zi=x("<div class=lines>"),Gi=x("<div class=line>"),Yi=x("<span class=index>"),Xi=x("<div>");class ce{constructor(){w(this,"_blacks");w(this,"_whites");this._blacks=q([],{equals:!1}),this._whites=q([],{equals:!1})}replace_all(t){this.blacks=t.blacks.slice(0),this.whites=t.whites.slice(0)}merge_dup(t){te(()=>{t.paths.forEach(n=>this.add_path(n))})}get_for_saving(){return[this.blacks,this.whites]}static set_for_saving(t){let n=new ce;return n.blacks=t[0],n.whites=t[1],n}set blacks(t){this._blacks[1](t)}set whites(t){this._whites[1](t)}get blacks(){return this._blacks[0]()}get whites(){return this._whites[0]()}get paths(){return[...this.blacks,...this.whites]}get expand_paths(){let t=[];return this.whites.forEach(n=>{for(let i=0;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),this.blacks.forEach(n=>{for(let i=1;i<=n.length-1;i+=2)t.push(n.slice(0,i+1))}),t}clear(){this.blacks=[],this.whites=[]}remove_path(t){ft(()=>{if(t.length%2===0){let n=this.blacks;n=n.filter(i=>i.join("")!==t.join("")),this.blacks=n}else{let n=this.whites;n=n.filter(i=>i.join("")!==t.join("")),this.whites=n}})}add_path(t){ft(()=>{if(t.length%2===0){let n=this.blacks;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.blacks=n}else{let n=this.whites;if(n.find(r=>r.join("").startsWith(t.join(""))))return;let i=n.findIndex(r=>t.join("").startsWith(r.join("")));i!==-1?n.splice(i,1,t):n.push(t),this.whites=n}})}}const ke=class ke{constructor(t,n){w(this,"_tree");w(this,"_cursor_path");w(this,"_hidden_paths");w(this,"_revealed_paths");w(this,"_failed_paths");w(this,"_solved_paths");w(this,"reveal_hidden_paths",()=>{te(()=>{this.hidden_paths.forEach(t=>{this._revealed_paths.add_path(t)}),this._hidden_paths.clear()})});w(this,"reveal_one_random",()=>{var i,r;if(!this.tree)return!1;const t=((r=(i=this.tree)==null?void 0:i._traverse_path(this.cursor_path))==null?void 0:r.children)??[this.tree.root],n=er(t);return n?(te(()=>{this._hidden_paths.remove_path(n.data.path),n.children.forEach(o=>this._hidden_paths.add_path(o.data.path)),this.cursor_path=n.data.path}),!0):!1});w(this,"try_next_uci_fail",t=>{var o,s,l;if(!this.tree)return!1;const n=((o=this.tree)==null?void 0:o._traverse_path(this.cursor_path))??this.tree.root,i=((l=(s=this.tree)==null?void 0:s._traverse_path(this.cursor_path))==null?void 0:l.children)??[this.tree.root],r=i.find(c=>c.data.uci===t)??i.find(c=>tr(c.data)===t);if(r){if(this.failed_paths_expanded.find(a=>a.join("")===r.data.path.join(""))){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return te(()=>{this._hidden_paths.remove_path(r.data.path),r.children.forEach(a=>this._hidden_paths.add_path(a.data.path)),this._solved_paths.add_path(r.data.path),this.cursor_path=r.data.path}),!0}else{if(this.is_revealed){setTimeout(()=>{this.cursor_path=this.cursor_path},100);return}return this.add_uci(t),this._failed_paths.add_path([...n.data.path,t]),setTimeout(()=>{this.on_wheel(-1)},100),!1}});w(this,"on_wheel",t=>{var i;let n=this.cursor_path;if(t<0)n.length>0&&this.try_set_cursor_path(n.slice(0,-1));else{let r=this.tree;if(r){let o;n.length===0?o=[r.root]:o=(i=r._traverse_path(n))==null?void 0:i.children;let s=o==null?void 0:o.map(l=>l.data.path).find(l=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>l.join("").startsWith(a.join(""))))});s&&this.try_set_cursor_path(s)}}});this.initial_fen=t,this._cursor_path=q([],{equals:!1}),this._tree=q(n),this._hidden_paths=new ce,this._revealed_paths=new ce,this._failed_paths=new ce,this._solved_paths=new ce}get hidden_paths(){return this._hidden_paths.paths}get revealed_paths(){return this._revealed_paths.paths}get failed_paths(){return this._failed_paths.paths}get solved_paths(){return this._solved_paths}get failed_paths_expanded(){return this._failed_paths.expand_paths}get solved_paths_expanded(){return this._solved_paths.expand_paths}get revealed_paths_expanded(){return this._revealed_paths.expand_paths}get initial_color(){var t;return(t=this.tree)==null?void 0:t.initial_color}get cursor_path(){return this._cursor_path[0]()}get tree(){return this._tree[0]()}set cursor_path(t){this._cursor_path[1](t)}set tree(t){this._tree[1](t)}get fen_last_move(){let t=this.tree;if(t){let n=t.get_at(this.cursor_path);if(!n)return;let i=n.after_fen,r=n.uci;return[i,r]}}try_set_cursor_path(t){return this.hidden_paths.find(i=>t.join("").startsWith(i.join("")))?!1:(this.cursor_path=t,!0)}get is_revealed(){return this.hidden_paths.length===0}add_uci(t){let n=this.tree,i=this.cursor_path;return n?n.append_uci(t,i):n=mn.make(this.initial_fen,[t]),i=[...i,t],te(()=>{this.tree=n,this.cursor_path=i}),i}drop_failed_paths(){}get is_next_hidden_cursor_path(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,!!(r!=null&&r.map(o=>o.data.path).find(o=>{var s;return(s=this.hidden_paths)==null?void 0:s.some(l=>o.join("").startsWith(l.join("")))}))}}get can_navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;return t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children,(r==null?void 0:r.map(s=>s.data.path).find(s=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>s.join("").startsWith(c.join(""))))}))!==void 0}return!1}get can_navigate_prev(){return this.cursor_path.length>0}navigate_last(){var i,r;let t=this.cursor_path,n=this.tree;if(n){let o;t.length===0?o=[n.root]:o=(i=n._traverse_path(t))==null?void 0:i.children;let s=o==null?void 0:o.map(l=>l.data.path).find(l=>{var c;return!((c=this.hidden_paths)!=null&&c.some(a=>l.join("").startsWith(a.join(""))))});if(s){let l=n._traverse_path(s);for(;l.children.length>0&&!((r=this.hidden_paths)!=null&&r.some(c=>l.children[0].data.path.join("").startsWith(c.join(""))));)l=l.children[0];s=l.data.path,this.try_set_cursor_path(s)}}}navigate_next(){var i;let t=this.cursor_path,n=this.tree;if(n){let r;t.length===0?r=[n.root]:r=(i=n._traverse_path(t))==null?void 0:i.children;let o=r==null?void 0:r.map(s=>s.data.path).find(s=>{var l;return!((l=this.hidden_paths)!=null&&l.some(c=>s.join("").startsWith(c.join(""))))});o&&this.try_set_cursor_path(o)}}navigate_prev(){this.try_set_cursor_path(this.cursor_path.slice(0,-1))}navigate_first(){this.try_set_cursor_path(this.cursor_path.slice(0,1))}};w(ke,"make",(t,n=(t==null?void 0:t.root.data.before_fen)||Fe)=>new ke(n,t));let Le=ke;const Qi=e=>{let t;return F(()=>{let n=e.lala.cursor_path,i=t.parentElement;if(!i)return;const r=t.querySelector(".on_path_end");if(!r){i.scrollTop=n.length>0?99999:0;return}let o=r.offsetTop-i.offsetHeight/2+r.offsetHeight;i.scrollTo({behavior:"smooth",top:o})}),(()=>{var n=Ui();return Be(i=>t=i,n),P(n,C(ne,{get when(){return e.lala.tree},get fallback(){return[]},children:i=>C(He,{on_set_path:r=>e.lala.try_set_cursor_path(r),get cursor_path(){return e.lala.cursor_path},get hidden_paths(){return e.lala.hidden_paths},get revealed_paths(){return e.lala.revealed_paths},get solved_paths(){return e.lala.solved_paths_expanded},get failed_paths(){return e.lala.failed_paths_expanded},get lines(){return[i().root]}})})),n})()},He=e=>C(Te,{get each(){return e.lines},children:t=>[C(Ji,Ae({get data(){return t.data}},e)),C(At,{get children(){return[C(fe,{get when(){return t.children.length===1},get children(){return C(He,Ae(e,{get lines(){return t.children}}))}}),C(fe,{get when(){return t.children.length>1},get children(){var n=Zi();return P(n,C(Te,{get each(){return t.children},children:i=>(()=>{var r=Gi();return P(r,C(He,Ae(e,{lines:[i],show_index:!0}))),r})()})),n}})]}})]}),Ji=e=>{let t=`${Math.ceil(e.data.ply/2)}.`;e.data.ply%2===0&&(t+="..");let n=b(()=>e.cursor_path.join("").startsWith(e.data.path.join(""))),i=b(()=>e.cursor_path.join("")===e.data.path.join("")),r=e.data.path.join(""),o=b(()=>e.hidden_paths.find(f=>f.join("")===r)),s=b(()=>e.hidden_paths.find(f=>r.startsWith(f.join("")))),l=b(()=>e.revealed_paths.find(f=>f.join("")===r)),c=b(()=>e.revealed_paths.find(f=>r.startsWith(f.join("")))),a=b(()=>e.failed_paths.find(f=>f.join("")===r)),u=b(()=>e.solved_paths.find(f=>f.join("")===r)),d=b(()=>["move",i()?"on_path_end":n()?"on_path":"",o()?"on_hidden_path_start":s()?"on_hidden_path":"",l()?"on_revealed_path_start":c()?"on_revealed_path":"",a()?"on_failed_path":"",u()?"on_solved_path":"",e.collapsed?"collapsed":""].join(" "));return(()=>{var f=Xi();return f.$$click=()=>e.on_set_path(e.data.path),P(f,C(ne,{get when(){return e.show_index||e.data.ply&1},get children(){var _=Yi();return P(_,t),_}}),null),P(f,()=>e.data.san,null),he(()=>J(f,d())),f})()};function er(e){let t=e.length*(e.length+1)/2,n=Math.floor(Math.random()*t)+1,i=0;for(let r=0;r<e.length;r++)if(i+=e.length-r,n<=i)return e[r]}const tr=e=>{let t=e.uci.slice(0,2),n=e.uci[3];if(e.san==="O-O")return t+"g"+n;if(e.san==="O-O-O")return t+"c"+n};zt(["click"]);const Ce=class Ce{constructor(){w(this,"_add_uci");w(this,"_promotion");w(this,"_position");w(this,"m_fen");w(this,"m_dests");w(this,"m_color");w(this,"_last_move");w(this,"_on_wheel");w(this,"set_on_wheel",t=>{this._on_wheel[1](t)});w(this,"on_set_fen_uci",(t,n)=>{te(()=>{this.add_uci=void 0,this.last_move=n,this.position=pt.fromSetup(_t(t).unwrap()).unwrap()})});w(this,"reset_move_after",()=>{this.position=this.position});w(this,"on_move_after",(t,n)=>{let i=this.position.board.get(wn(t)),r=t+n;i.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(r+="q"),this.position.play(yn(r)),te(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=n),this.add_uci=r})});this._on_wheel=q(void 0,{equals:!1}),this._last_move=q(void 0,{equals:!1}),this._add_uci=q(void 0,{equals:!1}),this._promotion=q(void 0,{equals:!1}),this._position=q(pt.fromSetup(_t(Fe).unwrap()).unwrap(),{equals:!1}),this.m_dests=b(()=>Pn(this.position)),this.m_fen=b(()=>bn(this.position.toSetup())),this.m_color=b(()=>this.position.turn)}get position(){return this._position[0]()}set position(t){this._position[1](t)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(t){this._promotion[1](t)}get add_uci(){return this._add_uci[0]()}set add_uci(t){this._add_uci[1](t)}get last_move(){return this._last_move[0]()}set last_move(t){this._last_move[1](t)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let t=this.fen,n=this.last_move;return[t,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};w(Ce,"init",()=>new Ce);let Ie=Ce;var nr=x("<span>Loading..."),ir=x("<span>Failed loading PGNs.."),rr=x("<h3>Puzzle Completed!"),or=x("<h4>"),sr=x("<span class=success>solved +1"),lr=x("<span class=success>failed +1"),ar=x("<span class=success>skipped +1"),cr=x("<span class=link>Continue with next puzzle."),dr=x("<div class=home><div class=board-wrap></div><div class=replay-wrap><div class=replay><div class=replay-header><span>#</span><span>All Puzzles</span><span>lichess</span></div><div class=replay-v></div><div class=replay-jump><button data-icon=></button><button data-icon=></button><button data-icon=></button><button data-icon=></button></div><div class=replay-tools></div></div></div><div class=side><div class=side-header><span class=title>Set: </span><span class=run>Run: #</span><span class=time>Total Time: </span></div><div class=side-tools><div class=jump-toggle><input type=checkbox id=jump-next><label for=jump-next>Jump to next puzzle immediately</label></div><div class=show-dropdown><label for=show-only>Show Only</label><select id=show-only><option value=failed>Solved Puzzles</option><option value=failed>Unseen Puzzles</option><option value=failed>Failed Puzzles</option><option value=failed>Skipped Puzzles</option></select></div></div><div class=side-list>"),ur=x("<div class=info><h3><span class=turn></span> to play</h3><span>Find the best move for </span><h4>"),hr=x("<span>View Solution"),fr=x("<span>");const mr=()=>{let e=gt.active_user??gt.anonymous_user;const[t]=vt(()=>qt.get_or_create_active_run_for_user(e)),n=b(()=>{var r;return(r=t())==null?void 0:r.set_id}),[i]=vt(n,r=>Sn.get_study_by_id(r));return C(ne,{get when(){return i.loading},get fallback(){return C(ne,{get when(){return i.error},get fallback(){return C(ne,{get when(){return b(()=>!!i())()&&!!t()},get children(){return C(pr,{get pgn(){return i()},get run(){return t()}})}})},get children(){return ir()}})},get children(){return nr()}})},pr=e=>{const[t,n]=q(e.run,{equals:!1}),i=()=>e.pgn;let r;const[o,s]=q(0),l=b(()=>[...Array(e.pgn.chapters.length).keys()]),c=b(()=>t().solved),a=b(()=>t().failed),u=b(()=>t().skipped),d=b(()=>{let p=[...c(),...a(),...u()];return l().filter(y=>!p.includes(y))}),f=kn(),[_,v]=q(!1),[h,O]=q(!1),[E,j]=q(!1),[H,se]=q(d()[0]),K=b(()=>e.pgn.chapters[H()]),z=new Ie,g=b(ae(K,p=>{let y=Le.make(p.pgn.tree);return y.tree.root.children.map(M=>M.data.path).forEach(M=>y._hidden_paths.add_path(M)),z.on_set_fen_uci(y.initial_fen),j(!1),s(0),setTimeout(()=>{y.cursor_path=y.tree.root.data.path,j(!0),clearInterval(r),r=setInterval(()=>s(o()+1e3),1e3)},600),y}));F(ae(()=>z.add_uci,p=>{if(!p)return;g().try_next_uci_fail(p)&&(O(!0),setTimeout(()=>{g().reveal_one_random(),O(!1)},600))})),F(ae(()=>g().fen_last_move,p=>{if(p){let[y,M]=p;z.on_set_fen_uci(y,M)}else z.on_set_fen_uci(g().initial_fen)})),F(ae(()=>{var p;return(p=g().tree)==null?void 0:p.get_at(g().cursor_path)},p=>{p&&f.move(p)}));const k=()=>{se(H()+1)},Q=()=>{if(!E())return!1;g().reveal_hidden_paths()};F(()=>{g().is_revealed&&_()&&setTimeout(()=>{k()},600)});let A=b(()=>{if(g().is_revealed){let p=g().failed_paths_expanded.length>0,y=g().revealed_paths_expanded.length>0;return p?"failed":y?"revealed":"solved"}return"thinking"});F(ae(A,p=>{let y=H(),M=t();p==="failed"?M.failed.push(y):p==="revealed"?M.skipped.push(y):p==="solved"&&M.solved.push(y),M.elapsed_ms+=o(),qt._save_run(M),clearInterval(r),n(M)})),F(ae(()=>z.on_wheel,p=>{h()||p&&g().on_wheel(p)}));const N=p=>{const y=p.target;y.tagName!=="PIECE"&&y.tagName!=="SQUARE"&&y.tagName!=="CG-BOARD"||(p.preventDefault(),z.set_on_wheel(Math.sign(p.deltaY)))};let Z;jt(()=>{Z.addEventListener("wheel",N,{passive:!1})}),Cn(()=>{Z.removeEventListener("wheel",N)});const it=b(()=>mt(g().initial_color)),dn=p=>{let y=b(()=>u().includes(p)),M=b(()=>c().includes(p)),Se=b(()=>a().includes(p));return b(()=>p===H())()?"current":y()?"skipped":M()?"solved":Se()?"failed":""};return(()=>{var p=dr(),y=p.firstChild,M=y.nextSibling,Se=M.firstChild,Pe=Se.firstChild,rt=Pe.firstChild;rt.firstChild;var ot=Pe.nextSibling,st=ot.nextSibling,$e=st.firstChild,xe=$e.nextSibling,Me=xe.nextSibling,lt=Me.nextSibling,un=st.nextSibling,hn=M.nextSibling,at=hn.firstChild,je=at.firstChild;je.firstChild;var ze=je.nextSibling;ze.firstChild;var ct=ze.nextSibling;ct.firstChild;var dt=at.nextSibling,fn=dt.firstChild,ut=fn.firstChild,pn=dt.nextSibling;return Be(m=>Z=m,p),P(y,C(Vi,{get orientation(){return mt(g().initial_color??"white")},get movable(){return b(()=>!h()&&!g().is_revealed)()&&g().is_next_hidden_cursor_path},get doPromotion(){return z.promotion},get onMoveAfter(){return z.on_move_after},get fen_uci(){return z.fen_uci},get color(){return z.turnColor},get dests(){return z.dests}})),P(rt,()=>H()+1,null),P(ot,C(Qi,{get lala(){return g()}})),$e.$$click=()=>g().navigate_first(),xe.$$click=()=>g().navigate_prev(),Me.$$click=()=>g().navigate_next(),lt.$$click=()=>g().navigate_last(),P(un,C(ne,{get when(){return g().is_revealed},get fallback(){return[(()=>{var m=ur(),I=m.firstChild,ge=I.firstChild,le=I.nextSibling;le.firstChild;var ve=le.nextSibling;return P(ge,it),P(le,it,null),P(ve,()=>qe(o(),!1)),m})(),(()=>{var m=hr();return m.$$click=()=>Q(),he(()=>J(m,"solution"+(E()?"":" fade-out"))),m})()]},get children(){return[rr(),(()=>{var m=or();return P(m,()=>qe(o(),!1)),m})(),C(At,{get children(){return[C(fe,{get when(){return A()==="solved"},get children(){return sr()}}),C(fe,{get when(){return A()==="failed"},get children(){return lr()}}),C(fe,{get when(){return A()==="revealed"},get children(){return ar()}})]}}),C(ne,{get when(){return!_()},get children(){var m=cr();return m.$$click=()=>k(),m}})]}})),P(je,()=>i().name,null),P(ze,()=>t().no,null),P(ct,()=>qe(t().elapsed_ms),null),ut.addEventListener("change",m=>v(m.currentTarget.checked)),P(pn,C(Te,{get each(){return l()},children:m=>(()=>{var I=fr();return I.$$click=()=>se(m),P(I,m+1),he(()=>J(I,dn(m))),I})()})),he(m=>{var I="fbt first"+(!h()&&g().can_navigate_prev?"":" disabled"),ge="fbt prev"+(!h()&&g().can_navigate_prev?"":" disabled"),le="fbt next"+(!h()&&g().can_navigate_next?"":" disabled"),ve="fbt last"+(!h()&&g().can_navigate_next?"":" disabled");return I!==m.e&&J($e,m.e=I),ge!==m.t&&J(xe,m.t=ge),le!==m.a&&J(Me,m.a=le),ve!==m.o&&J(lt,m.o=ve),m},{e:void 0,t:void 0,a:void 0,o:void 0}),he(()=>ut.checked=_()),p})()};zt(["click"]);export{mr as default};
